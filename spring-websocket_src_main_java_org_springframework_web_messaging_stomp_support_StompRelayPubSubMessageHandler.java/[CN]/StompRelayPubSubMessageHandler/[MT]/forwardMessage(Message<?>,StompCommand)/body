{
  StompHeaders stompHeaders=StompHeaders.fromMessageHeaders(message.getHeaders());
  String sessionId=stompHeaders.getSessionId();
  RelaySession session=StompRelayPubSubMessageHandler.this.relaySessions.get(sessionId);
  Assert.notNull(session,"RelaySession not found");
  try {
    stompHeaders.setStompCommandIfNotSet(StompCommand.SEND);
    MediaType contentType=stompHeaders.getContentType();
    byte[] payload=this.payloadConverter.convertToPayload(message.getPayload(),contentType);
    Message<byte[]> byteMessage=new GenericMessage<byte[]>(payload,stompHeaders.toMessageHeaders());
    if (logger.isTraceEnabled()) {
      logger.trace("Forwarding STOMP " + stompHeaders.getStompCommand() + " message");
    }
    byte[] bytes=this.stompMessageConverter.fromMessage(byteMessage);
    session.getOutputStream().write(bytes);
    session.getOutputStream().flush();
  }
 catch (  Exception ex) {
    logger.error("Couldn't forward message " + message,ex);
    clearRelaySession(sessionId);
  }
}
