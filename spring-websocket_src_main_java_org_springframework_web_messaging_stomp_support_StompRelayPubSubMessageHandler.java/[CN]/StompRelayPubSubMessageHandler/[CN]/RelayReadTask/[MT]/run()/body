{
  try {
    ByteArrayOutputStream out=new ByteArrayOutputStream();
    while (!session.getSocket().isClosed()) {
      int b=session.getInputStream().read();
      if (b == -1) {
        break;
      }
 else       if (b == 0x00) {
        byte[] bytes=out.toByteArray();
        Message<byte[]> message=stompMessageConverter.toMessage(bytes,sessionId);
        getClientChannel().send(message);
        out.reset();
      }
 else {
        out.write(b);
      }
    }
    logger.debug("Socket closed, STOMP session=" + sessionId);
    sendErrorMessage("Lost connection");
  }
 catch (  IOException e) {
    logger.error("Socket error: " + e.getMessage());
    clearRelaySession(sessionId);
    sendErrorMessage("Lost connection");
  }
}
