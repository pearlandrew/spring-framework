{
  try {
    headers.setStompCommandIfNotSet(StompCommand.SEND);
    MediaType contentType=headers.getContentType();
    byte[] payload=payloadConverter.convertToPayload(message.getPayload(),contentType);
    Message<byte[]> byteMessage=MessageBuilder.fromPayloadAndHeaders(payload,headers.toMessageHeaders()).build();
    if (logger.isTraceEnabled()) {
      logger.trace("Forwarding message " + byteMessage);
    }
    byte[] bytesToWrite=stompMessageConverter.fromMessage(byteMessage);
    connection.send(new String(bytesToWrite,Charset.forName("UTF-8")));
  }
 catch (  Throwable ex) {
    logger.error("Failed to forward message " + message,ex);
    connection.close();
    sendError(this.sessionId,"Failed to forward message " + message + ": "+ ex.getMessage());
    return false;
  }
  return true;
}
