{
  List<Match> matches=new ArrayList<Match>();
  List<T> directPathMatches=this.urlMap.get(lookupPath);
  if (directPathMatches != null) {
    addMatchingMappings(directPathMatches,matches,request);
  }
  if (matches.isEmpty()) {
    addMatchingMappings(this.handlerMethods.keySet(),matches,request);
  }
  if (!matches.isEmpty()) {
    Comparator<Match> comparator=new MatchComparator(getMappingComparator(request));
    Collections.sort(matches,comparator);
    if (logger.isTraceEnabled()) {
      logger.trace("Found " + matches.size() + " matching mapping(s) for ["+ lookupPath+ "] : "+ matches);
    }
    Match bestMatch=matches.get(0);
    if (matches.size() > 1) {
      if (CorsUtils.isPreFlightRequest(request)) {
        return PREFLIGHT_MULTI_MATCH_HANDLER_METHOD;
      }
      Match secondBestMatch=matches.get(1);
      if (comparator.compare(bestMatch,secondBestMatch) == 0) {
        Method m1=bestMatch.handlerMethod.getMethod();
        Method m2=secondBestMatch.handlerMethod.getMethod();
        throw new IllegalStateException("Ambiguous handler methods mapped for HTTP path '" + request.getRequestURL() + "': {"+ m1+ ", "+ m2+ "}");
      }
    }
    handleMatch(bestMatch.mapping,lookupPath,request);
    return bestMatch.handlerMethod;
  }
 else {
    return handleNoMatch(handlerMethods.keySet(),lookupPath,request);
  }
}
