{
  Map<String,Object> model=new HashMap<String,Object>();
  model.put("foo","bar");
  final String templateName="test.vm";
  WebApplicationContext wac=createMock(WebApplicationContext.class);
  MockServletContext sc=new MockServletContext();
  sc.setAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE,wac);
  final Template expectedTemplate=new Template();
  VelocityConfig vc=new VelocityConfig(){
    public VelocityEngine getVelocityEngine(){
      return new TestVelocityEngine(templateName,expectedTemplate);
    }
  }
;
  wac.getBeansOfType(VelocityConfig.class,true,false);
  Map<String,Object> configurers=new HashMap<String,Object>();
  configurers.put("velocityConfigurer",vc);
  expectLastCall().andReturn(configurers);
  wac.getParentBeanFactory();
  expectLastCall().andReturn(null);
  wac.getServletContext();
  expectLastCall().andReturn(sc).times(3);
  wac.getBean("requestDataValueProcessor",RequestDataValueProcessor.class);
  expectLastCall().andReturn(null);
  replay(wac);
  HttpServletRequest request=new MockHttpServletRequest();
  final HttpServletResponse expectedResponse=new MockHttpServletResponse();
  VelocityView vv=new VelocityView(){
    protected void mergeTemplate(    Template template,    Context context,    HttpServletResponse response) throws Exception {
      assertTrue(template == expectedTemplate);
      assertTrue(context.getKeys().length >= 1);
      assertTrue(context.get("foo").equals("bar"));
      assertTrue(response == expectedResponse);
      if (mergeTemplateFailureException != null) {
        throw mergeTemplateFailureException;
      }
    }
  }
;
  vv.setUrl(templateName);
  vv.setApplicationContext(wac);
  try {
    vv.render(model,request,expectedResponse);
    if (mergeTemplateFailureException != null) {
      fail();
    }
  }
 catch (  Exception ex) {
    assertNotNull(mergeTemplateFailureException);
    assertEquals(ex,mergeTemplateFailureException);
  }
  verify(wac);
}
