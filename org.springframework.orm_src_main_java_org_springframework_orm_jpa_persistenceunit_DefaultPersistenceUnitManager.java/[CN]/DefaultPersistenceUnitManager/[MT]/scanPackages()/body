{
  SpringPersistenceUnitInfo scannedUnit=new SpringPersistenceUnitInfo();
  try {
    scannedUnit.setPersistenceUnitName(this.defaultPersistenceUnitName);
    scannedUnit.excludeUnlistedClasses();
    for (    String pkg : this.packagesToScan) {
      String pattern=ResourcePatternResolver.CLASSPATH_ALL_URL_PREFIX + ClassUtils.convertClassNameToResourcePath(pkg) + RESOURCE_PATTERN;
      Resource[] resources=this.resourcePatternResolver.getResources(pattern);
      MetadataReaderFactory readerFactory=new CachingMetadataReaderFactory(this.resourcePatternResolver);
      for (      Resource resource : resources) {
        if (resource.isReadable()) {
          MetadataReader reader=readerFactory.getMetadataReader(resource);
          String className=reader.getClassMetadata().getClassName();
          if (matchesFilter(reader,readerFactory)) {
            scannedUnit.addManagedClassName(className);
          }
        }
      }
    }
    return scannedUnit;
  }
 catch (  IOException ex) {
    throw new PersistenceException("Failed to scan classpath for unlisted classes",ex);
  }
}
