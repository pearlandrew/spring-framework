{
  this.session.handleFrame(SockJsFrame.openFrame().getContent());
  doThrow(new IllegalStateException("Fake error")).when(this.handler).handleMessage(this.session,new TextMessage("foo"));
  doThrow(new IllegalStateException("Fake error")).when(this.handler).handleMessage(this.session,new TextMessage("bar"));
  this.session.handleFrame(SockJsFrame.messageFrame(CODEC,"foo","bar").getContent());
  assertThat(this.session.isOpen(),equalTo(true));
  verify(this.handler).afterConnectionEstablished(this.session);
  verify(this.handler).handleMessage(this.session,new TextMessage("foo"));
  verify(this.handler).handleMessage(this.session,new TextMessage("bar"));
  verifyNoMoreInteractions(this.handler);
}
