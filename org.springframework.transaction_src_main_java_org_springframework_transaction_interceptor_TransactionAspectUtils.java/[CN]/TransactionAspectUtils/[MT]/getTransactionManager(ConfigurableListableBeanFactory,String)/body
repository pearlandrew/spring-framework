{
  Map<String,PlatformTransactionManager> tms=BeanFactoryUtils.beansOfTypeIncludingAncestors(bf,PlatformTransactionManager.class);
  PlatformTransactionManager chosen=null;
  for (  String beanName : tms.keySet()) {
    if (isQualifierMatch(qualifier,beanName,bf)) {
      if (chosen != null) {
        throw new IllegalStateException("No unique PlatformTransactionManager bean found " + "for qualifier '" + qualifier + "'");
      }
      chosen=tms.get(beanName);
    }
  }
  if (chosen != null) {
    return chosen;
  }
 else {
    throw new IllegalStateException("No matching PlatformTransactionManager bean found for qualifier '" + qualifier + "' - neither qualifier match nor bean name match!");
  }
}
