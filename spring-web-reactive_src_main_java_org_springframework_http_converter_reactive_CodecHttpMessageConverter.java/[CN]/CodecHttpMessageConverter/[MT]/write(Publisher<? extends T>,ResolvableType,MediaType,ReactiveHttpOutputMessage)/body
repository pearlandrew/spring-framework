{
  if (this.encoder == null) {
    return Mono.error(new IllegalStateException("No decoder set"));
  }
  HttpHeaders headers=outputMessage.getHeaders();
  if (headers.getContentType() == null) {
    MediaType contentTypeToUse=contentType;
    if (contentType == null || contentType.isWildcardType() || contentType.isWildcardSubtype()) {
      contentTypeToUse=getDefaultContentType(type);
    }
    headers.setContentType(contentTypeToUse);
  }
  DataBufferFactory dataBufferFactory=outputMessage.bufferFactory();
  Flux<DataBuffer> body=this.encoder.encode(inputStream,dataBufferFactory,type,contentType);
  return outputMessage.writeWith(body);
}
