{
  resource=transformerChain.transform(request,resource);
  String filename=resource.getFilename();
  if (!this.fileExtension.equals(StringUtils.getFilenameExtension(filename))) {
    return resource;
  }
  byte[] bytes=FileCopyUtils.copyToByteArray(resource.getInputStream());
  String content=new String(bytes,DEFAULT_CHARSET);
  if (!content.startsWith(MANIFEST_HEADER)) {
    if (logger.isTraceEnabled()) {
      logger.trace("AppCache manifest does not start with 'CACHE MANIFEST', skipping: " + resource);
    }
    return resource;
  }
  if (logger.isTraceEnabled()) {
    logger.trace("Transforming resource: " + resource);
  }
  StringWriter contentWriter=new StringWriter();
  HashBuilder hashBuilder=new HashBuilder(content.length());
  Scanner scanner=new Scanner(content);
  SectionTransformer currentTransformer=this.sectionTransformers.get(MANIFEST_HEADER);
  while (scanner.hasNextLine()) {
    String line=scanner.nextLine();
    if (this.sectionTransformers.containsKey(line.trim())) {
      currentTransformer=this.sectionTransformers.get(line.trim());
      contentWriter.write(line + "\n");
      hashBuilder.appendString(line);
    }
 else {
      contentWriter.write(currentTransformer.transform(line,hashBuilder,resource,transformerChain,request) + "\n");
    }
  }
  String hash=hashBuilder.build();
  contentWriter.write("\n" + "# Hash: " + hash);
  if (logger.isTraceEnabled()) {
    logger.trace("AppCache file: [" + resource.getFilename() + "] Hash: ["+ hash+ "]");
  }
  return new TransformedResource(resource,contentWriter.toString().getBytes(DEFAULT_CHARSET));
}
