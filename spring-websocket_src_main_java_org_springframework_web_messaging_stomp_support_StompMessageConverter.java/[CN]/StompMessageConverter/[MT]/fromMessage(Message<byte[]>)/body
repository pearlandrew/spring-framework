{
  ByteArrayOutputStream out=new ByteArrayOutputStream();
  MessageHeaders messageHeaders=message.getHeaders();
  StompHeaders stompHeaders=StompHeaders.fromMessageHeaders(messageHeaders);
  try {
    out.write(stompHeaders.getStompCommand().toString().getBytes("UTF-8"));
    out.write(LF);
    for (    Entry<String,List<String>> entry : stompHeaders.toStompMessageHeaders().entrySet()) {
      String key=entry.getKey();
      key=replaceAllOutbound(key);
      for (      String value : entry.getValue()) {
        out.write(key.getBytes("UTF-8"));
        out.write(COLON);
        value=replaceAllOutbound(value);
        out.write(value.getBytes("UTF-8"));
        out.write(LF);
      }
    }
    out.write(LF);
    out.write(message.getPayload());
    out.write(0);
    return out.toByteArray();
  }
 catch (  IOException e) {
    throw new StompConversionException("Failed to serialize " + message,e);
  }
}
