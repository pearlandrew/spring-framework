{
  Matcher matcher=PATTERN.matcher(message);
  StringBuffer output=new StringBuffer();
  while (matcher.find()) {
    String match=matcher.group();
    if (PLACEHOLDER_METHOD_NAME.equals(match)) {
      matcher.appendReplacement(output,escape(methodInvocation.getMethod().getName()));
    }
 else     if (PLACEHOLDER_TARGET_CLASS_NAME.equals(match)) {
      String className=getClassForLogging(methodInvocation.getThis()).getName();
      matcher.appendReplacement(output,escape(className));
    }
 else     if (PLACEHOLDER_TARGET_CLASS_SHORT_NAME.equals(match)) {
      String shortName=ClassUtils.getShortName(getClassForLogging(methodInvocation.getThis()));
      matcher.appendReplacement(output,escape(shortName));
    }
 else     if (PLACEHOLDER_ARGUMENTS.equals(match)) {
      matcher.appendReplacement(output,escape(StringUtils.arrayToCommaDelimitedString(methodInvocation.getArguments())));
    }
 else     if (PLACEHOLDER_ARGUMENT_TYPES.equals(match)) {
      appendArgumentTypes(methodInvocation,matcher,output);
    }
 else     if (PLACEHOLDER_RETURN_VALUE.equals(match)) {
      appendReturnValue(methodInvocation,matcher,output,returnValue);
    }
 else     if (throwable != null && PLACEHOLDER_EXCEPTION.equals(match)) {
      matcher.appendReplacement(output,escape(throwable.toString()));
    }
 else     if (PLACEHOLDER_INVOCATION_TIME.equals(match)) {
      matcher.appendReplacement(output,Long.toString(invocationTime));
    }
 else {
      throw new IllegalArgumentException("Unknown placeholder [" + match + "]");
    }
  }
  matcher.appendTail(output);
  return output.toString();
}
