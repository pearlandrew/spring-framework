{
  Object actualKey=TransactionSynchronizationUtils.unwrapResourceIfNecessary(key);
  Assert.notNull(value,"Value must not be null");
  Map<Object,Object> map=resources.get();
  if (map == null) {
    map=new HashMap<Object,Object>();
    resources.set(map);
  }
  Object oldValue=map.put(actualKey,value);
  if (oldValue instanceof ResourceHolder && ((ResourceHolder)oldValue).isVoid()) {
    oldValue=null;
  }
  if (oldValue != null) {
    throw new IllegalStateException("Already value [" + oldValue + "] for key ["+ actualKey+ "] bound to thread ["+ Thread.currentThread().getName()+ "]");
  }
  if (logger.isTraceEnabled()) {
    logger.trace("Bound value [" + value + "] for key ["+ actualKey+ "] to thread ["+ Thread.currentThread().getName()+ "]");
  }
}
