{
  TemporaryQueue responseQueue=null;
  MessageProducer producer=null;
  MessageConsumer consumer=null;
  try {
    if (session instanceof QueueSession) {
      QueueSession queueSession=(QueueSession)session;
      responseQueue=queueSession.createTemporaryQueue();
      QueueSender sender=queueSession.createSender(queue);
      producer=sender;
      consumer=queueSession.createReceiver(responseQueue);
      requestMessage.setJMSReplyTo(responseQueue);
      sender.send(requestMessage);
    }
 else {
      responseQueue=session.createTemporaryQueue();
      producer=session.createProducer(queue);
      consumer=session.createConsumer(responseQueue);
      requestMessage.setJMSReplyTo(responseQueue);
      producer.send(requestMessage);
    }
    long timeout=getReceiveTimeout();
    return (timeout > 0 ? consumer.receive(timeout) : consumer.receive());
  }
  finally {
    JmsUtils.closeMessageConsumer(consumer);
    JmsUtils.closeMessageProducer(producer);
    if (responseQueue != null) {
      responseQueue.delete();
    }
  }
}
