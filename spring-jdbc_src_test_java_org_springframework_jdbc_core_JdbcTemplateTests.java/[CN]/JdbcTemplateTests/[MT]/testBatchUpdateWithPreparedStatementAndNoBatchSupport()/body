{
  final String sql="UPDATE NOSUCHTABLE SET DATE_DISPATCHED = SYSDATE WHERE ID = ?";
  final int[] ids=new int[]{100,200};
  final int[] rowsAffected=new int[]{1,2};
  MockControl ctrlPreparedStatement=MockControl.createControl(PreparedStatement.class);
  PreparedStatement mockPreparedStatement=(PreparedStatement)ctrlPreparedStatement.getMock();
  mockPreparedStatement.getConnection();
  ctrlPreparedStatement.setReturnValue(mockConnection);
  mockPreparedStatement.setInt(1,ids[0]);
  ctrlPreparedStatement.setVoidCallable();
  mockPreparedStatement.executeUpdate();
  ctrlPreparedStatement.setReturnValue(rowsAffected[0]);
  mockPreparedStatement.setInt(1,ids[1]);
  ctrlPreparedStatement.setVoidCallable();
  mockPreparedStatement.executeUpdate();
  ctrlPreparedStatement.setReturnValue(rowsAffected[1]);
  if (debugEnabled) {
    mockPreparedStatement.getWarnings();
    ctrlPreparedStatement.setReturnValue(null);
  }
  mockPreparedStatement.close();
  ctrlPreparedStatement.setVoidCallable();
  mockConnection.prepareStatement(sql);
  ctrlConnection.setReturnValue(mockPreparedStatement);
  ctrlPreparedStatement.replay();
  replay();
  BatchPreparedStatementSetter setter=new BatchPreparedStatementSetter(){
    @Override public void setValues(    PreparedStatement ps,    int i) throws SQLException {
      ps.setInt(1,ids[i]);
    }
    @Override public int getBatchSize(){
      return ids.length;
    }
  }
;
  JdbcTemplate template=new JdbcTemplate(mockDataSource);
  int[] actualRowsAffected=template.batchUpdate(sql,setter);
  assertTrue("executed 2 updates",actualRowsAffected.length == 2);
  assertEquals(rowsAffected[0],actualRowsAffected[0]);
  assertEquals(rowsAffected[1],actualRowsAffected[1]);
  ctrlPreparedStatement.verify();
}
