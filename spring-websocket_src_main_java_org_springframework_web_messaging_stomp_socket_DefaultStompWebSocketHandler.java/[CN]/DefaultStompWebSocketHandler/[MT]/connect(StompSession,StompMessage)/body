{
  StompHeaders headers=new StompHeaders();
  Set<String> acceptVersions=stompMessage.getHeaders().getAcceptVersion();
  if (acceptVersions.contains("1.2")) {
    headers.setVersion("1.2");
  }
 else   if (acceptVersions.contains("1.1")) {
    headers.setVersion("1.1");
  }
 else   if (acceptVersions.isEmpty()) {
  }
 else {
    throw new StompException("Unsupported version '" + acceptVersions + "'");
  }
  headers.setHeartbeat(0,0);
  headers.setId(session.getId());
  session.sendMessage(new StompMessage(StompCommand.CONNECTED,headers));
  String replyToKey="relay-message" + session.getId();
  Registration<?> registration=this.reactor.on(Fn.$(replyToKey),new Consumer<Event<StompMessage>>(){
    @Override public void accept(    Event<StompMessage> event){
      try {
        StompMessage message=event.getData();
        if (StompCommand.CONNECTED.equals(message.getCommand())) {
          return;
        }
        if (logger.isTraceEnabled()) {
          logger.trace("Relaying back to client: " + message);
        }
        session.sendMessage(message);
      }
 catch (      Throwable t) {
        handleError(session,t);
      }
    }
  }
);
  addRegistration(session.getId(),registration);
  this.reactor.notify(StompCommand.CONNECT,Event.wrap(stompMessage,replyToKey));
}
