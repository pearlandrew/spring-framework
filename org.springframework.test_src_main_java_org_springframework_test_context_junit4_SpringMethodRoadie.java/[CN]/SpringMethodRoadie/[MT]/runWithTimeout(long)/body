{
  runWithRepetitions(new Runnable(){
    public void run(){
      ExecutorService service=Executors.newSingleThreadExecutor();
      Future result=service.submit(new RunBeforesThenTestThenAfters());
      service.shutdown();
      try {
        boolean terminated=service.awaitTermination(timeout,TimeUnit.MILLISECONDS);
        if (!terminated) {
          service.shutdownNow();
        }
        result.get(0,TimeUnit.MILLISECONDS);
      }
 catch (      TimeoutException ex) {
        String message="Test timed out after " + timeout + " milliseconds";
        addFailure(new TimeoutException(message));
        throw new CancellationException(message);
      }
catch (      ExecutionException ex) {
        addFailure(ex.getCause());
      }
catch (      Exception ex) {
        addFailure(ex);
      }
    }
  }
);
}
