{
  TestPrincipal user=new TestPrincipal("joe");
  UpgradeRequest request=Mockito.mock(UpgradeRequest.class);
  when(request.getUserPrincipal()).thenReturn(user);
  UpgradeResponse response=Mockito.mock(UpgradeResponse.class);
  when(response.getAcceptedSubProtocol()).thenReturn(null);
  Session nativeSession=Mockito.mock(Session.class);
  when(nativeSession.getUpgradeRequest()).thenReturn(request);
  when(nativeSession.getUpgradeResponse()).thenReturn(response);
  JettyWebSocketSession session=new JettyWebSocketSession(attributes);
  session.initializeNativeSession(nativeSession);
  reset(nativeSession);
  assertSame(user,session.getPrincipal());
  verifyNoMoreInteractions(nativeSession);
}
