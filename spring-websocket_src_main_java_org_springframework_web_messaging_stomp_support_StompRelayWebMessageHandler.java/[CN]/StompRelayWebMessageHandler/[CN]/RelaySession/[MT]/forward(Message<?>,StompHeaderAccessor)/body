{
  if (!this.isConnected) {
synchronized (this.monitor) {
      if (!this.isConnected) {
        this.messageQueue.add(message);
        if (logger.isTraceEnabled()) {
          logger.trace("Queued message " + message + ", queue size="+ this.messageQueue.size());
        }
        return;
      }
    }
  }
  TcpConnection<String,String> connection=this.promise.get();
  if (this.messageQueue.isEmpty()) {
    forwardInternal(message,headers,connection);
  }
 else {
    this.messageQueue.add(message);
    flushMessages(connection);
  }
}
