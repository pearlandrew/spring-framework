{
  if (logger.isDebugEnabled()) {
    logger.debug("DispatcherPortlet with name '" + getPortletName() + "' received action request");
  }
  ActionRequest processedRequest=request;
  HandlerExecutionChain mappedHandler=null;
  int interceptorIndex=-1;
  try {
    processedRequest=checkMultipart(request);
    mappedHandler=getHandler(processedRequest);
    if (mappedHandler == null || mappedHandler.getHandler() == null) {
      noHandlerFound(processedRequest,response);
      return;
    }
    HandlerInterceptor[] interceptors=mappedHandler.getInterceptors();
    if (interceptors != null) {
      for (int i=0; i < interceptors.length; i++) {
        HandlerInterceptor interceptor=interceptors[i];
        if (!interceptor.preHandleAction(processedRequest,response,mappedHandler.getHandler())) {
          triggerAfterActionCompletion(mappedHandler,interceptorIndex,processedRequest,response,null);
          return;
        }
        interceptorIndex=i;
      }
    }
    HandlerAdapter ha=getHandlerAdapter(mappedHandler.getHandler());
    ha.handleAction(processedRequest,response,mappedHandler.getHandler());
    triggerAfterActionCompletion(mappedHandler,interceptorIndex,processedRequest,response,null);
  }
 catch (  Exception ex) {
    triggerAfterActionCompletion(mappedHandler,interceptorIndex,processedRequest,response,ex);
    try {
      Enumeration<String> paramNames=request.getParameterNames();
      while (paramNames.hasMoreElements()) {
        String paramName=paramNames.nextElement();
        String[] paramValues=request.getParameterValues(paramName);
        if (paramValues != null && !response.getRenderParameterMap().containsKey(paramName)) {
          response.setRenderParameter(paramName,paramValues);
        }
      }
      response.setRenderParameter(ACTION_EXCEPTION_RENDER_PARAMETER,Boolean.TRUE.toString());
      request.getPortletSession().setAttribute(ACTION_EXCEPTION_SESSION_ATTRIBUTE,ex);
      logger.debug("Caught exception during action phase - forwarding to render phase",ex);
    }
 catch (    IllegalStateException ex2) {
      throw ex;
    }
  }
catch (  Error err) {
    PortletException ex=new PortletException("Error occured during request processing: " + err.getMessage(),err);
    triggerAfterActionCompletion(mappedHandler,interceptorIndex,processedRequest,response,ex);
    throw ex;
  }
 finally {
    if (processedRequest instanceof MultipartActionRequest && processedRequest != request) {
      this.multipartResolver.cleanupMultipart((MultipartActionRequest)processedRequest);
    }
  }
}
