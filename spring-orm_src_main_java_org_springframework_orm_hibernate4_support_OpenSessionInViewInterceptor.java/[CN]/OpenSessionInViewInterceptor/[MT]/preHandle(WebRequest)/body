{
  WebAsyncManager asyncManager=AsyncWebUtils.getAsyncManager(request);
  String participateAttributeName=getParticipateAttributeName();
  if (asyncManager.hasConcurrentResult()) {
    if (asyncManager.applyAsyncThreadInitializer(participateAttributeName)) {
      return;
    }
  }
  if (TransactionSynchronizationManager.hasResource(getSessionFactory())) {
    Integer count=(Integer)request.getAttribute(participateAttributeName,WebRequest.SCOPE_REQUEST);
    int newCount=(count != null ? count + 1 : 1);
    request.setAttribute(getParticipateAttributeName(),newCount,WebRequest.SCOPE_REQUEST);
  }
 else {
    logger.debug("Opening Hibernate Session in OpenSessionInViewInterceptor");
    Session session=openSession();
    SessionHolder sessionHolder=new SessionHolder(session);
    TransactionSynchronizationManager.bindResource(getSessionFactory(),sessionHolder);
    AsyncThreadInitializer asyncThreadInitializer=createThreadInitializer(sessionHolder);
    asyncManager.registerAsyncThreadInitializer(participateAttributeName,asyncThreadInitializer);
  }
}
