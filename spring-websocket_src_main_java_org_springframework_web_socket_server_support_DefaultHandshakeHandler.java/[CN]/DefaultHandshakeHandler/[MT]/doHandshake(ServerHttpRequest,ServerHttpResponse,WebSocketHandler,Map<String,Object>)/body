{
  WebSocketHttpHeaders headers=new WebSocketHttpHeaders(request.getHeaders());
  if (logger.isDebugEnabled()) {
    logger.debug("Initiating handshake for " + request.getURI() + ", headers="+ headers);
  }
  try {
    if (!HttpMethod.GET.equals(request.getMethod())) {
      response.setStatusCode(HttpStatus.METHOD_NOT_ALLOWED);
      response.getHeaders().setAllow(Collections.singleton(HttpMethod.GET));
      logger.debug("Only HTTP GET is allowed, current method is " + request.getMethod());
      return false;
    }
    if (!"WebSocket".equalsIgnoreCase(headers.getUpgrade())) {
      handleInvalidUpgradeHeader(request,response);
      return false;
    }
    if (!headers.getConnection().contains("Upgrade") && !headers.getConnection().contains("upgrade")) {
      handleInvalidConnectHeader(request,response);
      return false;
    }
    if (!isWebSocketVersionSupported(headers)) {
      handleWebSocketVersionNotSupported(request,response);
      return false;
    }
    if (!isValidOrigin(request)) {
      response.setStatusCode(HttpStatus.FORBIDDEN);
      return false;
    }
    String wsKey=headers.getSecWebSocketKey();
    if (wsKey == null) {
      logger.debug("Missing \"Sec-WebSocket-Key\" header");
      response.setStatusCode(HttpStatus.BAD_REQUEST);
      return false;
    }
  }
 catch (  IOException ex) {
    throw new HandshakeFailureException("Response update failed during upgrade to WebSocket, uri=" + request.getURI(),ex);
  }
  String subProtocol=selectProtocol(headers.getSecWebSocketProtocol(),wsHandler);
  if (logger.isDebugEnabled()) {
    logger.debug("Selected sub-protocol: '" + subProtocol + "'");
  }
  List<WebSocketExtension> requested=headers.getSecWebSocketExtensions();
  List<WebSocketExtension> supported=this.requestUpgradeStrategy.getSupportedExtensions(request);
  List<WebSocketExtension> extensions=filterRequestedExtensions(request,requested,supported);
  if (logger.isDebugEnabled()) {
    logger.debug("Upgrading request, sub-protocol=" + subProtocol + ", extensions="+ extensions);
  }
  this.requestUpgradeStrategy.upgrade(request,response,subProtocol,extensions,wsHandler,attributes);
  return true;
}
