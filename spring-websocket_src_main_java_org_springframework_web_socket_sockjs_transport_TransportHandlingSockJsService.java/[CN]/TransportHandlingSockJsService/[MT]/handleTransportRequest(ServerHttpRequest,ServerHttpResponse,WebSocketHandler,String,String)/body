{
  TransportType transportType=TransportType.fromValue(transport);
  if (transportType == null) {
    if (logger.isErrorEnabled()) {
      logger.error("Unknown transport type: " + transportType);
    }
    response.setStatusCode(HttpStatus.NOT_FOUND);
    return;
  }
  TransportHandler transportHandler=this.handlers.get(transportType);
  if (transportHandler == null) {
    logger.error("Transport handler not found");
    response.setStatusCode(HttpStatus.NOT_FOUND);
    return;
  }
  HttpMethod supportedMethod=transportType.getHttpMethod();
  if (!supportedMethod.equals(request.getMethod())) {
    if (HttpMethod.OPTIONS.equals(request.getMethod()) && transportType.supportsCors()) {
      response.setStatusCode(HttpStatus.NO_CONTENT);
      addCorsHeaders(request,response,HttpMethod.OPTIONS,supportedMethod);
      addCacheHeaders(response);
    }
 else     if (transportType.supportsCors()) {
      sendMethodNotAllowed(response,supportedMethod,HttpMethod.OPTIONS);
    }
 else {
      sendMethodNotAllowed(response,supportedMethod);
    }
    return;
  }
  HandshakeInterceptorChain chain=new HandshakeInterceptorChain(this.interceptors,handler);
  SockJsException failure=null;
  try {
    SockJsSession session=this.sessions.get(sessionId);
    if (session == null) {
      if (transportHandler instanceof SockJsSessionFactory) {
        Map<String,Object> attributes=new HashMap<String,Object>();
        if (!chain.applyBeforeHandshake(request,response,attributes)) {
          return;
        }
        SockJsSessionFactory sessionFactory=(SockJsSessionFactory)transportHandler;
        session=createSockJsSession(sessionId,sessionFactory,handler,attributes);
      }
 else {
        response.setStatusCode(HttpStatus.NOT_FOUND);
        if (logger.isDebugEnabled()) {
          logger.debug("Session not found, sessionId=" + sessionId);
        }
        return;
      }
    }
    if (transportType.sendsNoCacheInstruction()) {
      addNoCacheHeaders(response);
    }
    if (transportType.supportsCors()) {
      addCorsHeaders(request,response);
    }
    transportHandler.handleRequest(request,response,handler,session);
    chain.applyAfterHandshake(request,response,null);
  }
 catch (  SockJsException ex) {
    failure=ex;
  }
catch (  Throwable ex) {
    failure=new SockJsException("Uncaught failure for request " + request.getURI(),sessionId,ex);
  }
 finally {
    if (failure != null) {
      chain.applyAfterHandshake(request,response,failure);
      throw failure;
    }
  }
}
