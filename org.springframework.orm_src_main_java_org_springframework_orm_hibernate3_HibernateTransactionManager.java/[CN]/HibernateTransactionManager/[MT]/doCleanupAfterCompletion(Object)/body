{
  HibernateTransactionObject txObject=(HibernateTransactionObject)transaction;
  if (txObject.isNewSessionHolder()) {
    TransactionSynchronizationManager.unbindResource(getSessionFactory());
  }
  if (getDataSource() != null) {
    TransactionSynchronizationManager.unbindResource(getDataSource());
  }
  Session session=txObject.getSessionHolder().getSession();
  if (this.prepareConnection && session.isConnected() && isSameConnectionForEntireSession(session)) {
    try {
      Connection con=session.connection();
      DataSourceUtils.resetConnectionAfterTransaction(con,txObject.getPreviousIsolationLevel());
    }
 catch (    HibernateException ex) {
      logger.debug("Could not access JDBC Connection of Hibernate Session",ex);
    }
  }
  if (txObject.isNewSession()) {
    if (logger.isDebugEnabled()) {
      logger.debug("Closing Hibernate Session [" + SessionFactoryUtils.toString(session) + "] after transaction");
    }
    SessionFactoryUtils.closeSessionOrRegisterDeferredClose(session,getSessionFactory());
  }
 else {
    if (logger.isDebugEnabled()) {
      logger.debug("Not closing pre-bound Hibernate Session [" + SessionFactoryUtils.toString(session) + "] after transaction");
    }
    if (txObject.getSessionHolder().getPreviousFlushMode() != null) {
      session.setFlushMode(txObject.getSessionHolder().getPreviousFlushMode());
    }
    if (!this.hibernateManagedSession) {
      session.disconnect();
    }
  }
  txObject.getSessionHolder().clear();
}
