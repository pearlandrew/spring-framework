{
  if (sockJsPath == null) {
    if (logger.isErrorEnabled()) {
      logger.error("Expected SockJS path. Failing request: " + request.getURI());
    }
    response.setStatusCode(HttpStatus.NOT_FOUND);
    return;
  }
  if (logger.isTraceEnabled()) {
    logger.trace(request.getMethod() + " with SockJS path [" + sockJsPath+ "]");
  }
  try {
    request.getHeaders();
  }
 catch (  InvalidMediaTypeException ex) {
    if (logger.isDebugEnabled()) {
      logger.debug("Invalid media type ignored: " + ex.getMediaType());
    }
  }
  try {
    if (sockJsPath.equals("") || sockJsPath.equals("/")) {
      response.getHeaders().setContentType(new MediaType("text","plain",Charset.forName("UTF-8")));
      response.getBody().write("Welcome to SockJS!\n".getBytes("UTF-8"));
    }
 else     if (sockJsPath.equals("/info")) {
      this.infoHandler.handle(request,response);
    }
 else     if (sockJsPath.matches("/iframe[0-9-.a-z_]*.html")) {
      this.iframeHandler.handle(request,response);
    }
 else     if (sockJsPath.equals("/websocket")) {
      if (isWebSocketEnabled()) {
        handleRawWebSocketRequest(request,response,wsHandler);
      }
    }
 else {
      String[] pathSegments=StringUtils.tokenizeToStringArray(sockJsPath.substring(1),"/");
      if (pathSegments.length != 3) {
        if (logger.isErrorEnabled()) {
          logger.error("Expected \"/{server}/{session}/{transport}\" but got \"" + sockJsPath + "\"");
        }
        response.setStatusCode(HttpStatus.NOT_FOUND);
        return;
      }
      String serverId=pathSegments[0];
      String sessionId=pathSegments[1];
      String transport=pathSegments[2];
      if (!validateRequest(serverId,sessionId,transport)) {
        response.setStatusCode(HttpStatus.NOT_FOUND);
        return;
      }
      handleTransportRequest(request,response,wsHandler,sessionId,transport);
    }
    response.close();
  }
 catch (  IOException ex) {
    throw new SockJsException("Failed to write to the response",null,ex);
  }
}
