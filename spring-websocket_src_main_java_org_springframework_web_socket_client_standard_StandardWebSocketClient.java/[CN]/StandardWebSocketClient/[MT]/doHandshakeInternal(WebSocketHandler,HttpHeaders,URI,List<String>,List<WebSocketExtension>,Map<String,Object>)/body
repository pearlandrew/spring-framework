{
  int port=getPort(uri);
  InetSocketAddress localAddress=new InetSocketAddress(getLocalHost(),port);
  InetSocketAddress remoteAddress=new InetSocketAddress(uri.getHost(),port);
  final StandardWebSocketSession session=new StandardWebSocketSession(headers,handshakeAttributes,localAddress,remoteAddress);
  final ClientEndpointConfig.Builder configBuidler=ClientEndpointConfig.Builder.create();
  configBuidler.configurator(new StandardWebSocketClientConfigurator(headers));
  configBuidler.preferredSubprotocols(protocols);
  configBuidler.extensions(adaptExtensions(extensions));
  final Endpoint endpoint=new StandardWebSocketHandlerAdapter(webSocketHandler,session);
  Callable<WebSocketSession> connectTask=new Callable<WebSocketSession>(){
    @Override public WebSocketSession call() throws Exception {
      webSocketContainer.connectToServer(endpoint,configBuidler.build(),uri);
      return session;
    }
  }
;
  if (this.taskExecutor != null) {
    return this.taskExecutor.submitListenable(connectTask);
  }
 else {
    ListenableFutureTask<WebSocketSession> task=new ListenableFutureTask<WebSocketSession>(connectTask);
    task.run();
    return task;
  }
}
