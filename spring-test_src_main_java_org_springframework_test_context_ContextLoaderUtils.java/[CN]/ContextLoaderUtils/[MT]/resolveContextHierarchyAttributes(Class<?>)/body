{
  Assert.notNull(testClass,"Class must not be null");
  Assert.state(findAnnotation(testClass,ContextHierarchy.class) != null,"@ContextHierarchy must be present");
  final Class<ContextConfiguration> contextConfigType=ContextConfiguration.class;
  final Class<ContextHierarchy> contextHierarchyType=ContextHierarchy.class;
  final List<List<ContextConfigurationAttributes>> hierarchyAttributes=new ArrayList<List<ContextConfigurationAttributes>>();
  UntypedAnnotationDescriptor descriptor=findAnnotationDescriptorForTypes(testClass,contextConfigType,contextHierarchyType);
  Assert.notNull(descriptor,String.format("Could not find an 'annotation declaring class' for annotation type [%s] or [%s] and test class [%s]",contextConfigType.getName(),contextHierarchyType.getName(),testClass.getName()));
  while (descriptor != null) {
    Class<?> rootDeclaringClass=descriptor.getRootDeclaringClass();
    Class<?> declaringClass=descriptor.getDeclaringClass();
    boolean contextConfigDeclaredLocally=isAnnotationDeclaredLocally(contextConfigType,declaringClass);
    boolean contextHierarchyDeclaredLocally=isAnnotationDeclaredLocally(contextHierarchyType,declaringClass);
    if (contextConfigDeclaredLocally && contextHierarchyDeclaredLocally) {
      String msg=String.format("Class [%s] has been configured with both @ContextConfiguration " + "and @ContextHierarchy. Only one of these annotations may be declared on a test class " + "or custom stereotype annotation.",declaringClass.getName());
      logger.error(msg);
      throw new IllegalStateException(msg);
    }
    final List<ContextConfigurationAttributes> configAttributesList=new ArrayList<ContextConfigurationAttributes>();
    if (contextConfigDeclaredLocally) {
      convertAnnotationAttributesToConfigAttributesAndAddToList(descriptor.getAnnotationAttributes(),declaringClass,configAttributesList);
    }
 else     if (contextHierarchyDeclaredLocally) {
      ContextHierarchy contextHierarchy=getAnnotation(declaringClass,contextHierarchyType);
      for (      ContextConfiguration contextConfiguration : contextHierarchy.value()) {
        convertContextConfigToConfigAttributesAndAddToList(contextConfiguration,declaringClass,configAttributesList);
      }
    }
 else {
      String msg=String.format("Test class [%s] has been configured with neither @ContextConfiguration " + "nor @ContextHierarchy as a class-level annotation.",rootDeclaringClass.getName());
      logger.error(msg);
      throw new IllegalStateException(msg);
    }
    hierarchyAttributes.add(0,configAttributesList);
    descriptor=findAnnotationDescriptorForTypes(rootDeclaringClass.getSuperclass(),contextConfigType,contextHierarchyType);
  }
  return hierarchyAttributes;
}
