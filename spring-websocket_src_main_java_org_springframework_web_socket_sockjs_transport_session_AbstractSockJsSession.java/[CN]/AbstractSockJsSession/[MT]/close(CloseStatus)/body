{
  if (isOpen()) {
    if (logger.isInfoEnabled()) {
      logger.info("Closing SockJS session " + getId() + " with "+ status);
    }
    try {
      if (isActive() && !CloseStatus.SESSION_NOT_RELIABLE.equals(status)) {
        try {
          writeFrameInternal(SockJsFrame.closeFrame(status.getCode(),status.getReason()));
        }
 catch (        Throwable ex) {
          logger.debug("Failure while send SockJS close frame",ex);
        }
      }
      updateLastActiveTime();
      cancelHeartbeat();
      disconnect(status);
    }
  finally {
      this.state=State.CLOSED;
      try {
        this.handler.afterConnectionClosed(this,status);
      }
 catch (      Throwable ex) {
        logger.error("Error from WebSocketHandler.afterConnectionClosed in " + this,ex);
      }
    }
  }
}
