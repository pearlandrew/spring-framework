{
  MockControl ctrlDataSource;
  DataSource mockDataSource;
  MockControl ctrlConnection;
  Connection mockConnection;
  ctrlConnection=MockControl.createControl(Connection.class);
  mockConnection=(Connection)ctrlConnection.getMock();
  mockConnection.getMetaData();
  ctrlConnection.setDefaultReturnValue(null);
  mockConnection.close();
  ctrlConnection.setDefaultVoidCallable();
  ctrlDataSource=MockControl.createControl(DataSource.class);
  mockDataSource=(DataSource)ctrlDataSource.getMock();
  mockDataSource.getConnection();
  ctrlDataSource.setDefaultReturnValue(mockConnection);
  final String sql="UPDATE NOSUCHTABLE SET DATE_DISPATCHED = SYSDATE WHERE ID = ?";
  final List<Object[]> ids=new ArrayList<Object[]>();
  ids.add(new Object[]{100});
  ids.add(new Object[]{200});
  final int[] rowsAffected=new int[]{1,2};
  MockControl ctrlPreparedStatement=MockControl.createControl(PreparedStatement.class);
  PreparedStatement mockPreparedStatement=(PreparedStatement)ctrlPreparedStatement.getMock();
  mockPreparedStatement.getConnection();
  ctrlPreparedStatement.setReturnValue(mockConnection);
  mockPreparedStatement.setObject(1,((Integer)ids.get(0)[0]).intValue());
  ctrlPreparedStatement.setVoidCallable();
  mockPreparedStatement.addBatch();
  ctrlPreparedStatement.setVoidCallable();
  mockPreparedStatement.setObject(1,((Integer)ids.get(1)[0]).intValue());
  ctrlPreparedStatement.setVoidCallable();
  mockPreparedStatement.addBatch();
  ctrlPreparedStatement.setVoidCallable();
  mockPreparedStatement.executeBatch();
  ctrlPreparedStatement.setReturnValue(rowsAffected);
  if (debugEnabled) {
    mockPreparedStatement.getWarnings();
    ctrlPreparedStatement.setReturnValue(null);
  }
  mockPreparedStatement.close();
  ctrlPreparedStatement.setVoidCallable();
  MockControl ctrlDatabaseMetaData=MockControl.createControl(DatabaseMetaData.class);
  DatabaseMetaData mockDatabaseMetaData=(DatabaseMetaData)ctrlDatabaseMetaData.getMock();
  mockDatabaseMetaData.getDatabaseProductName();
  ctrlDatabaseMetaData.setReturnValue("MySQL");
  mockDatabaseMetaData.supportsBatchUpdates();
  ctrlDatabaseMetaData.setReturnValue(true);
  mockConnection.prepareStatement(sql);
  ctrlConnection.setReturnValue(mockPreparedStatement);
  mockConnection.getMetaData();
  ctrlConnection.setReturnValue(mockDatabaseMetaData,2);
  ctrlPreparedStatement.replay();
  ctrlDatabaseMetaData.replay();
  ctrlDataSource.replay();
  ctrlConnection.replay();
  JdbcTemplate template=new JdbcTemplate(mockDataSource,false);
  SimpleJdbcTemplate simpleJdbcTemplate=new SimpleJdbcTemplate(template);
  int[] actualRowsAffected=simpleJdbcTemplate.batchUpdate(sql,ids);
  assertTrue("executed 2 updates",actualRowsAffected.length == 2);
  assertEquals(rowsAffected[0],actualRowsAffected[0]);
  assertEquals(rowsAffected[1],actualRowsAffected[1]);
  ctrlPreparedStatement.verify();
  ctrlDatabaseMetaData.verify();
}
