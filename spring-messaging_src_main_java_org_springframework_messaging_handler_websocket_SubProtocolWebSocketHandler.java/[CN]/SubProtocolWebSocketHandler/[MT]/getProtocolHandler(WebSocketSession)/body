{
  SubProtocolHandler handler;
  String protocol=session.getAcceptedProtocol();
  if (!StringUtils.isEmpty(protocol)) {
    handler=this.protocolHandlers.get(protocol);
    Assert.state(handler != null,"No handler for sub-protocol '" + protocol + "', handlers="+ this.protocolHandlers);
  }
 else {
    handler=this.defaultProtocolHandler;
    Assert.state(handler != null,"No sub-protocol was requested and a default sub-protocol handler was not configured");
  }
  return handler;
}
