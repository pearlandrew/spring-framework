{
  MockJavaMailSender sender=new MockJavaMailSender();
  sender.setHost("host");
  sender.setUsername("username");
  sender.setPassword("password");
  final List messages=new ArrayList();
  MimeMessagePreparator preparator1=new MimeMessagePreparator(){
    public void prepare(    MimeMessage mimeMessage) throws MessagingException {
      mimeMessage.setRecipient(Message.RecipientType.TO,new InternetAddress("he@mail.org"));
      messages.add(mimeMessage);
    }
  }
;
  MimeMessagePreparator preparator2=new MimeMessagePreparator(){
    public void prepare(    MimeMessage mimeMessage) throws MessagingException {
      mimeMessage.setRecipient(Message.RecipientType.TO,new InternetAddress("she@mail.org"));
      messages.add(mimeMessage);
    }
  }
;
  sender.send(new MimeMessagePreparator[]{preparator1,preparator2});
  assertEquals(sender.transport.getConnectedHost(),"host");
  assertEquals(sender.transport.getConnectedUsername(),"username");
  assertEquals(sender.transport.getConnectedPassword(),"password");
  assertTrue(sender.transport.isCloseCalled());
  assertEquals(2,sender.transport.getSentMessages().size());
  assertEquals(messages.get(0),sender.transport.getSentMessage(0));
  assertEquals(messages.get(1),sender.transport.getSentMessage(1));
}
