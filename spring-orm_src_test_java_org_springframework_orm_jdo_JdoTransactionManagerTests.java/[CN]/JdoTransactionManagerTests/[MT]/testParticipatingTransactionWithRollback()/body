{
  given(pmf.getPersistenceManager()).willReturn(pm);
  given(pm.currentTransaction()).willReturn(tx);
  given(tx.isActive()).willReturn(true);
  PlatformTransactionManager tm=new JdoTransactionManager(pmf);
  final TransactionTemplate tt=new TransactionTemplate(tm);
  try {
    tt.execute(new TransactionCallback(){
      @Override public Object doInTransaction(      TransactionStatus status){
        return tt.execute(new TransactionCallback(){
          @Override public Object doInTransaction(          TransactionStatus status){
            JdoTemplate jt=new JdoTemplate(pmf);
            return jt.execute(new JdoCallback(){
              @Override public Object doInJdo(              PersistenceManager pm){
                throw new RuntimeException("application exception");
              }
            }
);
          }
        }
);
      }
    }
);
    fail("Should have thrown RuntimeException");
  }
 catch (  RuntimeException ex) {
  }
  verify(pm).close();
  verify(tx).begin();
  verify(tx).setRollbackOnly();
  verify(tx).rollback();
}
