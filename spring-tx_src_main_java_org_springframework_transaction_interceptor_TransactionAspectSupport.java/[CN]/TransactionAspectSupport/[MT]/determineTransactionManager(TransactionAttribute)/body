{
  if (this.beanFactory != null) {
    String qualifier=txAttr != null ? txAttr.getQualifier() : null;
    if (StringUtils.hasText(qualifier)) {
      PlatformTransactionManager txManager=this.transactionManagerCache.get(qualifier);
      if (txManager == null) {
        txManager=BeanFactoryAnnotationUtils.qualifiedBeanOfType(this.beanFactory,PlatformTransactionManager.class,qualifier);
        this.transactionManagerCache.putIfAbsent(qualifier,txManager);
      }
      return txManager;
    }
 else     if (StringUtils.hasText(this.transactionManagerBeanName)) {
      PlatformTransactionManager txManager=this.transactionManagerCache.get(this.transactionManagerBeanName);
      if (txManager == null) {
        txManager=this.beanFactory.getBean(this.transactionManagerBeanName,PlatformTransactionManager.class);
        this.transactionManagerCache.putIfAbsent(this.transactionManagerBeanName,txManager);
      }
      return txManager;
    }
 else {
      PlatformTransactionManager defaultTransactionManager=getTransactionManager();
      if (defaultTransactionManager == null) {
        defaultTransactionManager=this.beanFactory.getBean(PlatformTransactionManager.class);
        this.transactionManagerCache.putIfAbsent(DEFAULT_TRANSACTION_MANAGER_KEY,defaultTransactionManager);
      }
      return defaultTransactionManager;
    }
  }
  return getTransactionManager();
}
