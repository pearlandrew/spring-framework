{
  if (txAttr == null || this.beanFactory == null) {
    return getTransactionManager();
  }
  String qualifier=(txAttr.getQualifier() != null ? txAttr.getQualifier() : this.transactionManagerBeanName);
  if (StringUtils.hasText(qualifier)) {
    PlatformTransactionManager txManager=this.transactionManagerCache.get(qualifier);
    if (txManager == null) {
      txManager=BeanFactoryAnnotationUtils.qualifiedBeanOfType(this.beanFactory,PlatformTransactionManager.class,qualifier);
      this.transactionManagerCache.putIfAbsent(qualifier,txManager);
    }
    return txManager;
  }
 else {
    PlatformTransactionManager defaultTransactionManager=getTransactionManager();
    if (defaultTransactionManager == null) {
      defaultTransactionManager=this.beanFactory.getBean(PlatformTransactionManager.class);
      this.transactionManagerCache.putIfAbsent(DEFAULT_TRANSACTION_MANAGER_KEY,defaultTransactionManager);
    }
    return defaultTransactionManager;
  }
}
