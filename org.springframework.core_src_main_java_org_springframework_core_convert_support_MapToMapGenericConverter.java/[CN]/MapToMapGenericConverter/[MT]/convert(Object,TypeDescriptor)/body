{
  Map sourceMap=(Map)source;
  Class targetKeyType=targetType.getMapKeyType();
  Class targetValueType=targetType.getMapValueType();
  if (targetKeyType == null && targetValueType == null) {
    return compatibleMapWithoutEntryConversion(sourceMap,targetType);
  }
  Class[] sourceEntryTypes=getMapEntryTypes(sourceMap);
  Class sourceKeyType=sourceEntryTypes[0];
  Class sourceValueType=sourceEntryTypes[1];
  if (sourceKeyType == null && sourceValueType == null) {
    return compatibleMapWithoutEntryConversion(sourceMap,targetType);
  }
  boolean keysCompatible=false;
  if (targetKeyType != null && sourceKeyType != null && targetKeyType.isAssignableFrom(sourceKeyType)) {
    keysCompatible=true;
  }
  boolean valuesCompatible=false;
  if (targetValueType != null && sourceValueType != null && targetValueType.isAssignableFrom(sourceValueType)) {
    valuesCompatible=true;
  }
  if (keysCompatible && valuesCompatible) {
    return compatibleMapWithoutEntryConversion(sourceMap,targetType);
  }
  Map targetMap=CollectionFactory.createMap(targetType.getType(),sourceMap.size());
  MapEntryConverter converter=new MapEntryConverter(sourceKeyType,sourceValueType,targetKeyType,targetValueType,keysCompatible,valuesCompatible,conversionService);
  for (  Object entry : sourceMap.entrySet()) {
    Map.Entry sourceMapEntry=(Map.Entry)entry;
    targetMap.put(converter.convertKey(sourceMapEntry.getKey()),converter.convertValue(sourceMapEntry.getValue()));
  }
  return targetMap;
}
