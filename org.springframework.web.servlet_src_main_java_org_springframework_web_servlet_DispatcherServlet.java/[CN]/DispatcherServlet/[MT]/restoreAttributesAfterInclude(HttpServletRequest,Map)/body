{
  logger.debug("Restoring snapshot of request attributes after include");
  Set<String> attrsToCheck=new HashSet<String>();
  Enumeration attrNames=request.getAttributeNames();
  while (attrNames.hasMoreElements()) {
    String attrName=(String)attrNames.nextElement();
    if (this.cleanupAfterInclude || attrName.startsWith("org.springframework.web.servlet")) {
      attrsToCheck.add(attrName);
    }
  }
  for (  String attrName : attrsToCheck) {
    Object attrValue=attributesSnapshot.get(attrName);
    if (attrValue == null) {
      if (logger.isDebugEnabled()) {
        logger.debug("Removing attribute [" + attrName + "] after include");
      }
      request.removeAttribute(attrName);
    }
 else     if (attrValue != request.getAttribute(attrName)) {
      if (logger.isDebugEnabled()) {
        logger.debug("Restoring original value of attribute [" + attrName + "] after include");
      }
      request.setAttribute(attrName,attrValue);
    }
  }
}
