{
  Assert.isTrue(request instanceof ServletServerHttpRequest);
  HttpServletRequest servletRequest=((ServletServerHttpRequest)request).getServletRequest();
  Assert.isTrue(response instanceof ServletServerHttpResponse);
  HttpServletResponse servletResponse=((ServletServerHttpResponse)response).getServletResponse();
  servletResponse=new AlreadyUpgradedResponseWrapper(servletResponse);
  TyrusEndpoint tyrusEndpoint=createTyrusEndpoint(servletRequest,endpoint);
  WebSocketEngine.getEngine().register(tyrusEndpoint);
  try {
    if (!performUpgrade(servletRequest,servletResponse,request.getHeaders(),tyrusEndpoint)) {
      throw new IllegalStateException("Failed to upgrade HttpServletRequest");
    }
  }
  finally {
    WebSocketEngine.getEngine().unregister(tyrusEndpoint);
  }
}
