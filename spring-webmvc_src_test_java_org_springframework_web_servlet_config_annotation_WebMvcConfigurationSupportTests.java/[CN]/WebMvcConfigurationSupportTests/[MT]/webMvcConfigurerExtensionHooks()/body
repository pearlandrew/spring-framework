{
  StaticWebApplicationContext appCxt=new StaticWebApplicationContext();
  appCxt.setServletContext(new MockServletContext(new FileSystemResourceLoader()));
  appCxt.registerSingleton("controller",TestController.class);
  WebConfig webConfig=new WebConfig();
  webConfig.setApplicationContext(appCxt);
  webConfig.setServletContext(appCxt.getServletContext());
  String actual=webConfig.mvcConversionService().convert(new TestBean(),String.class);
  assertEquals("converted",actual);
  MockHttpServletRequest request=new MockHttpServletRequest("GET","/foo.json");
  NativeWebRequest webRequest=new ServletWebRequest(request);
  ContentNegotiationManager manager=webConfig.requestMappingHandlerMapping().getContentNegotiationManager();
  assertEquals(Arrays.asList(MediaType.APPLICATION_JSON),manager.resolveMediaTypes(webRequest));
  request.setRequestURI("/foo.xml");
  assertEquals(Arrays.asList(MediaType.APPLICATION_XML),manager.resolveMediaTypes(webRequest));
  request.setRequestURI("/foo.rss");
  assertEquals(Arrays.asList(MediaType.valueOf("application/rss+xml")),manager.resolveMediaTypes(webRequest));
  request.setRequestURI("/foo.atom");
  assertEquals(Arrays.asList(MediaType.APPLICATION_ATOM_XML),manager.resolveMediaTypes(webRequest));
  request.setRequestURI("/foo");
  request.setParameter("f","json");
  assertEquals(Arrays.asList(MediaType.APPLICATION_JSON),manager.resolveMediaTypes(webRequest));
  RequestMappingHandlerAdapter adapter=webConfig.requestMappingHandlerAdapter();
  assertEquals(1,adapter.getMessageConverters().size());
  ConfigurableWebBindingInitializer initializer=(ConfigurableWebBindingInitializer)adapter.getWebBindingInitializer();
  assertNotNull(initializer);
  BeanPropertyBindingResult bindingResult=new BeanPropertyBindingResult(null,"");
  initializer.getValidator().validate(null,bindingResult);
  assertEquals("invalid",bindingResult.getAllErrors().get(0).getCode());
  String[] codes=initializer.getMessageCodesResolver().resolveMessageCodes("invalid",null);
  assertEquals("custom.invalid",codes[0]);
  @SuppressWarnings("unchecked") List<HandlerMethodArgumentResolver> argResolvers=(List<HandlerMethodArgumentResolver>)new DirectFieldAccessor(adapter).getPropertyValue("customArgumentResolvers");
  assertEquals(1,argResolvers.size());
  @SuppressWarnings("unchecked") List<HandlerMethodReturnValueHandler> handlers=(List<HandlerMethodReturnValueHandler>)new DirectFieldAccessor(adapter).getPropertyValue("customReturnValueHandlers");
  assertEquals(1,handlers.size());
  HandlerExceptionResolverComposite composite=(HandlerExceptionResolverComposite)webConfig.handlerExceptionResolver();
  assertEquals(1,composite.getExceptionResolvers().size());
  RequestMappingHandlerMapping rmHandlerMapping=webConfig.requestMappingHandlerMapping();
  rmHandlerMapping.setApplicationContext(appCxt);
  rmHandlerMapping.afterPropertiesSet();
  HandlerExecutionChain chain=rmHandlerMapping.getHandler(new MockHttpServletRequest("GET","/"));
  assertNotNull(chain.getInterceptors());
  assertEquals(2,chain.getInterceptors().length);
  assertEquals(LocaleChangeInterceptor.class,chain.getInterceptors()[0].getClass());
  assertEquals(ConversionServiceExposingInterceptor.class,chain.getInterceptors()[1].getClass());
  AbstractHandlerMapping handlerMapping=(AbstractHandlerMapping)webConfig.viewControllerHandlerMapping();
  handlerMapping.setApplicationContext(appCxt);
  assertNotNull(handlerMapping);
  assertEquals(1,handlerMapping.getOrder());
  HandlerExecutionChain handler=handlerMapping.getHandler(new MockHttpServletRequest("GET","/path"));
  assertNotNull(handler.getHandler());
  handlerMapping=(AbstractHandlerMapping)webConfig.resourceHandlerMapping();
  handlerMapping.setApplicationContext(appCxt);
  assertNotNull(handlerMapping);
  assertEquals(Integer.MAX_VALUE - 1,handlerMapping.getOrder());
  handler=handlerMapping.getHandler(new MockHttpServletRequest("GET","/resources/foo.gif"));
  assertNotNull(handler.getHandler());
  handlerMapping=(AbstractHandlerMapping)webConfig.defaultServletHandlerMapping();
  handlerMapping.setApplicationContext(appCxt);
  assertNotNull(handlerMapping);
  assertEquals(Integer.MAX_VALUE,handlerMapping.getOrder());
  handler=handlerMapping.getHandler(new MockHttpServletRequest("GET","/anyPath"));
  assertNotNull(handler.getHandler());
}
