{
  String key=MessageHeaders.SEQUENCE_DETAILS;
  if (!headers.containsKey(key)) {
    return this;
  }
  @SuppressWarnings("unchecked") List<List<Object>> incomingSequenceDetails=new ArrayList<List<Object>>((List<List<Object>>)headers.get(key));
  List<Object> sequenceDetails=incomingSequenceDetails.remove(incomingSequenceDetails.size() - 1);
  Assert.state(sequenceDetails.size() == 3,"Wrong sequence details (not created by MessageBuilder?): " + sequenceDetails);
  setCorrelationId(sequenceDetails.get(0));
  Integer sequenceNumber=(Integer)sequenceDetails.get(1);
  Integer sequenceSize=(Integer)sequenceDetails.get(2);
  if (sequenceNumber != null) {
    setSequenceNumber(sequenceNumber);
  }
  if (sequenceSize != null) {
    setSequenceSize(sequenceSize);
  }
  if (!incomingSequenceDetails.isEmpty()) {
    headers.put(MessageHeaders.SEQUENCE_DETAILS,incomingSequenceDetails);
  }
 else {
    headers.remove(MessageHeaders.SEQUENCE_DETAILS);
  }
  return this;
}
