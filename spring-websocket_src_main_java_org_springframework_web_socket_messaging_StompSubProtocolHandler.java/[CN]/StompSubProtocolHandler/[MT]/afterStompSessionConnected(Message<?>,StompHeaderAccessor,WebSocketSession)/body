{
  Principal principal=session.getPrincipal();
  if (principal != null) {
    accessor=toMutableAccessor(accessor,message);
    accessor.setNativeHeader(CONNECTED_USER_HEADER,principal.getName());
    if (this.userSessionRegistry != null) {
      String userName=getSessionRegistryUserName(principal);
      this.userSessionRegistry.registerSessionId(userName,session.getId());
    }
  }
  long[] heartbeat=accessor.getHeartbeat();
  if (heartbeat[1] > 0) {
    session=WebSocketSessionDecorator.unwrap(session);
    if (session instanceof SockJsSession) {
      ((SockJsSession)session).disableHeartbeat();
    }
  }
  return accessor;
}
