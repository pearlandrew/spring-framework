{
  this.decoders.remove(session.getId());
  Principal principal=session.getPrincipal();
  if ((this.userSessionRegistry != null) && (principal != null)) {
    String userName=resolveNameForUserSessionRegistry(principal);
    this.userSessionRegistry.unregisterSessionId(userName,session.getId());
  }
  if (this.eventPublisher != null) {
    publishEvent(new SessionDisconnectEvent(this,session.getId(),closeStatus));
  }
  Message<?> message=createDisconnectMessage(session);
  SimpAttributes simpAttributes=SimpAttributes.fromMessage(message);
  try {
    if (logger.isDebugEnabled()) {
      logger.debug("WebSocket session ended, sending DISCONNECT message to broker");
    }
    SimpAttributesContextHolder.setAttributes(simpAttributes);
    outputChannel.send(message);
  }
  finally {
    SimpAttributesContextHolder.resetAttributes();
    simpAttributes.sessionCompleted();
  }
}
