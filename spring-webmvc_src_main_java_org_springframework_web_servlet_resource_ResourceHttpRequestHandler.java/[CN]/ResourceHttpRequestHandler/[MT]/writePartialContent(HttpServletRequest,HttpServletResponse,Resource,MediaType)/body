{
  long length=resource.contentLength();
  List<HttpRange> ranges;
  try {
    HttpHeaders headers=new ServletServerHttpRequest(request).getHeaders();
    ranges=headers.getRange();
  }
 catch (  IllegalArgumentException ex) {
    response.addHeader("Content-Range","bytes */" + length);
    response.sendError(HttpServletResponse.SC_REQUESTED_RANGE_NOT_SATISFIABLE);
    return;
  }
  response.setStatus(HttpServletResponse.SC_PARTIAL_CONTENT);
  if (ranges.size() == 1) {
    HttpRange range=ranges.get(0);
    long start=range.getRangeStart(length);
    long end=range.getRangeEnd(length);
    long rangeLength=end - start + 1;
    setHeaders(response,resource,contentType);
    response.addHeader("Content-Range","bytes " + start + "-"+ end+ "/"+ length);
    response.setContentLength((int)rangeLength);
    InputStream in=resource.getInputStream();
    try {
      copyRange(in,response.getOutputStream(),start,end);
    }
  finally {
      try {
        in.close();
      }
 catch (      IOException ex) {
      }
    }
  }
 else {
    String boundaryString=MimeTypeUtils.generateMultipartBoundaryString();
    response.setContentType("multipart/byteranges; boundary=" + boundaryString);
    ServletOutputStream out=response.getOutputStream();
    for (    HttpRange range : ranges) {
      long start=range.getRangeStart(length);
      long end=range.getRangeEnd(length);
      InputStream in=resource.getInputStream();
      out.println();
      out.println("--" + boundaryString);
      if (contentType != null) {
        out.println("Content-Type: " + contentType);
      }
      out.println("Content-Range: bytes " + start + "-"+ end+ "/"+ length);
      out.println();
      copyRange(in,out,start,end);
    }
    out.println();
    out.print("--" + boundaryString + "--");
  }
}
