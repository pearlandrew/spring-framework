{
  checkAndPrepare(request,response,true);
  Resource resource=getResource(request);
  if (resource == null) {
    logger.trace("No matching resource found - returning 404");
    response.sendError(HttpServletResponse.SC_NOT_FOUND);
    return;
  }
  MediaType mediaType=getMediaType(resource);
  if (mediaType != null) {
    if (logger.isTraceEnabled()) {
      logger.trace("Determined media type '" + mediaType + "' for "+ resource);
    }
  }
 else {
    if (logger.isTraceEnabled()) {
      logger.trace("No media type found for " + resource + " - not sending a content-type header");
    }
  }
  if (new ServletWebRequest(request,response).checkNotModified(resource.lastModified())) {
    logger.trace("Resource not modified - returning 304");
    return;
  }
  setHeaders(response,resource,mediaType);
  if (METHOD_HEAD.equals(request.getMethod())) {
    logger.trace("HEAD request - skipping content");
    return;
  }
  writeContent(response,resource);
}
