{
  response.setContentType(getContentType());
  OutputStream out=response.getOutputStream();
  WritableWorkbook workbook;
  if (this.url != null) {
    Workbook template=getTemplateSource(this.url,request);
    workbook=Workbook.createWorkbook(out,template);
  }
 else {
    logger.debug("Creating Excel Workbook from scratch");
    workbook=Workbook.createWorkbook(out);
  }
  buildExcelDocument(model,workbook,request,response);
  workbook.write();
  out.flush();
  workbook.close();
}
