{
  Object testEntity=new Object();
  MockControl sharedEmMc=MockControl.createControl(EntityManager.class);
  EntityManager sharedEm=(EntityManager)sharedEmMc.getMock();
  sharedEm.getTransaction();
  sharedEmMc.setReturnValue(new NoOpEntityTransaction(),3);
  sharedEm.close();
  sharedEmMc.setVoidCallable(1);
  sharedEmMc.replay();
  mockEmf.createEntityManager();
  emfMc.setReturnValue(sharedEm);
  MockControl emMc=MockControl.createControl(EntityManager.class);
  EntityManager mockEm=(EntityManager)emMc.getMock();
  mockEm.joinTransaction();
  emMc.setVoidCallable(1);
  mockEm.contains(testEntity);
  emMc.setReturnValue(false);
  emMc.replay();
  mockEmf.createEntityManager();
  emfMc.setReturnValue(mockEm);
  mockEmf.close();
  emfMc.setVoidCallable();
  emfMc.replay();
  LocalContainerEntityManagerFactoryBean cefb=parseValidPersistenceUnit();
  MutablePersistenceUnitInfo pui=((MutablePersistenceUnitInfo)cefb.getPersistenceUnitInfo());
  pui.setTransactionType(PersistenceUnitTransactionType.JTA);
  JpaTransactionManager jpatm=new JpaTransactionManager();
  jpatm.setEntityManagerFactory(cefb.getObject());
  TransactionStatus txStatus=jpatm.getTransaction(new DefaultTransactionAttribute());
  EntityManagerFactory emf=cefb.getObject();
  assertSame("EntityManagerFactory reference must be cached after init",emf,cefb.getObject());
  assertNotSame("EMF must be proxied",mockEmf,emf);
  EntityManager em=emf.createEntityManager();
  em.joinTransaction();
  assertFalse(em.contains(testEntity));
  jpatm.commit(txStatus);
  cefb.destroy();
  emfMc.verify();
  emMc.verify();
}
