{
  Session session=getSession(entityManager);
  FlushMode flushMode=session.getFlushMode();
  FlushMode previousFlushMode=null;
  if (readOnly) {
    session.setFlushMode(FlushMode.MANUAL);
    previousFlushMode=flushMode;
  }
 else {
    if (flushMode.lessThan(FlushMode.COMMIT)) {
      session.setFlushMode(FlushMode.AUTO);
      previousFlushMode=flushMode;
    }
  }
  if (getEntityManagerFactoryMethod != null) {
    EntityManagerFactory emf=(EntityManagerFactory)ReflectionUtils.invokeMethod(getEntityManagerFactoryMethod,entityManager);
    if (emf instanceof HibernateEntityManagerFactory) {
      SessionFactory sf=((HibernateEntityManagerFactory)emf).getSessionFactory();
      TransactionSynchronizationManager.bindResource(sf,session);
    }
  }
  return new SessionTransactionData(session,previousFlushMode);
}
