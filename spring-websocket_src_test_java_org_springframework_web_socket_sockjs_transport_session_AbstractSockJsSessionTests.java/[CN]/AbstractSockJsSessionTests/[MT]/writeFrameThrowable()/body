{
  this.session.setExceptionOnWriteFrame(new NullPointerException());
  this.session.delegateConnectionEstablished();
  try {
    this.session.writeFrame(SockJsFrame.openFrame());
    fail("expected exception");
  }
 catch (  SockJsProcessingException ex) {
    assertEquals(CloseStatus.SERVER_ERROR,this.session.getStatus());
    verify(this.webSocketHandler).afterConnectionClosed(this.session,CloseStatus.SERVER_ERROR);
  }
}
