{
  MediaType contentType=inputMessage.getHeaders().getContentType();
  contentType=contentType != null ? contentType : PROTOBUF;
  InputStreamReader reader=new InputStreamReader(inputMessage.getBody(),getCharset(inputMessage.getHeaders()));
  try {
    Message.Builder builder=createMessageBuilder(clazz);
    if (MediaType.APPLICATION_JSON.isCompatibleWith(contentType)) {
      JsonFormat.merge(reader,extensionRegistry,builder);
    }
 else     if (MediaType.TEXT_PLAIN.isCompatibleWith(contentType)) {
      TextFormat.merge(reader,extensionRegistry,builder);
    }
 else     if (MediaType.APPLICATION_XML.isCompatibleWith(contentType)) {
      XmlFormat.merge(reader,extensionRegistry,builder);
    }
 else {
      builder.mergeFrom(inputMessage.getBody(),extensionRegistry);
    }
    return builder.build();
  }
 catch (  Exception e) {
    throw new HttpMessageNotReadableException("Could not read Protobuf message: " + e.getMessage(),e);
  }
}
