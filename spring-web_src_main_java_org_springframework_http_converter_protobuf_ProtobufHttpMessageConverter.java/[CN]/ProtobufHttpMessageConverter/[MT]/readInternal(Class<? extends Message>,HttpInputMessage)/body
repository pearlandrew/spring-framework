{
  MediaType contentType=inputMessage.getHeaders().getContentType();
  contentType=(contentType != null ? contentType : PROTOBUF);
  Charset charset=getCharset(inputMessage.getHeaders());
  InputStreamReader reader=new InputStreamReader(inputMessage.getBody(),charset);
  try {
    Message.Builder builder=getMessageBuilder(clazz);
    if (MediaType.APPLICATION_JSON.isCompatibleWith(contentType)) {
      JsonFormat.merge(reader,this.extensionRegistry,builder);
    }
 else     if (MediaType.TEXT_PLAIN.isCompatibleWith(contentType)) {
      TextFormat.merge(reader,this.extensionRegistry,builder);
    }
 else     if (MediaType.APPLICATION_XML.isCompatibleWith(contentType)) {
      XmlFormat.merge(reader,this.extensionRegistry,builder);
    }
 else {
      builder.mergeFrom(inputMessage.getBody(),this.extensionRegistry);
    }
    return builder.build();
  }
 catch (  Exception e) {
    throw new HttpMessageNotReadableException("Could not read Protobuf message: " + e.getMessage(),e);
  }
}
