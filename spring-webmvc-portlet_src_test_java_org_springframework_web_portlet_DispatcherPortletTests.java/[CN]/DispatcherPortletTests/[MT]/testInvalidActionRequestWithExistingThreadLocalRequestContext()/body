{
  MockActionRequest request=new MockActionRequest();
  MockActionResponse response=new MockActionResponse();
  request.addPreferredLocale(Locale.GERMAN);
  try {
    LocaleContextHolder.setLocale(request.getLocale());
    RequestContextHolder.setRequestAttributes(new PortletRequestAttributes(request));
    LocaleContext servletLocaleContext=LocaleContextHolder.getLocaleContext();
    RequestAttributes servletRequestAttrs=RequestContextHolder.getRequestAttributes();
    request.setParameter("action","invalid");
    simpleDispatcherPortlet.processAction(request,response);
    String exceptionParam=response.getRenderParameter(DispatcherPortlet.ACTION_EXCEPTION_RENDER_PARAMETER);
    assertNotNull(exceptionParam);
    assertSame(servletLocaleContext,LocaleContextHolder.getLocaleContext());
    assertSame(servletRequestAttrs,RequestContextHolder.getRequestAttributes());
  }
  finally {
    RequestContextHolder.resetRequestAttributes();
    LocaleContextHolder.resetLocaleContext();
  }
}
