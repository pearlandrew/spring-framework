{
  MockControl sessionControl=MockControl.createControl(Session.class);
  Session session=(Session)sessionControl.getMock();
  SessionFactory factory=new SingleSessionFactory(session);
  session.hasExternalTransactionController();
  sessionControl.setReturnValue(false,2);
  sessionControl.replay();
  Session boundSession=SessionFactoryUtils.getSession(factory,true);
  assertTrue(session == boundSession);
  SessionHolder holder=(SessionHolder)TransactionSynchronizationManager.getResource(factory);
  assertTrue(holder == null);
  boundSession=SessionFactoryUtils.getSession(factory,true);
  assertTrue(session == boundSession);
  assertFalse(TransactionSynchronizationManager.hasResource(factory));
}
