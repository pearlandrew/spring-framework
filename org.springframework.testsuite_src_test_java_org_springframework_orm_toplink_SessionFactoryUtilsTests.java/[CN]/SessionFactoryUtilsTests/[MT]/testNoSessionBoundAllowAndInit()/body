{
  MockControl sessionControl=MockControl.createControl(Session.class);
  Session session=(Session)sessionControl.getMock();
  SessionFactory factory=new SingleSessionFactory(session);
  session.hasExternalTransactionController();
  sessionControl.setReturnValue(false,1);
  sessionControl.replay();
  Session boundSession=SessionFactoryUtils.getSession(factory,true);
  assertTrue(session == boundSession);
  SessionHolder holder=(SessionHolder)TransactionSynchronizationManager.getResource(factory);
  assertTrue(holder == null);
  TransactionSynchronizationManager.initSynchronization();
  boundSession=SessionFactoryUtils.getSession(factory,true);
  assertTrue(session == boundSession);
  assertTrue(TransactionSynchronizationManager.getSynchronizations().size() == 1);
  assertTrue(TransactionSynchronizationManager.hasResource(factory));
  assertTrue(session == ((SessionHolder)TransactionSynchronizationManager.getResource(factory)).getSession());
  TransactionSynchronizationManager.clearSynchronization();
  TransactionSynchronizationManager.unbindResource(factory);
}
