{
  Filter filter=mock(Filter.class);
  given(session.isOpen()).willReturn(true);
  given(session.enableFilter("myFilter")).willReturn(filter);
  hibernateTemplate.setAllowCreate(false);
  hibernateTemplate.setFilterName("myFilter");
  TransactionSynchronizationManager.bindResource(sessionFactory,new SessionHolder(session));
  try {
    final List l=new ArrayList();
    l.add("test");
    Filter f=hibernateTemplate.enableFilter("myFilter");
    assertTrue("Correct filter",f == filter);
  }
  finally {
    TransactionSynchronizationManager.unbindResource(sessionFactory);
  }
  InOrder ordered=inOrder(session);
  ordered.verify(session).getEnabledFilter("myFilter");
  ordered.verify(session).enableFilter("myFilter");
}
