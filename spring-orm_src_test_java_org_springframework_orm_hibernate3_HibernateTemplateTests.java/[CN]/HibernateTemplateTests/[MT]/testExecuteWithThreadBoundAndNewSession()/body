{
  Connection con=mock(Connection.class);
  Session session2=mock(Session.class);
  given(session2.connection()).willReturn(con);
  given(sessionFactory.openSession(con)).willReturn(session);
  hibernateTemplate.setAlwaysUseNewSession(true);
  TransactionSynchronizationManager.bindResource(sessionFactory,new SessionHolder(session2));
  try {
    final List l=new ArrayList();
    l.add("test");
    List result=hibernateTemplate.executeFind(new HibernateCallback<Object>(){
      @Override public Object doInHibernate(      org.hibernate.Session session) throws HibernateException {
        return l;
      }
    }
);
    assertTrue("Correct result list",result == l);
  }
  finally {
    TransactionSynchronizationManager.unbindResource(sessionFactory);
  }
  verify(session).flush();
  verify(session).close();
}
