{
  MockControl dsControl=MockControl.createControl(DataSource.class);
  DataSource ds=(DataSource)dsControl.getMock();
  MockControl conControl=MockControl.createControl(Connection.class);
  Connection con=(Connection)conControl.getMock();
  ds.getConnection("user","pw");
  dsControl.setReturnValue(con);
  dsControl.replay();
  conControl.replay();
  UserCredentialsDataSourceAdapter adapter=new UserCredentialsDataSourceAdapter();
  adapter.setTargetDataSource(ds);
  adapter.setCredentialsForCurrentThread("user","pw");
  try {
    assertEquals(con,adapter.getConnection());
  }
  finally {
    adapter.removeCredentialsFromCurrentThread();
  }
}
