{
  UserDestinationResult result=this.userDestinationResolver.resolveDestination(message);
  if (result == null) {
    return;
  }
  Set<String> destinations=result.getTargetDestinations();
  if (destinations.isEmpty()) {
    if (logger.isTraceEnabled()) {
      logger.trace("No target destinations, message=" + message);
    }
    return;
  }
  if (SimpMessageType.MESSAGE.equals(SimpMessageHeaderAccessor.getMessageType(message.getHeaders()))) {
    SimpMessageHeaderAccessor headerAccessor=SimpMessageHeaderAccessor.wrap(message);
    initHeaders(headerAccessor);
    String header=SimpMessageHeaderAccessor.ORIGINAL_DESTINATION;
    headerAccessor.setNativeHeader(header,result.getSubscribeDestination());
    message=MessageBuilder.createMessage(message.getPayload(),headerAccessor.getMessageHeaders());
  }
  for (  String destination : destinations) {
    if (logger.isDebugEnabled()) {
      logger.debug("Sending message to resolved destination=" + destination);
    }
    this.brokerMessagingTemplate.send(destination,message);
  }
}
