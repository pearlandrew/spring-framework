{
  SessionFactoryImplementor sessionFactoryImpl=null;
  if (sessionFactory instanceof SessionFactoryImplementor) {
    sessionFactoryImpl=((SessionFactoryImplementor)sessionFactory);
  }
 else   if (session != null) {
    SessionFactory internalFactory=session.getSessionFactory();
    if (internalFactory instanceof SessionFactoryImplementor) {
      sessionFactoryImpl=(SessionFactoryImplementor)internalFactory;
    }
  }
  return (sessionFactoryImpl != null ? sessionFactoryImpl.getTransactionManager() : null);
}
