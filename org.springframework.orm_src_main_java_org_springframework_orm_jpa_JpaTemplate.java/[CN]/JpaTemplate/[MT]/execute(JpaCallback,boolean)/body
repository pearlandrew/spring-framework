{
  Assert.notNull(action,"Callback object must not be null");
  EntityManager em=getEntityManager();
  boolean isNewEm=false;
  if (em == null) {
    em=getTransactionalEntityManager();
    if (em == null) {
      logger.debug("Creating new EntityManager for JpaTemplate execution");
      em=createEntityManager();
      isNewEm=true;
    }
  }
  try {
    EntityManager emToExpose=(exposeNativeEntityManager ? em : createEntityManagerProxy(em));
    Object result=action.doInJpa(emToExpose);
    flushIfNecessary(em,!isNewEm);
    return result;
  }
 catch (  RuntimeException ex) {
    throw translateIfNecessary(ex);
  }
 finally {
    if (isNewEm) {
      logger.debug("Closing new EntityManager after JPA template execution");
      EntityManagerFactoryUtils.closeEntityManager(em);
    }
  }
}
