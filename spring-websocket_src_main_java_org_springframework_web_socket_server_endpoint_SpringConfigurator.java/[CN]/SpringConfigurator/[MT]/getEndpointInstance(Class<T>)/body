{
  WebApplicationContext wac=ContextLoader.getCurrentWebApplicationContext();
  if (wac == null) {
    String message="Failed to find the root WebApplicationContext. Was ContextLoaderListener not used?";
    logger.error(message);
    throw new IllegalStateException(message);
  }
  String beanName=ClassUtils.getShortNameAsProperty(endpointClass);
  if (wac.containsBean(beanName)) {
    T endpoint=wac.getBean(beanName,endpointClass);
    if (logger.isTraceEnabled()) {
      logger.trace("Using @ServerEndpoint singleton " + endpoint);
    }
    return endpoint;
  }
  Component annot=AnnotationUtils.findAnnotation(endpointClass,Component.class);
  if ((annot != null) && wac.containsBean(annot.value())) {
    T endpoint=wac.getBean(annot.value(),endpointClass);
    if (logger.isTraceEnabled()) {
      logger.trace("Using @ServerEndpoint singleton " + endpoint);
    }
    return endpoint;
  }
  if (logger.isTraceEnabled()) {
    logger.trace("Creating new @ServerEndpoint instance of type " + endpointClass);
  }
  return wac.getAutowireCapableBeanFactory().createBean(endpointClass);
}
