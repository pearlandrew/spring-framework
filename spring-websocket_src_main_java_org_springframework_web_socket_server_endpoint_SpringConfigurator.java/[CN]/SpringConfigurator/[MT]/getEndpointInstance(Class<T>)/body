{
  WebApplicationContext wac=ContextLoader.getCurrentWebApplicationContext();
  if (wac == null) {
    String message="Failed to find the root WebApplicationContext. Was ContextLoaderListener not used?";
    logger.error(message);
    throw new IllegalStateException(message);
  }
  Map<String,T> beans=wac.getBeansOfType(endpointClass);
  if (beans.isEmpty()) {
    if (logger.isTraceEnabled()) {
      logger.trace("Creating new @ServerEndpoint instance of type " + endpointClass);
    }
    return wac.getAutowireCapableBeanFactory().createBean(endpointClass);
  }
 else   if (beans.size() == 1) {
    if (logger.isTraceEnabled()) {
      logger.trace("Using @ServerEndpoint singleton " + beans.keySet().iterator().next());
    }
    return beans.values().iterator().next();
  }
 else {
    String message="Found more than one matching @ServerEndpoint beans of type " + endpointClass;
    logger.error(message);
    throw new IllegalStateException(message);
  }
}
