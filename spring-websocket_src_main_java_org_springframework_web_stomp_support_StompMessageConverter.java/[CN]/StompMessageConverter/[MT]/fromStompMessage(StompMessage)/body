{
  ByteArrayOutputStream outputStream=new ByteArrayOutputStream();
  StompHeaders headers=message.getHeaders();
  StompCommand command=message.getCommand();
  try {
    outputStream.write(command.toString().getBytes("UTF-8"));
    outputStream.write(LF);
    for (    Entry<String,List<String>> entry : headers.entrySet()) {
      String key=entry.getKey();
      key=replaceAllOutbound(key);
      for (      String value : entry.getValue()) {
        outputStream.write(key.getBytes("UTF-8"));
        outputStream.write(COLON);
        value=replaceAllOutbound(value);
        outputStream.write(value.getBytes("UTF-8"));
        outputStream.write(LF);
      }
    }
    outputStream.write(LF);
    outputStream.write(message.getPayload());
    outputStream.write(0);
    return outputStream.toByteArray();
  }
 catch (  IOException e) {
    throw new StompException("Failed to serialize " + message,e);
  }
}
