{
  UnitOfWork unitOfWork=session.getActiveUnitOfWork();
  boolean newUnitOfWork=false;
  if (unitOfWork == null) {
    unitOfWork=session.acquireUnitOfWork();
    newUnitOfWork=true;
  }
  try {
    Object result=doInUnitOfWork(unitOfWork);
    if (newUnitOfWork) {
      unitOfWork.commit();
    }
    return result;
  }
  finally {
    if (newUnitOfWork) {
      unitOfWork.release();
    }
  }
}
