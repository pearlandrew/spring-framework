{
  String beanName=transformedBeanName(name);
  Class<?> typeToMatch=(targetType != null ? targetType : Object.class);
  Object beanInstance=getSingleton(beanName,false);
  if (beanInstance != null) {
    if (beanInstance instanceof FactoryBean) {
      if (!BeanFactoryUtils.isFactoryDereference(name)) {
        Class<?> type=getTypeForFactoryBean((FactoryBean<?>)beanInstance);
        return (type != null && ClassUtils.isAssignable(typeToMatch,type));
      }
 else {
        return ClassUtils.isAssignableValue(typeToMatch,beanInstance);
      }
    }
 else {
      return !BeanFactoryUtils.isFactoryDereference(name) && ClassUtils.isAssignableValue(typeToMatch,beanInstance);
    }
  }
 else   if (containsSingleton(beanName) && !containsBeanDefinition(beanName)) {
    return false;
  }
 else {
    BeanFactory parentBeanFactory=getParentBeanFactory();
    if (parentBeanFactory != null && !containsBeanDefinition(beanName)) {
      return parentBeanFactory.isTypeMatch(originalBeanName(name),targetType);
    }
    RootBeanDefinition mbd=getMergedLocalBeanDefinition(beanName);
    Class[] typesToMatch=(FactoryBean.class.equals(typeToMatch) ? new Class[]{typeToMatch} : new Class[]{FactoryBean.class,typeToMatch});
    BeanDefinitionHolder dbd=mbd.getDecoratedDefinition();
    if (dbd != null && !BeanFactoryUtils.isFactoryDereference(name)) {
      RootBeanDefinition tbd=getMergedBeanDefinition(dbd.getBeanName(),dbd.getBeanDefinition(),mbd);
      Class<?> targetClass=predictBeanType(dbd.getBeanName(),tbd,typesToMatch);
      if (targetClass != null && !FactoryBean.class.isAssignableFrom(targetClass)) {
        return typeToMatch.isAssignableFrom(targetClass);
      }
    }
    Class<?> beanType=predictBeanType(beanName,mbd,typesToMatch);
    if (beanType == null) {
      return false;
    }
    if (FactoryBean.class.isAssignableFrom(beanType)) {
      if (!BeanFactoryUtils.isFactoryDereference(name)) {
        beanType=getTypeForFactoryBean(beanName,mbd);
        if (beanType == null) {
          return false;
        }
      }
    }
 else     if (BeanFactoryUtils.isFactoryDereference(name)) {
      beanType=predictBeanType(beanName,mbd,FactoryBean.class);
      if (beanType == null || !FactoryBean.class.isAssignableFrom(beanType)) {
        return false;
      }
    }
    return typeToMatch.isAssignableFrom(beanType);
  }
}
