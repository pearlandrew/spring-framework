{
  template=new JpaTemplate();
  template.setExposeNativeEntityManager(false);
  template.setEntityManagerFactory(factory);
  template.afterPropertiesSet();
  given(factory.createEntityManager()).willReturn(manager);
  given(manager.isOpen()).willReturn(true);
  manager.close();
  template.execute(new JpaCallback(){
    @Override public Object doInJpa(    EntityManager em) throws PersistenceException {
      assertSame(em,manager);
      return null;
    }
  }
,true);
}
