{
  template.setExposeNativeEntityManager(false);
  template.setEntityManagerFactory(factory);
  template.afterPropertiesSet();
  TransactionSynchronizationManager.bindResource(factory,new EntityManagerHolder(manager));
  try {
    template.execute(new JpaCallback(){
      @Override public Object doInJpa(      EntityManager em) throws PersistenceException {
        assertSame(em,manager);
        return null;
      }
    }
,true);
  }
  finally {
    TransactionSynchronizationManager.unbindResource(factory);
  }
}
