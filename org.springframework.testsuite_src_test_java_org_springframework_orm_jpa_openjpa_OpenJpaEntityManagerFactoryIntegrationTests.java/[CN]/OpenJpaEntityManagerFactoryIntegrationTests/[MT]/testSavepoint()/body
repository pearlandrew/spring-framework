{
  TransactionTemplate tt=new TransactionTemplate(transactionManager);
  tt.setPropagationBehavior(TransactionTemplate.PROPAGATION_NESTED);
  tt.execute(new TransactionCallbackWithoutResult(){
    protected void doInTransactionWithoutResult(    TransactionStatus status){
      Person tony=new Person();
      tony.setFirstName("Tony");
      sharedEntityManager.merge(tony);
      Query q=sharedEntityManager.createQuery("select p from Person as p");
      q.setFlushMode(FlushModeType.COMMIT);
      List<Person> people=q.getResultList();
      assertEquals(1,people.size());
      assertEquals("Tony",people.get(0).getFirstName());
      status.setRollbackOnly();
    }
  }
);
  Query q=sharedEntityManager.createQuery("select p from Person as p");
  List<Person> people=q.getResultList();
  assertEquals(0,people.size());
}
