{
  AsyncTaskExecutor executor=this.executors.get(method);
  if (executor == null) {
    Executor executorToUse=this.defaultExecutor;
    String qualifier=getExecutorQualifier(method);
    if (StringUtils.hasLength(qualifier)) {
      Assert.notNull(this.beanFactory,"BeanFactory must be set on " + getClass().getSimpleName() + " to access qualified executor '"+ qualifier+ "'");
      executorToUse=BeanFactoryAnnotationUtils.qualifiedBeanOfType(this.beanFactory,Executor.class,qualifier);
    }
 else     if (executorToUse == null) {
      throw new IllegalStateException("No executor qualifier specified and no default executor set on " + getClass().getSimpleName() + " either");
    }
    executor=(executorToUse instanceof AsyncTaskExecutor ? (AsyncTaskExecutor)executorToUse : new TaskExecutorAdapter(executorToUse));
    this.executors.put(method,executor);
  }
  return executor;
}
