{
  HttpServletRequest request=createMock(HttpServletRequest.class);
  expect(request.getAttribute(AsyncExecutionChain.CALLABLE_CHAIN_ATTRIBUTE)).andReturn(null);
  request.setAttribute(same(AsyncExecutionChain.CALLABLE_CHAIN_ATTRIBUTE),notNull());
  expect(request.getCharacterEncoding()).andReturn(null);
  request.setCharacterEncoding(ENCODING);
  expect(request.getAttribute(FILTER_NAME + OncePerRequestFilter.ALREADY_FILTERED_SUFFIX)).andReturn(null);
  request.setAttribute(FILTER_NAME + OncePerRequestFilter.ALREADY_FILTERED_SUFFIX,Boolean.TRUE);
  request.removeAttribute(FILTER_NAME + OncePerRequestFilter.ALREADY_FILTERED_SUFFIX);
  replay(request);
  MockHttpServletResponse response=new MockHttpServletResponse();
  FilterChain filterChain=createMock(FilterChain.class);
  filterChain.doFilter(request,response);
  replay(filterChain);
  CharacterEncodingFilter filter=new CharacterEncodingFilter();
  filter.setEncoding(ENCODING);
  filter.setBeanName(FILTER_NAME);
  filter.setServletContext(new MockServletContext());
  filter.doFilter(request,response,filterChain);
  verify(request);
  verify(filterChain);
}
