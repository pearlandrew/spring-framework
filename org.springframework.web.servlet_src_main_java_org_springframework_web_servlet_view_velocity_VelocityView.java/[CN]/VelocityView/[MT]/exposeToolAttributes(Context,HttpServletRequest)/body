{
  if (this.toolAttributes != null) {
    for (    Map.Entry<String,Class> entry : this.toolAttributes.entrySet()) {
      String attributeName=entry.getKey();
      Class toolClass=entry.getValue();
      try {
        Object tool=toolClass.newInstance();
        initTool(tool,velocityContext);
        velocityContext.put(attributeName,tool);
      }
 catch (      Exception ex) {
        throw new NestedServletException("Could not instantiate Velocity tool '" + attributeName + "'",ex);
      }
    }
  }
  if (this.dateToolAttribute != null || this.numberToolAttribute != null) {
    Locale locale=RequestContextUtils.getLocale(request);
    if (this.dateToolAttribute != null) {
      velocityContext.put(this.dateToolAttribute,new LocaleAwareDateTool(locale));
    }
    if (this.numberToolAttribute != null) {
      velocityContext.put(this.numberToolAttribute,new LocaleAwareNumberTool(locale));
    }
  }
}
