{
  if (logger.isTraceEnabled()) {
    logger.trace("Getting resource URL for requestURL=" + requestUrl);
  }
  String pathWithinMapping=(String)request.getAttribute(HandlerMapping.PATH_WITHIN_HANDLER_MAPPING_ATTRIBUTE);
  if (pathWithinMapping == null) {
    logger.trace("Request attribute with lookup path not found, calculating instead.");
    pathWithinMapping=getPathHelper().getLookupPathForRequest(request);
  }
  int index=getPathHelper().getRequestUri(request).indexOf(pathWithinMapping);
  Assert.state(index != -1,"Failed to determine lookup path: " + requestUrl);
  String prefix=requestUrl.substring(0,index);
  String lookupPath=requestUrl.substring(index);
  String resolvedPath=getForLookupPath(lookupPath);
  return (resolvedPath != null) ? prefix + resolvedPath : null;
}
