{
  MediaType contentType=getContentType(form);
  Charset charset=contentType.getCharSet() != null ? contentType.getCharSet() : DEFAULT_CHARSET;
  StringBuilder builder=new StringBuilder();
  for (Iterator<Map.Entry<String,List<String>>> entryIterator=form.entrySet().iterator(); entryIterator.hasNext(); ) {
    Map.Entry<String,List<String>> entry=entryIterator.next();
    String name=entry.getKey();
    for (Iterator<String> valueIterator=entry.getValue().iterator(); valueIterator.hasNext(); ) {
      String value=valueIterator.next();
      builder.append(URLEncoder.encode(name,charset.name()));
      if (value != null) {
        builder.append('=');
        builder.append(URLEncoder.encode(value,charset.name()));
        if (valueIterator.hasNext()) {
          builder.append('&');
        }
      }
    }
    if (entryIterator.hasNext()) {
      builder.append('&');
    }
  }
  FileCopyUtils.copy(builder.toString(),new OutputStreamWriter(outputMessage.getBody(),charset));
}
