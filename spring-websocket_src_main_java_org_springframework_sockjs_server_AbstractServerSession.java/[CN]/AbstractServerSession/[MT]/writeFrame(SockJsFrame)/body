{
  if (logger.isTraceEnabled()) {
    logger.trace("Preparing to write " + frame);
  }
  try {
    writeFrameInternal(frame);
  }
 catch (  IOException ex) {
    if (ex instanceof EOFException || ex instanceof SocketException) {
      logger.warn("Client went away. Terminating connection");
    }
 else {
      logger.warn("Failed to send message. Terminating connection: " + ex.getMessage());
    }
    deactivate();
    close();
    throw ex;
  }
catch (  Throwable t) {
    logger.warn("Failed to send message. Terminating connection: " + t.getMessage());
    deactivate();
    close();
    throw new NestedSockJsRuntimeException("Failed to write frame " + frame,t);
  }
}
