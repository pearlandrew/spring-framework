{
  ConsumerCacheKey cacheKey=new ConsumerCacheKey(dest,selector,noLocal,subscription,durable);
  MessageConsumer consumer=this.cachedConsumers.get(cacheKey);
  if (consumer != null) {
    if (logger.isTraceEnabled()) {
      logger.trace("Found cached JMS MessageConsumer for destination [" + dest + "]: "+ consumer);
    }
  }
 else {
    if (dest instanceof Topic) {
      if (noLocal == null) {
        Method method=(durable ? createSharedDurableConsumerMethod : createSharedConsumerMethod);
        try {
          consumer=(MessageConsumer)method.invoke(this.target,dest,subscription,selector);
        }
 catch (        InvocationTargetException ex) {
          if (ex.getTargetException() instanceof JMSException) {
            throw (JMSException)ex.getTargetException();
          }
          ReflectionUtils.handleInvocationTargetException(ex);
        }
catch (        IllegalAccessException ex) {
          throw new IllegalStateException("Could not access JMS 2.0 API method: " + ex.getMessage());
        }
      }
 else {
        consumer=(durable ? this.target.createDurableSubscriber((Topic)dest,subscription,selector,noLocal) : this.target.createConsumer(dest,selector,noLocal));
      }
    }
 else {
      consumer=this.target.createConsumer(dest,selector);
    }
    if (logger.isDebugEnabled()) {
      logger.debug("Registering cached JMS MessageConsumer for destination [" + dest + "]: "+ consumer);
    }
    this.cachedConsumers.put(cacheKey,consumer);
  }
  return new CachedMessageConsumer(consumer);
}
