{
  boolean isAsyncDispatch=isAsyncDispatch(request);
  if (isIncludePayload()) {
    if (isAsyncDispatch) {
      request=WebUtils.getNativeRequest(request,RequestCachingRequestWrapper.class);
      Assert.notNull(request,"Expected wrapped request");
    }
 else {
      request=new RequestCachingRequestWrapper(request);
    }
  }
  if (!isAsyncDispatch) {
    beforeRequest(request,getBeforeMessage(request));
  }
  try {
    filterChain.doFilter(request,response);
  }
  finally {
    if (isLastRequestThread(request)) {
      afterRequest(request,getAfterMessage(request));
    }
  }
}
