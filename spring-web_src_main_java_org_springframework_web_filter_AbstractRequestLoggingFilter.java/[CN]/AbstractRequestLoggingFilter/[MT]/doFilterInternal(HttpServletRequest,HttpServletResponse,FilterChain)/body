{
  WebAsyncManager asyncManager=WebAsyncUtils.getAsyncManager(request);
  boolean isFirstRequest=!asyncManager.hasConcurrentResult();
  if (isIncludePayload()) {
    if (isFirstRequest) {
      request=new RequestCachingRequestWrapper(request);
    }
  }
  if (isFirstRequest) {
    beforeRequest(request,getBeforeMessage(request));
  }
  try {
    filterChain.doFilter(request,response);
  }
  finally {
    if (!asyncManager.isConcurrentHandlingStarted()) {
      afterRequest(request,getAfterMessage(request));
    }
  }
}
