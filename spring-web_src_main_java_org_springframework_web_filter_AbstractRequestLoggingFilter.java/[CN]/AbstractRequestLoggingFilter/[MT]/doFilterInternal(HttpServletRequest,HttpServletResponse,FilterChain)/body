{
  boolean isFirstRequest=!isAsyncDispatch(request);
  if (isIncludePayload()) {
    if (isFirstRequest) {
      request=new RequestCachingRequestWrapper(request);
    }
  }
  if (isFirstRequest) {
    beforeRequest(request,getBeforeMessage(request));
  }
  try {
    filterChain.doFilter(request,response);
  }
  finally {
    if (isLastRequestThread(request)) {
      afterRequest(request,getAfterMessage(request));
    }
  }
}
