{
  byte[] boundary=generateBoundary();
  HttpHeaders headers=outputMessage.getHeaders();
  MediaType contentType=headers.getContentType();
  if (contentType != null) {
    String boundaryString=new String(boundary,"US-ASCII");
    Map<String,String> params=Collections.singletonMap("boundary",boundaryString);
    contentType=new MediaType(contentType.getType(),contentType.getSubtype(),params);
    headers.setContentType(contentType);
  }
  OutputStream os=outputMessage.getBody();
  for (  Map.Entry<String,List<Part>> entry : map.entrySet()) {
    String name=entry.getKey();
    for (    Part part : entry.getValue()) {
      part.write(boundary,name,os);
    }
  }
  os.write('-');
  os.write('-');
  os.write(boundary);
  os.write('-');
  os.write('-');
  os.write('\r');
  os.write('\n');
}
