{
  MultipartMap body=new MultipartMap();
  body.addTextPart("name 1","value 1");
  body.addTextPart("name 2","value 2+1");
  body.addTextPart("name 2","value 2+2");
  Resource logo=new ClassPathResource("/org/springframework/http/converter/logo.jpg");
  body.addBinaryPart("logo",logo);
  byte[] xml="<root><child/></root>".getBytes("UTF-8");
  body.addPart("xml",xml,new MediaType("application","xml"));
  MockHttpOutputMessage outputMessage=new MockHttpOutputMessage();
  converter.write(body,null,outputMessage);
  final MediaType contentType=outputMessage.getHeaders().getContentType();
  final byte[] result=outputMessage.getBodyAsBytes();
  assertNotNull(contentType);
  assertNotNull(contentType.getParameter("boundary"));
  FileItemFactory fileItemFactory=new DiskFileItemFactory();
  FileUpload fileUpload=new FileUpload(fileItemFactory);
  List items=fileUpload.parseRequest(new RequestContext(){
    public String getCharacterEncoding(){
      return null;
    }
    public String getContentType(){
      return contentType.toString();
    }
    public int getContentLength(){
      return result.length;
    }
    public InputStream getInputStream() throws IOException {
      return new ByteArrayInputStream(result);
    }
  }
);
  assertEquals(5,items.size());
  FileItem item=(FileItem)items.get(0);
  assertTrue(item.isFormField());
  assertEquals("name 1",item.getFieldName());
  assertEquals("value 1",item.getString());
  item=(FileItem)items.get(1);
  assertTrue(item.isFormField());
  assertEquals("name 2",item.getFieldName());
  assertEquals("value 2+1",item.getString());
  item=(FileItem)items.get(2);
  assertTrue(item.isFormField());
  assertEquals("name 2",item.getFieldName());
  assertEquals("value 2+2",item.getString());
  item=(FileItem)items.get(3);
  assertFalse(item.isFormField());
  assertEquals("logo",item.getFieldName());
  assertEquals("logo.jpg",item.getName());
  assertEquals("application/octet-stream",item.getContentType());
  assertEquals(logo.getFile().length(),item.getSize());
  item=(FileItem)items.get(4);
  assertEquals("xml",item.getFieldName());
  assertEquals("application/xml",item.getContentType());
  assertEquals(xml.length,item.getSize());
}
