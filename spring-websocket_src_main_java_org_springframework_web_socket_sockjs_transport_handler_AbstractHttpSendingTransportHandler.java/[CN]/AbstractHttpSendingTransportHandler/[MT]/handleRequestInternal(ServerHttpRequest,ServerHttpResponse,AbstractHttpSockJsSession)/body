{
  if (sockJsSession.isNew()) {
    logger.debug("Opening " + getTransportType() + " connection");
    sockJsSession.setInitialRequest(request,response,getFrameFormat(request));
  }
 else   if (!sockJsSession.isActive()) {
    logger.debug("starting " + getTransportType() + " async request");
    sockJsSession.setLongPollingRequest(request,response,getFrameFormat(request));
  }
 else {
    try {
      logger.debug("another " + getTransportType() + " connection still open: "+ sockJsSession);
      SockJsFrame closeFrame=SockJsFrame.closeFrameAnotherConnectionOpen();
      response.getBody().write(getFrameFormat(request).format(closeFrame).getContentBytes());
    }
 catch (    IOException e) {
      throw new SockJsProcessingException("Failed to send SockJS close frame",e,sockJsSession.getId());
    }
  }
}
