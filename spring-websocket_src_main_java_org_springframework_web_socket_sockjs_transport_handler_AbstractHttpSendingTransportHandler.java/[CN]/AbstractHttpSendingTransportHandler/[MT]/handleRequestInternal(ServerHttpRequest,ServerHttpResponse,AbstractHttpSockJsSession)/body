{
  if (sockJsSession.isNew()) {
    logger.debug("Opening " + getTransportType() + " connection");
    sockJsSession.handleInitialRequest(request,response,getFrameFormat(request));
  }
 else   if (sockJsSession.isClosed()) {
    logger.debug("Connection already closed (but not removed yet)");
    SockJsFrame frame=SockJsFrame.closeFrameGoAway();
    try {
      response.getBody().write(frame.getContentBytes());
    }
 catch (    IOException ex) {
      throw new SockJsException("Failed to send " + frame,sockJsSession.getId(),ex);
    }
    return;
  }
 else   if (!sockJsSession.isActive()) {
    logger.debug("starting " + getTransportType() + " async request");
    sockJsSession.handleSuccessiveRequest(request,response,getFrameFormat(request));
  }
 else {
    logger.debug("another " + getTransportType() + " connection still open: "+ sockJsSession);
    SockJsFrame frame=getFrameFormat(request).format(SockJsFrame.closeFrameAnotherConnectionOpen());
    try {
      response.getBody().write(frame.getContentBytes());
    }
 catch (    IOException ex) {
      throw new SockJsException("Failed to send " + frame,sockJsSession.getId(),ex);
    }
  }
}
