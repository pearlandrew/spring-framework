{
  WebApplicationContext ac=initApplicationContext(WebApplicationContext.SCOPE_GLOBAL_SESSION);
  MockRenderRequest request=new MockRenderRequest();
  PortletRequestAttributes requestAttributes=new PortletRequestAttributes(request);
  RequestContextHolder.setRequestAttributes(requestAttributes);
  try {
    assertNull(request.getPortletSession().getAttribute(NAME,PortletSession.APPLICATION_SCOPE));
    DerivedTestBean bean=ac.getBean(NAME,DerivedTestBean.class);
    assertSame(bean,request.getPortletSession().getAttribute(NAME,PortletSession.APPLICATION_SCOPE));
    assertSame(bean,ac.getBean(NAME));
    request.getPortletSession().invalidate();
    assertTrue(bean.wasDestroyed());
  }
  finally {
    RequestContextHolder.setRequestAttributes(null);
  }
}
