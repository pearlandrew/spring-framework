{
  InvocableMessageHandlerMethod exceptionHandlerMethod;
  Class<?> beanType=handlerMethod.getBeanType();
  MessageExceptionHandlerMethodResolver resolver=this.exceptionHandlerCache.get(beanType);
  if (resolver == null) {
    resolver=new MessageExceptionHandlerMethodResolver(beanType);
    this.exceptionHandlerCache.put(beanType,resolver);
  }
  Method method=resolver.resolveMethod(ex);
  if (method == null) {
    logger.error("Unhandled exception",ex);
    return;
  }
  exceptionHandlerMethod=new InvocableMessageHandlerMethod(handlerMethod.getBean(),method);
  exceptionHandlerMethod.setMessageMethodArgumentResolvers(this.argumentResolvers);
  try {
    Object returnValue=exceptionHandlerMethod.invoke(message,ex);
    MethodParameter returnType=exceptionHandlerMethod.getReturnType();
    if (void.class.equals(returnType.getParameterType())) {
      return;
    }
    this.returnValueHandlers.handleReturnValue(returnValue,returnType,message);
  }
 catch (  Throwable t) {
    logger.error("Error while handling exception",t);
    return;
  }
}
