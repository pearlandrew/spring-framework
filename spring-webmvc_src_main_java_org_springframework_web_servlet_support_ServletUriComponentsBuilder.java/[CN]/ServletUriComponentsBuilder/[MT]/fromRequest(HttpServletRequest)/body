{
  String scheme=request.getScheme();
  String host=request.getServerName();
  int port=request.getServerPort();
  String path=request.getRequestURI();
  String hostHeader=request.getHeader("X-Forwarded-Host");
  if (StringUtils.hasText(hostHeader)) {
    String[] hosts=StringUtils.commaDelimitedListToStringArray(hostHeader);
    String hostToUse=hosts[0];
    if (hostToUse.contains(":")) {
      String[] hostAndPort=StringUtils.split(hostToUse,":");
      host=hostAndPort[0];
      port=Integer.parseInt(hostAndPort[1]);
    }
 else {
      host=hostToUse;
      port=-1;
    }
  }
  String portHeader=request.getHeader("X-Forwarded-Port");
  if (StringUtils.hasText(portHeader)) {
    port=Integer.parseInt(portHeader);
  }
  String protocolHeader=request.getHeader("X-Forwarded-Proto");
  if (StringUtils.hasText(protocolHeader)) {
    scheme=protocolHeader;
  }
  String prefix=request.getHeader("X-Forwarded-Prefix");
  if (StringUtils.hasText(prefix)) {
    path=prefix + path;
  }
  ServletUriComponentsBuilder builder=new ServletUriComponentsBuilder();
  builder.scheme(scheme);
  builder.host(host);
  if (scheme.equals("http") && port != 80 || scheme.equals("https") && port != 443) {
    builder.port(port);
  }
  builder.initPath(path);
  builder.query(request.getQueryString());
  return builder;
}
