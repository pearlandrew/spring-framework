{
  String scheme=request.getScheme();
  int port=request.getServerPort();
  String host=request.getServerName();
  String xForwardedHostHeader=request.getHeader("X-Forwarded-Host");
  if (StringUtils.hasText(xForwardedHostHeader)) {
    if (StringUtils.countOccurrencesOf(xForwardedHostHeader,":") == 1) {
      String[] hostAndPort=StringUtils.split(xForwardedHostHeader,":");
      host=hostAndPort[0];
      port=Integer.parseInt(hostAndPort[1]);
    }
 else {
      host=xForwardedHostHeader;
    }
  }
  ServletUriComponentsBuilder builder=new ServletUriComponentsBuilder();
  builder.scheme(scheme);
  builder.host(host);
  if ((scheme.equals("http") && port != 80) || (scheme.equals("https") && port != 443)) {
    builder.port(port);
  }
  builder.pathFromRequest(request);
  builder.query(request.getQueryString());
  return builder;
}
