{
  final String subscriptionId=message.getHeaders().getId();
  String replyToKey=getSubscriptionReplyKey(session,subscriptionId);
  if (logger.isTraceEnabled()) {
    logger.trace("Adding subscription, key=" + replyToKey);
  }
  Registration<?> registration=this.reactor.on(Fn.$(replyToKey),new Consumer<Event<StompMessage>>(){
    @Override public void accept(    Event<StompMessage> event){
      event.getData().getHeaders().setSubscription(subscriptionId);
      try {
        session.sendMessage(event.getData());
      }
 catch (      Throwable t) {
        handleError(session,t);
      }
    }
  }
);
  addRegistration(session.getId(),registration);
  this.reactor.notify(StompCommand.SUBSCRIBE,Fn.event(message,replyToKey));
}
