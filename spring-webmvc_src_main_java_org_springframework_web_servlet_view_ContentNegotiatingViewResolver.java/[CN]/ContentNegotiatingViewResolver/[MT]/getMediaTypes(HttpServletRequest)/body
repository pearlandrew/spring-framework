{
  try {
    ServletWebRequest webRequest=new ServletWebRequest(request);
    List<MediaType> acceptableMediaTypes=this.contentNegotiationManager.resolveMediaTypes(webRequest);
    List<MediaType> producibleMediaTypes=getProducibleMediaTypes(request);
    Set<MediaType> compatibleMediaTypes=new LinkedHashSet<MediaType>();
    for (    MediaType acceptable : acceptableMediaTypes) {
      for (      MediaType producible : producibleMediaTypes) {
        if (acceptable.isCompatibleWith(producible)) {
          compatibleMediaTypes.add(getMostSpecificMediaType(acceptable,producible));
        }
      }
    }
    List<MediaType> selectedMediaTypes=new ArrayList<MediaType>(compatibleMediaTypes);
    MediaType.sortBySpecificityAndQuality(selectedMediaTypes);
    if (logger.isDebugEnabled()) {
      logger.debug("Requested media types are " + selectedMediaTypes + " based on Accept header types "+ "and producible media types "+ producibleMediaTypes+ ")");
    }
    return selectedMediaTypes;
  }
 catch (  HttpMediaTypeNotAcceptableException ex) {
    return null;
  }
}
