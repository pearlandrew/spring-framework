{
  String extension=StringUtils.getFilenameExtension(filename);
  if (!StringUtils.hasText(extension)) {
    return null;
  }
  extension=extension.toLowerCase(Locale.ENGLISH);
  MediaType mediaType=this.mediaTypes.get(extension);
  if (mediaType == null) {
    String mimeType=getServletContext().getMimeType(filename);
    if (StringUtils.hasText(mimeType)) {
      mediaType=MediaType.parseMediaType(mimeType);
    }
    if (this.useJaf && (mediaType == null || MediaType.APPLICATION_OCTET_STREAM.equals(mediaType))) {
      MediaType jafMediaType=ActivationMediaTypeFactory.getMediaType(filename);
      if (jafMediaType != null && !MediaType.APPLICATION_OCTET_STREAM.equals(jafMediaType)) {
        mediaType=jafMediaType;
      }
    }
    if (mediaType != null) {
      this.mediaTypes.putIfAbsent(extension,mediaType);
    }
  }
  return mediaType;
}
