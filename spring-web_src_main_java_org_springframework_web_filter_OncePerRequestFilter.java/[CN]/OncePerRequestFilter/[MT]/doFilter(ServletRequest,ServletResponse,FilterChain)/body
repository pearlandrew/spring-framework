{
  if (!(request instanceof HttpServletRequest) || !(response instanceof HttpServletResponse)) {
    throw new ServletException("OncePerRequestFilter just supports HTTP requests");
  }
  HttpServletRequest httpRequest=(HttpServletRequest)request;
  HttpServletResponse httpResponse=(HttpServletResponse)response;
  WebAsyncManager asyncManager=WebAsyncUtils.getAsyncManager(request);
  boolean processAsyncDispatch=asyncManager.hasConcurrentResult() && !shouldNotFilterAsyncDispatch();
  String alreadyFilteredAttributeName=getAlreadyFilteredAttributeName();
  boolean hasAlreadyFilteredAttribute=request.getAttribute(alreadyFilteredAttributeName) != null;
  if ((hasAlreadyFilteredAttribute && (!processAsyncDispatch)) || shouldNotFilter(httpRequest)) {
    filterChain.doFilter(request,response);
  }
 else {
    request.setAttribute(alreadyFilteredAttributeName,Boolean.TRUE);
    try {
      doFilterInternal(httpRequest,httpResponse,filterChain);
    }
  finally {
      if (!asyncManager.isConcurrentHandlingStarted()) {
        request.removeAttribute(alreadyFilteredAttributeName);
      }
    }
  }
}
