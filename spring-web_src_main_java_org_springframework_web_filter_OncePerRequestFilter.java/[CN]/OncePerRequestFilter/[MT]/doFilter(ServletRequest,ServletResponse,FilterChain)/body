{
  if (!(request instanceof HttpServletRequest) || !(response instanceof HttpServletResponse)) {
    throw new ServletException("OncePerRequestFilter just supports HTTP requests");
  }
  HttpServletRequest httpRequest=(HttpServletRequest)request;
  HttpServletResponse httpResponse=(HttpServletResponse)response;
  String alreadyFilteredAttributeName=getAlreadyFilteredAttributeName();
  if (request.getAttribute(alreadyFilteredAttributeName) != null || shouldNotFilter(httpRequest)) {
    filterChain.doFilter(request,response);
  }
 else {
    AsyncExecutionChain chain=AsyncExecutionChain.getForCurrentRequest(request);
    chain.push(getAsyncCallable(request,alreadyFilteredAttributeName));
    request.setAttribute(alreadyFilteredAttributeName,Boolean.TRUE);
    try {
      doFilterInternal(httpRequest,httpResponse,filterChain);
    }
  finally {
      if (!chain.pop()) {
        return;
      }
      request.removeAttribute(alreadyFilteredAttributeName);
    }
  }
}
