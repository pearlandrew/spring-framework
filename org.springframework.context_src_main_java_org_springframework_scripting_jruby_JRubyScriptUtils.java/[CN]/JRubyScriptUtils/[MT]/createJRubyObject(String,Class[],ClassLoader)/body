{
  Ruby ruby=initializeRuntime();
  Node scriptRootNode=(oldParseMethod != null ? (Node)ReflectionUtils.invokeMethod(oldParseMethod,ruby,new Object[]{scriptSource,"",null}) : ruby.parse(scriptSource,"",null,0));
  IRubyObject rubyObject=ruby.eval(scriptRootNode);
  if (rubyObject instanceof RubyNil) {
    String className=findClassName(scriptRootNode);
    rubyObject=ruby.evalScript("\n" + className + ".new");
  }
  if (rubyObject instanceof RubyNil) {
    throw new IllegalStateException("Compilation of JRuby script returned RubyNil: " + rubyObject);
  }
  return Proxy.newProxyInstance(classLoader,interfaces,new RubyObjectInvocationHandler(rubyObject,ruby));
}
