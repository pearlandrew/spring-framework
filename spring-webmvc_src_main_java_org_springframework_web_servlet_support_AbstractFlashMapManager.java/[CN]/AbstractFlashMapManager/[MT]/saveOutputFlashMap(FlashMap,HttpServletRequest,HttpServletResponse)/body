{
  if (CollectionUtils.isEmpty(flashMap)) {
    return;
  }
  String path=decodeAndNormalizePath(flashMap.getTargetRequestPath(),request);
  flashMap.setTargetRequestPath(path);
  if (logger.isDebugEnabled()) {
    logger.debug("Saving FlashMap=" + flashMap);
  }
  flashMap.startExpirationPeriod(getFlashMapTimeout());
  Object mutex=getFlashMapsMutex(request);
  if (mutex != null) {
synchronized (mutex) {
      List<FlashMap> allFlashMaps=retrieveFlashMaps(request);
      allFlashMaps=(allFlashMaps != null ? allFlashMaps : new CopyOnWriteArrayList<FlashMap>());
      allFlashMaps.add(flashMap);
      updateFlashMaps(allFlashMaps,request,response);
    }
  }
 else {
    List<FlashMap> allFlashMaps=retrieveFlashMaps(request);
    allFlashMaps=(allFlashMaps != null ? allFlashMaps : new LinkedList<FlashMap>());
    allFlashMaps.add(flashMap);
    updateFlashMaps(allFlashMaps,request,response);
  }
}
