{
  if (TransactionSynchronizationManager.hasResource(getPersistenceManagerFactory())) {
    String participateAttributeName=getParticipateAttributeName();
    Integer count=(Integer)request.getAttribute(participateAttributeName,WebRequest.SCOPE_REQUEST);
    int newCount=(count != null) ? count.intValue() + 1 : 1;
    request.setAttribute(getParticipateAttributeName(),new Integer(newCount),WebRequest.SCOPE_REQUEST);
  }
 else {
    logger.debug("Opening JDO PersistenceManager in OpenPersistenceManagerInViewInterceptor");
    PersistenceManager pm=PersistenceManagerFactoryUtils.getPersistenceManager(getPersistenceManagerFactory(),true);
    TransactionSynchronizationManager.bindResource(getPersistenceManagerFactory(),new PersistenceManagerHolder(pm));
  }
}
