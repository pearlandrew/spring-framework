{
  String participateAttributeName=getParticipateAttributeName();
  Integer count=(Integer)request.getAttribute(participateAttributeName,WebRequest.SCOPE_REQUEST);
  if (count != null) {
    if (count.intValue() > 1) {
      request.setAttribute(participateAttributeName,new Integer(count.intValue() - 1),WebRequest.SCOPE_REQUEST);
    }
 else {
      request.removeAttribute(participateAttributeName,WebRequest.SCOPE_REQUEST);
    }
  }
 else {
    PersistenceManagerHolder pmHolder=(PersistenceManagerHolder)TransactionSynchronizationManager.unbindResource(getPersistenceManagerFactory());
    logger.debug("Closing JDO PersistenceManager in OpenPersistenceManagerInViewInterceptor");
    PersistenceManagerFactoryUtils.releasePersistenceManager(pmHolder.getPersistenceManager(),getPersistenceManagerFactory());
  }
}
