{
  HttpServletRequest servletRequest=getHttpServletRequest(request);
  HttpServletResponse servletResponse=getHttpServletResponse(response);
  final ServletWebSocketHttpExchange exchange=createHttpExchange(servletRequest,servletResponse);
  exchange.putAttachment(HandshakeUtil.PATH_PARAMS,Collections.<String,String>emptyMap());
  ServerWebSocketContainer wsContainer=(ServerWebSocketContainer)getContainer(servletRequest);
  final EndpointSessionHandler endpointSessionHandler=new EndpointSessionHandler(wsContainer);
  final ConfiguredServerEndpoint configuredServerEndpoint=createConfiguredServerEndpoint(selectedProtocol,selectedExtensions,endpoint,servletRequest);
  final Handshake handshake=getHandshakeToUse(exchange,configuredServerEndpoint);
  exchange.upgradeChannel(new HttpUpgradeListener(){
    @Override public void handleUpgrade(    StreamConnection connection,    HttpServerExchange serverExchange){
      Object bufferPool=ReflectionUtils.invokeMethod(getBufferPoolMethod,exchange);
      WebSocketChannel channel=(WebSocketChannel)ReflectionUtils.invokeMethod(createChannelMethod,handshake,exchange,connection,bufferPool);
      if (peerConnections != null) {
        peerConnections.add(channel);
      }
      endpointSessionHandler.onConnect(exchange,channel);
    }
  }
);
  handshake.handshake(exchange);
}
