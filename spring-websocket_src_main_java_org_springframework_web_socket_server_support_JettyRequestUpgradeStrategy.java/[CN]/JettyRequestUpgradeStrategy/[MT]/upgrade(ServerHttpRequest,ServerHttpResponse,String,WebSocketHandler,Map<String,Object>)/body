{
  Assert.isInstanceOf(ServletServerHttpRequest.class,request);
  HttpServletRequest servletRequest=((ServletServerHttpRequest)request).getServletRequest();
  Assert.isInstanceOf(ServletServerHttpResponse.class,response);
  HttpServletResponse servletResponse=((ServletServerHttpResponse)response).getServletResponse();
  if (!this.factory.isUpgradeRequest(servletRequest,servletResponse)) {
    throw new HandshakeFailureException("Not a WebSocket request");
  }
  JettyWebSocketSession wsSession=new JettyWebSocketSession(request.getPrincipal(),attrs);
  JettyWebSocketHandlerAdapter wsListener=new JettyWebSocketHandlerAdapter(wsHandler,wsSession);
  servletRequest.setAttribute(WEBSOCKET_LISTENER_ATTR_NAME,wsListener);
  if (!this.factory.acceptWebSocket(servletRequest,servletResponse)) {
    throw new HandshakeFailureException("WebSocket request not accepted by Jetty");
  }
}
