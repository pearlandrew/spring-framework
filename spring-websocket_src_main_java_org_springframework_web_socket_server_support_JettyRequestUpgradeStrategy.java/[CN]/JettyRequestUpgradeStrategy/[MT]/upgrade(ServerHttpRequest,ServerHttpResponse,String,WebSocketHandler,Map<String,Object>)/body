{
  Assert.isInstanceOf(ServletServerHttpRequest.class,request);
  HttpServletRequest servletRequest=((ServletServerHttpRequest)request).getServletRequest();
  Assert.isInstanceOf(ServletServerHttpResponse.class,response);
  HttpServletResponse servletResponse=((ServletServerHttpResponse)response).getServletResponse();
  Assert.isTrue(this.factory.isUpgradeRequest(servletRequest,servletResponse),"Not a WebSocket handshake");
  JettyWebSocketSession session=new JettyWebSocketSession(request.getPrincipal(),attrs);
  JettyWebSocketHandlerAdapter handlerAdapter=new JettyWebSocketHandlerAdapter(wsHandler,session);
  try {
    servletRequest.setAttribute(WS_HANDLER_ATTR_NAME,handlerAdapter);
    this.factory.acceptWebSocket(servletRequest,servletResponse);
  }
 catch (  IOException ex) {
    throw new HandshakeFailureException("Response update failed during upgrade to WebSocket, uri=" + request.getURI(),ex);
  }
 finally {
    servletRequest.removeAttribute(WS_HANDLER_ATTR_NAME);
  }
}
