{
  String destination=headers.getDestination();
  String destinationWithoutPrefix;
  String subscribeDestination;
  String user;
  Set<String> sessionIds;
  Principal principal=headers.getUser();
  SimpMessageType messageType=headers.getMessageType();
  if (SimpMessageType.SUBSCRIBE.equals(messageType) || SimpMessageType.UNSUBSCRIBE.equals(messageType)) {
    if (!checkDestination(destination,this.destinationPrefix)) {
      return null;
    }
    if (principal == null) {
      logger.error("Ignoring message, no principal info available");
      return null;
    }
    if (headers.getSessionId() == null) {
      logger.error("Ignoring message, no session id available");
      return null;
    }
    destinationWithoutPrefix=destination.substring(this.destinationPrefix.length() - 1);
    subscribeDestination=destination;
    user=principal.getName();
    sessionIds=Collections.singleton(headers.getSessionId());
  }
 else   if (SimpMessageType.MESSAGE.equals(messageType)) {
    if (!checkDestination(destination,this.destinationPrefix)) {
      return null;
    }
    int startIndex=this.destinationPrefix.length();
    int endIndex=destination.indexOf('/',startIndex);
    Assert.isTrue(endIndex > 0,"Expected destination pattern \"/principal/{userId}/**\"");
    destinationWithoutPrefix=destination.substring(endIndex);
    subscribeDestination=this.destinationPrefix.substring(0,startIndex - 1) + destinationWithoutPrefix;
    user=destination.substring(startIndex,endIndex);
    user=StringUtils.replace(user,"%2F","/");
    sessionIds=this.userSessionRegistry.getSessionIds(user);
  }
 else {
    if (logger.isTraceEnabled()) {
      logger.trace("Ignoring " + messageType + " message");
    }
    return null;
  }
  return new DestinationInfo(destinationWithoutPrefix,subscribeDestination,user,sessionIds);
}
