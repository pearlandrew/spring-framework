{
  String destination=headers.getDestination();
  String targetUser;
  String targetDestination;
  Set<String> targetSessionIds;
  Principal principal=headers.getUser();
  SimpMessageType messageType=headers.getMessageType();
  if (SimpMessageType.SUBSCRIBE.equals(messageType) || SimpMessageType.UNSUBSCRIBE.equals(messageType)) {
    if (!checkDestination(destination,this.destinationPrefix)) {
      return null;
    }
    if (principal == null) {
      logger.error("Ignoring message, no principal info available");
      return null;
    }
    if (headers.getSessionId() == null) {
      logger.error("Ignoring message, no session id available");
      return null;
    }
    targetUser=principal.getName();
    targetDestination=destination.substring(this.destinationPrefix.length() - 1);
    targetSessionIds=Collections.singleton(headers.getSessionId());
  }
 else   if (SimpMessageType.MESSAGE.equals(messageType)) {
    if (!checkDestination(destination,this.destinationPrefix)) {
      return null;
    }
    int startIndex=this.destinationPrefix.length();
    int endIndex=destination.indexOf('/',startIndex);
    Assert.isTrue(endIndex > 0,"Expected destination pattern \"/principal/{userId}/**\"");
    targetUser=destination.substring(startIndex,endIndex);
    targetDestination=destination.substring(endIndex);
    targetSessionIds=this.userSessionRegistry.getSessionIds(targetUser);
  }
 else {
    if (logger.isTraceEnabled()) {
      logger.trace("Ignoring " + messageType + " message");
    }
    return null;
  }
  return new UserDestinationInfo(targetUser,targetDestination,targetSessionIds);
}
