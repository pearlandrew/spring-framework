{
  int port=SocketUtils.findAvailableTcpPort();
  TestStompBroker stompBroker=new TestStompBroker(port);
  stompBroker.start();
  String sessionId="abc123";
  final CountDownLatch errorLatch=new CountDownLatch(1);
  messageChannel.subscribe(new MessageHandler(){
    @Override public void handleMessage(    Message<?> message) throws MessagingException {
      StompHeaderAccessor headers=StompHeaderAccessor.wrap(message);
      if (headers.getCommand() == StompCommand.ERROR) {
        errorLatch.countDown();
      }
    }
  }
);
  relay.setRelayPort(port);
  relay.start();
  stompBroker.awaitMessages(1);
  stompBroker.stop();
  relay.handleMessage(createConnectMessage(sessionId));
  errorLatch.await(30,TimeUnit.SECONDS);
}
