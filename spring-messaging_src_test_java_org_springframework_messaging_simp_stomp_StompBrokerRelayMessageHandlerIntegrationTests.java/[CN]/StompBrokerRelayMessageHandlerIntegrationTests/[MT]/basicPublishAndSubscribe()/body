{
  String client1SessionId="abc123";
  String client2SessionId="def456";
  final CountDownLatch messageLatch=new CountDownLatch(1);
  this.messageChannel.subscribe(new MessageHandler(){
    @Override public void handleMessage(    Message<?> message) throws MessagingException {
      StompHeaderAccessor headers=StompHeaderAccessor.wrap(message);
      if (headers.getCommand() == StompCommand.MESSAGE) {
        messageLatch.countDown();
      }
    }
  }
);
  this.relay.handleMessage(createConnectMessage(client1SessionId));
  this.relay.handleMessage(createConnectMessage(client2SessionId));
  this.relay.handleMessage(createSubscribeMessage(client1SessionId,"/topic/test"));
  this.stompBroker.awaitMessages(4);
  this.relay.handleMessage(createSendMessage(client2SessionId,"/topic/test","fromClient2"));
  assertTrue(messageLatch.await(30,TimeUnit.SECONDS));
  List<BrokerAvailabilityEvent> availabilityEvents=this.brokerAvailabilityListener.awaitAvailabilityEvents(1);
  assertTrue(availabilityEvents.get(0) instanceof BrokerBecameAvailableEvent);
}
