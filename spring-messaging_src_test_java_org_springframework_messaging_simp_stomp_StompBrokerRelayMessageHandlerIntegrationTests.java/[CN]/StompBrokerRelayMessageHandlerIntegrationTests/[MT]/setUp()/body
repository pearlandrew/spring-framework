{
  int port=SocketUtils.findAvailableTcpPort(61613);
  this.activeMQBroker=new BrokerService();
  this.activeMQBroker.addConnector("stomp://localhost:" + port);
  this.activeMQBroker.setStartAsync(false);
  this.activeMQBroker.setDeleteAllMessagesOnStartup(true);
  this.activeMQBroker.start();
  this.responseChannel=new ExecutorSubscribableChannel();
  this.responseHandler=new ExpectationMatchingMessageHandler();
  this.responseChannel.subscribe(this.responseHandler);
  this.eventPublisher=new ExpectationMatchingEventPublisher();
  this.relay=new StompBrokerRelayMessageHandler(this.responseChannel,Arrays.asList("/queue/","/topic/"));
  this.relay.setRelayPort(port);
  this.relay.setApplicationEventPublisher(this.eventPublisher);
  this.relay.start();
}
