{
  given(factory.createEntityManager()).willReturn(entityManager);
  PersistenceException exception=new PersistenceException();
  willThrow(exception).given(entityManager).flush();
  given(entityManager.isOpen()).willReturn(true);
  JpaInterceptor interceptor=new JpaInterceptor();
  interceptor.setFlushEager(true);
  interceptor.setEntityManagerFactory(factory);
  try {
    interceptor.invoke(new TestInvocation(factory));
  }
 catch (  JpaSystemException ex) {
    assertEquals(exception,ex.getCause());
  }
  verify(entityManager).close();
}
