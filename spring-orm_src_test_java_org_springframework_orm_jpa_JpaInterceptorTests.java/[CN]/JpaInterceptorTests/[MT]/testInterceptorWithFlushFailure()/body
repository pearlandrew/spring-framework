{
  factoryControl.expectAndReturn(factory.createEntityManager(),entityManager);
  entityManager.flush();
  PersistenceException exception=new PersistenceException();
  managerControl.setThrowable(exception,1);
  managerControl.expectAndReturn(entityManager.isOpen(),true);
  entityManager.close();
  factoryControl.replay();
  managerControl.replay();
  JpaInterceptor interceptor=new JpaInterceptor();
  interceptor.setFlushEager(true);
  interceptor.setEntityManagerFactory(factory);
  try {
    interceptor.invoke(new TestInvocation(factory));
  }
 catch (  JpaSystemException ex) {
    assertEquals(exception,ex.getCause());
  }
  factoryControl.verify();
  managerControl.verify();
}
