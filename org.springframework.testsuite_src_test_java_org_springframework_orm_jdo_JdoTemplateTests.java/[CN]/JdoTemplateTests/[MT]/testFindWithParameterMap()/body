{
  MockControl queryControl=MockControl.createControl(Query.class);
  Query query=(Query)queryControl.getMock();
  pmf.getPersistenceManager();
  pmfControl.setReturnValue(pm);
  pm.newQuery(String.class,"a == b");
  pmControl.setReturnValue(query);
  query.declareParameters("params");
  queryControl.setVoidCallable(1);
  Map values=new HashMap();
  Collection coll=new HashSet();
  query.executeWithMap(values);
  queryControl.setReturnValue(coll);
  pm.close();
  pmControl.setVoidCallable(1);
  pmfControl.replay();
  pmControl.replay();
  queryControl.replay();
  JdoTemplate jt=new JdoTemplate(pmf);
  assertEquals(coll,jt.find(String.class,"a == b","params",values));
  queryControl.verify();
}
