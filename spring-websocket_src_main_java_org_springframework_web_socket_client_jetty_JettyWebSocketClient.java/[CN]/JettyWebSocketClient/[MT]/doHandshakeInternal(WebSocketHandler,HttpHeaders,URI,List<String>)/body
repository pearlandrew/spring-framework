{
  ClientUpgradeRequest request=new ClientUpgradeRequest();
  request.setSubProtocols(protocols);
  for (  String header : headers.keySet()) {
    request.setHeader(header,headers.get(header));
  }
  JettyWebSocketSessionAdapter session=new JettyWebSocketSessionAdapter();
  session.setUri(uri);
  session.setRemoteHostName(uri.getHost());
  JettyWebSocketListenerAdapter listener=new JettyWebSocketListenerAdapter(webSocketHandler,session);
  try {
    this.client.connect(listener,uri,request).get();
    return session;
  }
 catch (  Exception e) {
    throw new WebSocketConnectFailureException("Failed to connect to " + uri,e);
  }
}
