{
  try {
    MockControl mockControl=MockControl.createControl(EntityManagerFactory.class);
    EntityManagerFactory factory=(EntityManagerFactory)mockControl.getMock();
    MockControl managerControl=MockControl.createControl(EntityManager.class);
    EntityManager manager=(EntityManager)managerControl.getMock();
    TransactionSynchronizationManager.initSynchronization();
    mockControl.expectAndReturn(factory.createEntityManager(),manager);
    mockControl.replay();
    assertSame(manager,EntityManagerFactoryUtils.doGetTransactionalEntityManager(factory,null));
    assertSame(manager,((EntityManagerHolder)TransactionSynchronizationManager.unbindResource(factory)).getEntityManager());
    mockControl.verify();
  }
  finally {
    TransactionSynchronizationManager.clearSynchronization();
  }
  assertTrue(TransactionSynchronizationManager.getResourceMap().isEmpty());
}
