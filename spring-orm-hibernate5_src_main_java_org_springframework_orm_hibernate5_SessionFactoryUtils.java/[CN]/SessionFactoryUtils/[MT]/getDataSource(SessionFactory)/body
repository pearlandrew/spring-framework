{
  if (sessionFactory instanceof SessionFactoryImplementor) {
    try {
      ConnectionProvider cp=((SessionFactoryImplementor)sessionFactory).getServiceRegistry().getService(ConnectionProvider.class);
      if (cp != null) {
        return cp.unwrap(DataSource.class);
      }
    }
 catch (    UnknownServiceException ex) {
      if (logger.isDebugEnabled()) {
        logger.debug("No ConnectionProvider found - cannot determine DataSource for SessionFactory: " + ex);
      }
    }
  }
  return null;
}
