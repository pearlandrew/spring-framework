{
  if (sessionFactory instanceof SessionFactoryImplementor) {
    SessionFactoryImplementor sfi=(SessionFactoryImplementor)sessionFactory;
    Object dataSourceValue=sfi.getProperties().get(Environment.DATASOURCE);
    if (dataSourceValue instanceof DataSource) {
      return (DataSource)dataSourceValue;
    }
    try {
      ConnectionProvider cp=sfi.getServiceRegistry().getService(ConnectionProvider.class);
      if (cp != null) {
        return cp.unwrap(DataSource.class);
      }
    }
 catch (    UnknownServiceException ex) {
      if (logger.isDebugEnabled()) {
        logger.debug("No ConnectionProvider found - cannot determine DataSource for SessionFactory: " + ex);
      }
    }
  }
  return null;
}
