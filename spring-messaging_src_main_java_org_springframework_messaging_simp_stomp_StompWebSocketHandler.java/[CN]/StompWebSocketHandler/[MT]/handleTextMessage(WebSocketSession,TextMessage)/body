{
  try {
    String payload=textMessage.getPayload();
    Message<?> message=this.stompMessageConverter.toMessage(payload,session.getId());
    if (logger.isTraceEnabled()) {
      logger.trace("Processing STOMP message: " + message);
    }
    try {
      StompHeaderAccessor stompHeaders=StompHeaderAccessor.wrap(message);
      SimpMessageType messageType=stompHeaders.getMessageType();
      if (SimpMessageType.CONNECT.equals(messageType)) {
        handleConnect(session,message);
      }
 else       if (SimpMessageType.MESSAGE.equals(messageType)) {
        handlePublish(message);
      }
 else       if (SimpMessageType.SUBSCRIBE.equals(messageType)) {
        handleSubscribe(message);
      }
 else       if (SimpMessageType.UNSUBSCRIBE.equals(messageType)) {
        handleUnsubscribe(message);
      }
 else       if (SimpMessageType.DISCONNECT.equals(messageType)) {
        handleDisconnect(message);
      }
      this.outputChannel.send(message);
    }
 catch (    Throwable t) {
      logger.error("Terminating STOMP session due to failure to send message: ",t);
      sendErrorMessage(session,t);
    }
  }
 catch (  Throwable error) {
    sendErrorMessage(session,error);
  }
}
