{
  Configuration config=newConfiguration();
  DataSource dataSource=getDataSource();
  if (dataSource != null) {
    configTimeDataSourceHolder.set(dataSource);
  }
  if (this.jtaTransactionManager != null) {
    configTimeTransactionManagerHolder.set(this.jtaTransactionManager);
  }
  if (this.cacheRegionFactory != null) {
    configTimeRegionFactoryHolder.set(this.cacheRegionFactory);
  }
  if (this.cacheProvider != null) {
    configTimeCacheProviderHolder.set(this.cacheProvider);
  }
  if (this.lobHandler != null) {
    configTimeLobHandlerHolder.set(this.lobHandler);
  }
  Thread currentThread=Thread.currentThread();
  ClassLoader threadContextClassLoader=currentThread.getContextClassLoader();
  boolean overrideClassLoader=(this.beanClassLoader != null && !this.beanClassLoader.equals(threadContextClassLoader));
  if (overrideClassLoader) {
    currentThread.setContextClassLoader(this.beanClassLoader);
  }
  try {
    if (isExposeTransactionAwareSessionFactory()) {
      config.setProperty(Environment.CURRENT_SESSION_CONTEXT_CLASS,SpringSessionContext.class.getName());
    }
    if (this.jtaTransactionManager != null) {
      config.setProperty(Environment.TRANSACTION_STRATEGY,JTATransactionFactory.class.getName());
      config.setProperty(Environment.TRANSACTION_MANAGER_STRATEGY,LocalTransactionManagerLookup.class.getName());
    }
 else {
      config.setProperty(Environment.TRANSACTION_STRATEGY,SpringTransactionFactory.class.getName());
    }
    if (this.entityInterceptor != null) {
      config.setInterceptor(this.entityInterceptor);
    }
    if (this.namingStrategy != null) {
      config.setNamingStrategy(this.namingStrategy);
    }
    if (this.typeDefinitions != null) {
      Method createMappings=Configuration.class.getMethod("createMappings");
      Method addTypeDef=createMappings.getReturnType().getMethod("addTypeDef",String.class,String.class,Properties.class);
      Object mappings=ReflectionUtils.invokeMethod(createMappings,config);
      for (      TypeDefinitionBean typeDef : this.typeDefinitions) {
        ReflectionUtils.invokeMethod(addTypeDef,mappings,typeDef.getTypeName(),typeDef.getTypeClass(),typeDef.getParameters());
      }
    }
    if (this.filterDefinitions != null) {
      for (      FilterDefinition filterDef : this.filterDefinitions) {
        config.addFilterDefinition(filterDef);
      }
    }
    if (this.configLocations != null) {
      for (      Resource resource : this.configLocations) {
        config.configure(resource.getURL());
      }
    }
    if (this.hibernateProperties != null) {
      config.addProperties(this.hibernateProperties);
    }
    if (dataSource != null) {
      Class providerClass=LocalDataSourceConnectionProvider.class;
      if (isUseTransactionAwareDataSource() || dataSource instanceof TransactionAwareDataSourceProxy) {
        providerClass=TransactionAwareDataSourceConnectionProvider.class;
      }
 else       if (config.getProperty(Environment.TRANSACTION_MANAGER_STRATEGY) != null) {
        providerClass=LocalJtaDataSourceConnectionProvider.class;
      }
      config.setProperty(Environment.CONNECTION_PROVIDER,providerClass.getName());
    }
    if (this.cacheRegionFactory != null) {
      config.setProperty(Environment.CACHE_REGION_FACTORY,"org.springframework.orm.hibernate3.LocalRegionFactoryProxy");
    }
 else     if (this.cacheProvider != null) {
      config.setProperty(Environment.CACHE_PROVIDER,LocalCacheProviderProxy.class.getName());
    }
    if (this.mappingResources != null) {
      for (      String mapping : this.mappingResources) {
        Resource resource=new ClassPathResource(mapping.trim(),this.beanClassLoader);
        config.addInputStream(resource.getInputStream());
      }
    }
    if (this.mappingLocations != null) {
      for (      Resource resource : this.mappingLocations) {
        config.addInputStream(resource.getInputStream());
      }
    }
    if (this.cacheableMappingLocations != null) {
      for (      Resource resource : this.cacheableMappingLocations) {
        config.addCacheableFile(resource.getFile());
      }
    }
    if (this.mappingJarLocations != null) {
      for (      Resource resource : this.mappingJarLocations) {
        config.addJar(resource.getFile());
      }
    }
    if (this.mappingDirectoryLocations != null) {
      for (      Resource resource : this.mappingDirectoryLocations) {
        File file=resource.getFile();
        if (!file.isDirectory()) {
          throw new IllegalArgumentException("Mapping directory location [" + resource + "] does not denote a directory");
        }
        config.addDirectory(file);
      }
    }
    postProcessMappings(config);
    config.buildMappings();
    if (this.entityCacheStrategies != null) {
      for (Enumeration classNames=this.entityCacheStrategies.propertyNames(); classNames.hasMoreElements(); ) {
        String className=(String)classNames.nextElement();
        String[] strategyAndRegion=StringUtils.commaDelimitedListToStringArray(this.entityCacheStrategies.getProperty(className));
        if (strategyAndRegion.length > 1) {
          Method setCacheConcurrencyStrategy=Configuration.class.getMethod("setCacheConcurrencyStrategy",String.class,String.class,String.class);
          ReflectionUtils.invokeMethod(setCacheConcurrencyStrategy,config,className,strategyAndRegion[0],strategyAndRegion[1]);
        }
 else         if (strategyAndRegion.length > 0) {
          config.setCacheConcurrencyStrategy(className,strategyAndRegion[0]);
        }
      }
    }
    if (this.collectionCacheStrategies != null) {
      for (Enumeration collRoles=this.collectionCacheStrategies.propertyNames(); collRoles.hasMoreElements(); ) {
        String collRole=(String)collRoles.nextElement();
        String[] strategyAndRegion=StringUtils.commaDelimitedListToStringArray(this.collectionCacheStrategies.getProperty(collRole));
        if (strategyAndRegion.length > 1) {
          config.setCollectionCacheConcurrencyStrategy(collRole,strategyAndRegion[0],strategyAndRegion[1]);
        }
 else         if (strategyAndRegion.length > 0) {
          config.setCollectionCacheConcurrencyStrategy(collRole,strategyAndRegion[0]);
        }
      }
    }
    if (this.eventListeners != null) {
      for (      Map.Entry<String,Object> entry : this.eventListeners.entrySet()) {
        String listenerType=entry.getKey();
        Object listenerObject=entry.getValue();
        if (listenerObject instanceof Collection) {
          Collection<Object> listeners=(Collection<Object>)listenerObject;
          EventListeners listenerRegistry=config.getEventListeners();
          Object[] listenerArray=(Object[])Array.newInstance(listenerRegistry.getListenerClassFor(listenerType),listeners.size());
          listenerArray=listeners.toArray(listenerArray);
          config.setListeners(listenerType,listenerArray);
        }
 else {
          config.setListener(listenerType,listenerObject);
        }
      }
    }
    postProcessConfiguration(config);
    logger.info("Building new Hibernate SessionFactory");
    this.configuration=config;
    return newSessionFactory(config);
  }
  finally {
    if (dataSource != null) {
      configTimeDataSourceHolder.remove();
    }
    if (this.jtaTransactionManager != null) {
      configTimeTransactionManagerHolder.remove();
    }
    if (this.cacheRegionFactory != null) {
      configTimeCacheProviderHolder.remove();
    }
    if (this.cacheProvider != null) {
      configTimeCacheProviderHolder.remove();
    }
    if (this.lobHandler != null) {
      configTimeLobHandlerHolder.remove();
    }
    if (overrideClassLoader) {
      currentThread.setContextClassLoader(threadContextClassLoader);
    }
  }
}
