{
  StringBuilder uriBuilder=new StringBuilder();
  if (scheme != null) {
    uriBuilder.append(scheme).append(':');
  }
  if (userInfo != null || host != null || port != -1) {
    uriBuilder.append("//");
    if (StringUtils.hasLength(userInfo)) {
      uriBuilder.append(userInfo);
      uriBuilder.append('@');
    }
    if (host != null) {
      uriBuilder.append(host);
    }
    if (port != -1) {
      uriBuilder.append(':');
      uriBuilder.append(port);
    }
  }
  if (!pathSegments.isEmpty()) {
    for (    String pathSegment : pathSegments) {
      boolean startsWithSlash=pathSegment.charAt(0) == '/';
      boolean endsWithSlash=uriBuilder.length() > 0 && uriBuilder.charAt(uriBuilder.length() - 1) == '/';
      if (!endsWithSlash && !startsWithSlash) {
        uriBuilder.append('/');
      }
 else       if (endsWithSlash && startsWithSlash) {
        pathSegment=pathSegment.substring(1);
      }
      uriBuilder.append(pathSegment);
    }
  }
  if (queryBuilder.length() > 0) {
    uriBuilder.append('?');
    uriBuilder.append(queryBuilder);
  }
  if (StringUtils.hasLength(fragment)) {
    uriBuilder.append('#');
    uriBuilder.append(fragment);
  }
  String uri=uriBuilder.toString();
  uri=StringUtils.replace(uri,"{","%7B");
  uri=StringUtils.replace(uri,"}","%7D");
  return URI.create(uri);
}
