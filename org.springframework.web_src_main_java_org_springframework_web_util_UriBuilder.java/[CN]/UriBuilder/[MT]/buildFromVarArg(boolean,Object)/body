{
  if (ObjectUtils.isEmpty(uriVariableValues)) {
    return build();
  }
  StringBuilder uriBuilder=new StringBuilder();
  UriTemplate template;
  if (scheme != null) {
    template=new UriComponentTemplate(scheme,UriComponents.Type.SCHEME,encodeUriVariableValues);
    uriBuilder.append(template.expandAsString(uriVariableValues));
    uriBuilder.append(':');
  }
  if (userInfo != null || host != null || port != -1) {
    uriBuilder.append("//");
    if (StringUtils.hasLength(userInfo)) {
      template=new UriComponentTemplate(userInfo,UriComponents.Type.USER_INFO,encodeUriVariableValues);
      uriBuilder.append(template.expandAsString(uriVariableValues));
      uriBuilder.append('@');
    }
    if (host != null) {
      template=new UriComponentTemplate(host,UriComponents.Type.HOST,encodeUriVariableValues);
      uriBuilder.append(template.expandAsString(uriVariableValues));
    }
    if (port != -1) {
      uriBuilder.append(':');
      uriBuilder.append(port);
    }
  }
  if (!pathSegments.isEmpty()) {
    for (    String pathSegment : pathSegments) {
      boolean startsWithSlash=pathSegment.charAt(0) == '/';
      boolean endsWithSlash=uriBuilder.length() > 0 && uriBuilder.charAt(uriBuilder.length() - 1) == '/';
      if (!endsWithSlash && !startsWithSlash) {
        uriBuilder.append('/');
      }
 else       if (endsWithSlash && startsWithSlash) {
        pathSegment=pathSegment.substring(1);
      }
      template=new UriComponentTemplate(pathSegment,UriComponents.Type.PATH_SEGMENT,encodeUriVariableValues);
      uriBuilder.append(template.expandAsString(uriVariableValues));
    }
  }
  if (queryBuilder.length() > 0) {
    uriBuilder.append('?');
    template=new UriComponentTemplate(queryBuilder.toString(),UriComponents.Type.QUERY,encodeUriVariableValues);
    uriBuilder.append(template.expandAsString(uriVariableValues));
  }
  if (StringUtils.hasLength(fragment)) {
    uriBuilder.append('#');
    template=new UriComponentTemplate(fragment,UriComponents.Type.FRAGMENT,encodeUriVariableValues);
    uriBuilder.append(template.expandAsString(uriVariableValues));
  }
  return URI.create(uriBuilder.toString());
}
