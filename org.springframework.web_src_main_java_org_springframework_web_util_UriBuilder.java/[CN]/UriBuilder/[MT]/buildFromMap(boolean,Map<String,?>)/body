{
  if (CollectionUtils.isEmpty(uriVariables)) {
    return build();
  }
  StringBuilder uriBuilder=new StringBuilder();
  UriTemplate template;
  if (scheme != null) {
    template=new UriTemplate(scheme,UriComponent.SCHEME);
    uriBuilder.append(template.expandAsString(encodeUriVariableValues,uriVariables));
    uriBuilder.append(':');
  }
  if (userInfo != null || host != null || port != -1) {
    uriBuilder.append("//");
    if (StringUtils.hasLength(userInfo)) {
      template=new UriTemplate(userInfo,UriComponent.USER_INFO);
      uriBuilder.append(template.expandAsString(encodeUriVariableValues,uriVariables));
      uriBuilder.append('@');
    }
    if (host != null) {
      template=new UriTemplate(host,UriComponent.HOST);
      uriBuilder.append(template.expandAsString(encodeUriVariableValues,uriVariables));
    }
    if (port != -1) {
      uriBuilder.append(':');
      uriBuilder.append(port);
    }
  }
  if (!pathSegments.isEmpty()) {
    for (    String pathSegment : pathSegments) {
      boolean startsWithSlash=pathSegment.charAt(0) == '/';
      boolean endsWithSlash=uriBuilder.length() > 0 && uriBuilder.charAt(uriBuilder.length() - 1) == '/';
      if (!endsWithSlash && !startsWithSlash) {
        uriBuilder.append('/');
      }
 else       if (endsWithSlash && startsWithSlash) {
        pathSegment=pathSegment.substring(1);
      }
      template=new UriTemplate(pathSegment,UriComponent.PATH_SEGMENT);
      uriBuilder.append(template.expandAsString(encodeUriVariableValues,uriVariables));
    }
  }
  if (queryBuilder.length() > 0) {
    uriBuilder.append('?');
    template=new UriTemplate(queryBuilder.toString(),UriComponent.QUERY);
    uriBuilder.append(template.expandAsString(encodeUriVariableValues,uriVariables));
  }
  if (StringUtils.hasLength(fragment)) {
    uriBuilder.append('#');
    template=new UriTemplate(fragment,UriComponent.FRAGMENT);
    uriBuilder.append(template.expandAsString(encodeUriVariableValues,uriVariables));
  }
  return URI.create(uriBuilder.toString());
}
