{
  final String templateName="test.vm";
  WebApplicationContext wac=createMock(WebApplicationContext.class);
  wac.getParentBeanFactory();
  expectLastCall().andReturn(null);
  wac.getServletContext();
  expectLastCall().andReturn(new MockServletContext());
  final Template expectedTemplate=new Template();
  VelocityConfig vc=new VelocityConfig(){
    public VelocityEngine getVelocityEngine(){
      return new TestVelocityEngine(templateName,expectedTemplate);
    }
  }
;
  wac.getBeansOfType(VelocityConfig.class,true,false);
  Map<String,Object> configurers=new HashMap<String,Object>();
  configurers.put("velocityConfigurer",vc);
  expectLastCall().andReturn(configurers);
  replay(wac);
  HttpServletRequest req=createMock(HttpServletRequest.class);
  req.getAttribute(View.PATH_VARIABLES);
  expectLastCall().andReturn(null);
  req.getAttribute(DispatcherServlet.LOCALE_RESOLVER_ATTRIBUTE);
  expectLastCall().andReturn(new AcceptHeaderLocaleResolver());
  req.getLocale();
  expectLastCall().andReturn(Locale.CANADA);
  replay(req);
  final HttpServletResponse expectedResponse=new MockHttpServletResponse();
  VelocityView vv=new VelocityView(){
    protected void mergeTemplate(    Template template,    Context context,    HttpServletResponse response) throws Exception {
      assertTrue(template == expectedTemplate);
      assertTrue(response == expectedResponse);
      assertEquals("myValue",context.get("myHelper"));
      assertTrue(context.get("math") instanceof MathTool);
      assertTrue(context.get("dateTool") instanceof DateTool);
      DateTool dateTool=(DateTool)context.get("dateTool");
      assertTrue(dateTool.getLocale().equals(Locale.CANADA));
      assertTrue(context.get("numberTool") instanceof NumberTool);
      NumberTool numberTool=(NumberTool)context.get("numberTool");
      assertTrue(numberTool.getLocale().equals(Locale.CANADA));
    }
    protected void exposeHelpers(    Map<String,Object> model,    HttpServletRequest request) throws Exception {
      model.put("myHelper","myValue");
    }
  }
;
  vv.setUrl(templateName);
  vv.setApplicationContext(wac);
  Map<String,Class> toolAttributes=new HashMap<String,Class>();
  toolAttributes.put("math",MathTool.class);
  vv.setToolAttributes(toolAttributes);
  vv.setDateToolAttribute("dateTool");
  vv.setNumberToolAttribute("numberTool");
  vv.setExposeSpringMacroHelpers(false);
  vv.render(new HashMap<String,Object>(),req,expectedResponse);
  verify(wac);
  verify(req);
  assertEquals(AbstractView.DEFAULT_CONTENT_TYPE,expectedResponse.getContentType());
}
