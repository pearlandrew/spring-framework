{
  try {
    if (byte[].class.equals(getSerializedPayloadClass())) {
      ByteArrayOutputStream out=new ByteArrayOutputStream(1024);
      JsonEncoding encoding=getJsonEncoding(getMimeType(headers));
      @SuppressWarnings("deprecation") JsonGenerator generator=this.objectMapper.getJsonFactory().createJsonGenerator(out,encoding);
      if (this.objectMapper.isEnabled(SerializationFeature.INDENT_OUTPUT)) {
        generator.useDefaultPrettyPrinter();
      }
      this.objectMapper.writeValue(generator,payload);
      payload=out.toByteArray();
    }
 else {
      Writer writer=new StringWriter();
      this.objectMapper.writeValue(writer,payload);
      payload=writer.toString();
    }
  }
 catch (  IOException ex) {
    throw new MessageConversionException("Could not write JSON: " + ex.getMessage(),ex);
  }
  return payload;
}
