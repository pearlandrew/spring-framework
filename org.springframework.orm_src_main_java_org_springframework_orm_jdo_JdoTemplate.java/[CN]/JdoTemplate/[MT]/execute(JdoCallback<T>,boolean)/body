{
  Assert.notNull(action,"Callback object must not be null");
  PersistenceManager pm=PersistenceManagerFactoryUtils.getPersistenceManager(getPersistenceManagerFactory(),isAllowCreate());
  boolean existingTransaction=TransactionSynchronizationManager.hasResource(getPersistenceManagerFactory());
  try {
    PersistenceManager pmToExpose=(exposeNativePersistenceManager ? pm : createPersistenceManagerProxy(pm));
    T result=action.doInJdo(pmToExpose);
    flushIfNecessary(pm,existingTransaction);
    return postProcessResult(result,pm,existingTransaction);
  }
 catch (  JDOException ex) {
    throw convertJdoAccessException(ex);
  }
catch (  RuntimeException ex) {
    throw ex;
  }
 finally {
    PersistenceManagerFactoryUtils.releasePersistenceManager(pm,getPersistenceManagerFactory());
  }
}
