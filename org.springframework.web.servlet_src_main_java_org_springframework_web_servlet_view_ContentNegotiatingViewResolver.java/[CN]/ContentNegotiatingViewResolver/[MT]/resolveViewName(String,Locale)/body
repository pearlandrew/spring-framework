{
  RequestAttributes attrs=RequestContextHolder.getRequestAttributes();
  Assert.isInstanceOf(ServletRequestAttributes.class,attrs);
  ServletRequestAttributes servletAttrs=(ServletRequestAttributes)attrs;
  List<MediaType> requestedMediaTypes=getMediaTypes(servletAttrs.getRequest());
  if (requestedMediaTypes.size() > 1) {
    Collections.sort(requestedMediaTypes);
  }
  SortedMap<MediaType,View> views=new TreeMap<MediaType,View>();
  List<View> candidateViews=new ArrayList<View>();
  for (  ViewResolver viewResolver : this.viewResolvers) {
    View view=viewResolver.resolveViewName(viewName,locale);
    if (view != null) {
      candidateViews.add(view);
    }
  }
  if (!CollectionUtils.isEmpty(this.defaultViews)) {
    candidateViews.addAll(this.defaultViews);
  }
  for (  View candidateView : candidateViews) {
    MediaType viewMediaType=MediaType.parseMediaType(candidateView.getContentType());
    for (    MediaType requestedMediaType : requestedMediaTypes) {
      if (requestedMediaType.includes(viewMediaType)) {
        if (!views.containsKey(requestedMediaType)) {
          views.put(requestedMediaType,candidateView);
          break;
        }
      }
    }
  }
  if (!views.isEmpty()) {
    MediaType mediaType=views.firstKey();
    View view=views.get(mediaType);
    if (logger.isDebugEnabled()) {
      logger.debug("Returning [" + view + "] based on requested media type '"+ mediaType+ "'");
    }
    return view;
  }
 else {
    return null;
  }
}
