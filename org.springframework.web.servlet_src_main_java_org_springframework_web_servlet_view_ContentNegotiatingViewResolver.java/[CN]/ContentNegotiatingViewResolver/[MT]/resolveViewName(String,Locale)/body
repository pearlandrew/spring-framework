{
  RequestAttributes attrs=RequestContextHolder.getRequestAttributes();
  Assert.isInstanceOf(ServletRequestAttributes.class,attrs);
  ServletRequestAttributes servletAttrs=(ServletRequestAttributes)attrs;
  List<MediaType> requestedMediaTypes=getMediaTypes(servletAttrs.getRequest());
  if (requestedMediaTypes.size() > 1) {
    Collections.sort(requestedMediaTypes);
  }
  List<View> candidateViews=new ArrayList<View>();
  for (  ViewResolver viewResolver : this.viewResolvers) {
    View view=viewResolver.resolveViewName(viewName,locale);
    if (view != null) {
      candidateViews.add(view);
    }
  }
  if (!CollectionUtils.isEmpty(this.defaultViews)) {
    candidateViews.addAll(this.defaultViews);
  }
  SortedMap<MediaType,View> views=new TreeMap<MediaType,View>();
  for (  View candidateView : candidateViews) {
    String contentType=candidateView.getContentType();
    if (StringUtils.hasText(contentType)) {
      MediaType viewMediaType=MediaType.parseMediaType(contentType);
      for (      MediaType requestedMediaType : requestedMediaTypes) {
        if (requestedMediaType.includes(viewMediaType)) {
          if (!views.containsKey(requestedMediaType)) {
            views.put(requestedMediaType,candidateView);
            break;
          }
        }
      }
    }
  }
  if (!views.isEmpty()) {
    MediaType mediaType=views.firstKey();
    View view=views.get(mediaType);
    if (logger.isDebugEnabled()) {
      logger.debug("Returning [" + view + "] based on requested media type '"+ mediaType+ "'");
    }
    return view;
  }
 else {
    return useNotAcceptableStatusCode ? new NotAcceptableView() : null;
  }
}
