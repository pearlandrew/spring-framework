{
  if (this.favorPathExtension) {
    String requestUri=urlPathHelper.getRequestUri(request);
    String filename=WebUtils.extractFullFilenameFromUrlPath(requestUri);
    MediaType mediaType=getMediaTypeFromFilename(filename);
    if (mediaType != null) {
      if (logger.isDebugEnabled()) {
        logger.debug("Requested media type is '" + mediaType + "' (based on filename '"+ filename+ "')");
      }
      return Collections.singletonList(mediaType);
    }
  }
  if (this.favorParameter) {
    if (request.getParameter(this.parameterName) != null) {
      String parameterValue=request.getParameter(this.parameterName);
      MediaType mediaType=getMediaTypeFromParameter(parameterValue);
      if (mediaType != null) {
        if (logger.isDebugEnabled()) {
          logger.debug("Requested media type is '" + mediaType + "' (based on parameter '"+ this.parameterName+ "'='"+ parameterValue+ "')");
        }
        return Collections.singletonList(mediaType);
      }
    }
  }
  if (!this.ignoreAcceptHeader) {
    String acceptHeader=request.getHeader(ACCEPT_HEADER);
    if (StringUtils.hasText(acceptHeader)) {
      List<MediaType> acceptableMediaTypes=MediaType.parseMediaTypes(acceptHeader);
      List<MediaType> producibleMediaTypes=getProducibleMediaTypes(request);
      Set<MediaType> compatibleMediaTypes=new LinkedHashSet<MediaType>();
      for (      MediaType a : acceptableMediaTypes) {
        for (        MediaType p : producibleMediaTypes) {
          if (a.isCompatibleWith(p)) {
            compatibleMediaTypes.add(getMostSpecificMediaType(a,p));
          }
        }
      }
      List<MediaType> mediaTypes=new ArrayList<MediaType>(compatibleMediaTypes);
      MediaType.sortByQualityValue(mediaTypes);
      if (logger.isDebugEnabled()) {
        logger.debug("Requested media types are " + mediaTypes + " based on Accept header types "+ "and producible media types "+ producibleMediaTypes+ ")");
      }
      return mediaTypes;
    }
  }
  if (this.defaultContentType != null) {
    if (logger.isDebugEnabled()) {
      logger.debug("Requested media types is " + this.defaultContentType + " (based on defaultContentType property)");
    }
    return Collections.singletonList(this.defaultContentType);
  }
 else {
    return Collections.emptyList();
  }
}
