{
  StringBuilder result=new StringBuilder();
  Matcher m=URI_TEMPLATE_VARIABLE_PATTERN.matcher(targetUrl);
  int endLastMatch=0;
  while (m.find()) {
    String name=m.group(1);
    Object value=model.containsKey(name) ? model.remove(name) : currentUriVariables.get(name);
    Assert.notNull(value,"Model has no value for '" + name + "'");
    result.append(targetUrl.substring(endLastMatch,m.start()));
    result.append(UriUtils.encodePathSegment(value.toString(),encodingScheme));
    endLastMatch=m.end();
  }
  result.append(targetUrl.substring(endLastMatch,targetUrl.length()));
  return result;
}
