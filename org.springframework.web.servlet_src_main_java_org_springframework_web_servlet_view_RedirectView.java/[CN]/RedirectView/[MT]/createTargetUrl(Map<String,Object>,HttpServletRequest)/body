{
  StringBuilder targetUrl=new StringBuilder();
  if (this.contextRelative && getUrl().startsWith("/")) {
    targetUrl.append(request.getContextPath());
  }
  targetUrl.append(getUrl());
  String enc=this.encodingScheme;
  if (enc == null) {
    enc=request.getCharacterEncoding();
  }
  if (enc == null) {
    enc=WebUtils.DEFAULT_CHARACTER_ENCODING;
  }
  if (StringUtils.hasText(targetUrl)) {
    UriTemplate uriTemplate=createUriTemplate(targetUrl,enc);
    if (uriTemplate.getVariableNames().size() > 0) {
      Map<String,Object> vars=new HashMap<String,Object>();
      vars.putAll(getCurrentUriVars(request));
      vars.putAll(model);
      targetUrl=new StringBuilder(uriTemplate.expand(vars).toString());
      model=removeKeys(model,uriTemplate.getVariableNames());
    }
  }
  FlashMap flashMap=RequestContextUtils.getOutputFlashMap(request);
  if (!CollectionUtils.isEmpty(flashMap)) {
    String targetPath=WebUtils.extractUrlPath(targetUrl.toString());
    flashMap.setTargetRequestPath(targetPath);
  }
  if (this.exposeModelAttributes) {
    appendQueryProperties(targetUrl,model,enc);
    if (!CollectionUtils.isEmpty(flashMap)) {
      flashMap.addTargetRequestParams(model);
    }
  }
  return targetUrl.toString();
}
