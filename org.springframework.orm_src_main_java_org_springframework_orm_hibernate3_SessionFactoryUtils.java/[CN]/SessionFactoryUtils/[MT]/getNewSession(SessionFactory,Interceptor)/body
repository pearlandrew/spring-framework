{
  Assert.notNull(sessionFactory,"No SessionFactory specified");
  try {
    SessionHolder sessionHolder=(SessionHolder)TransactionSynchronizationManager.getResource(sessionFactory);
    if (sessionHolder != null && !sessionHolder.isEmpty()) {
      if (entityInterceptor != null) {
        return sessionFactory.openSession(sessionHolder.getAnySession().connection(),entityInterceptor);
      }
 else {
        return sessionFactory.openSession(sessionHolder.getAnySession().connection());
      }
    }
 else {
      if (entityInterceptor != null) {
        return sessionFactory.openSession(entityInterceptor);
      }
 else {
        return sessionFactory.openSession();
      }
    }
  }
 catch (  HibernateException ex) {
    throw new DataAccessResourceFailureException("Could not open Hibernate Session",ex);
  }
}
