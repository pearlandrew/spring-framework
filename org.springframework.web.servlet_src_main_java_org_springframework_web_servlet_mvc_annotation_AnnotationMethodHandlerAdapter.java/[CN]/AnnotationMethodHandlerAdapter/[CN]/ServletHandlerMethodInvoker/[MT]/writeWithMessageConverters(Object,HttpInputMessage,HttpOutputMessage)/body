{
  List<MediaType> acceptedMediaTypes=inputMessage.getHeaders().getAccept();
  if (acceptedMediaTypes.isEmpty()) {
    acceptedMediaTypes=Collections.singletonList(MediaType.ALL);
  }
  MediaType.sortBySpecificity(acceptedMediaTypes);
  Class<?> returnValueType=returnValue.getClass();
  List<MediaType> allSupportedMediaTypes=new ArrayList<MediaType>();
  if (getMessageConverters() != null) {
    for (    MediaType acceptedMediaType : acceptedMediaTypes) {
      for (      HttpMessageConverter messageConverter : getMessageConverters()) {
        if (messageConverter.canWrite(returnValueType,acceptedMediaType)) {
          messageConverter.write(returnValue,acceptedMediaType,outputMessage);
          if (logger.isDebugEnabled()) {
            MediaType contentType=outputMessage.getHeaders().getContentType();
            if (contentType == null) {
              contentType=acceptedMediaType;
            }
            logger.debug("Written [" + returnValue + "] as \""+ contentType+ "\" using ["+ messageConverter+ "]");
          }
          this.responseArgumentUsed=true;
          return;
        }
      }
    }
    for (    HttpMessageConverter messageConverter : messageConverters) {
      allSupportedMediaTypes.addAll(messageConverter.getSupportedMediaTypes());
    }
  }
  throw new HttpMediaTypeNotAcceptableException(allSupportedMediaTypes);
}
