{
  String destination=headers.getDestination();
  if (destination == null) {
    logger.trace("Ignoring message, no destination");
    return null;
  }
  String targetUser;
  String targetDestination;
  Principal user=headers.getUser();
  SimpMessageType messageType=headers.getMessageType();
  if (SimpMessageType.SUBSCRIBE.equals(messageType) || SimpMessageType.UNSUBSCRIBE.equals(messageType)) {
    if (user == null) {
      logger.trace("Ignoring (un)subscribe message, no user information");
      return null;
    }
    if (!destination.startsWith(this.subscriptionDestinationPrefix)) {
      logger.trace("Ignoring (un)subscribe message, not a \"user\" destination");
      return null;
    }
    targetUser=user.getName();
    targetDestination=destination.substring(this.destinationPrefix.length() - 1);
  }
 else   if (SimpMessageType.MESSAGE.equals(messageType)) {
    if (!destination.startsWith(this.destinationPrefix)) {
      logger.trace("Ignoring message, not a \"user\" destination");
      return null;
    }
    int startIndex=this.destinationPrefix.length();
    int endIndex=destination.indexOf('/',startIndex);
    Assert.isTrue(endIndex > 0,"Expected destination pattern \"/user/{userId}/**\"");
    targetUser=destination.substring(startIndex,endIndex);
    targetDestination=destination.substring(endIndex);
  }
 else {
    logger.trace("Ignoring message, not of the right message type");
    return null;
  }
  return new UserDestinationInfo(targetUser,targetDestination);
}
