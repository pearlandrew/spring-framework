{
  Class<?> testClass=testContext.getTestClass();
  Assert.notNull(testClass,"The test class of the supplied TestContext must not be null");
  Method testMethod=testContext.getTestMethod();
  Assert.notNull(testMethod,"The test method of the supplied TestContext must not be null");
  final String annotationType=DirtiesContext.class.getName();
  AnnotationAttributes methodAnnAttrs=AnnotatedElementUtils.getAnnotationAttributes(testMethod,annotationType);
  AnnotationAttributes classAnnAttrs=AnnotatedElementUtils.getAnnotationAttributes(testClass,annotationType);
  boolean methodDirtiesContext=methodAnnAttrs != null;
  boolean classDirtiesContext=classAnnAttrs != null;
  ClassMode classMode=classDirtiesContext ? classAnnAttrs.<ClassMode>getEnum("classMode") : null;
  if (logger.isDebugEnabled()) {
    logger.debug(String.format("After test method: context %s, class dirties context [%s], class mode [%s], method dirties context [%s].",testContext,classDirtiesContext,classMode,methodDirtiesContext));
  }
  if (methodDirtiesContext || (classMode == AFTER_EACH_TEST_METHOD)) {
    HierarchyMode hierarchyMode=methodDirtiesContext ? methodAnnAttrs.<HierarchyMode>getEnum("hierarchyMode") : classAnnAttrs.<HierarchyMode>getEnum("hierarchyMode");
    dirtyContext(testContext,hierarchyMode);
  }
}
