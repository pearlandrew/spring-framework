{
  TestClientHandler clientHandler=new TestClientHandler();
  this.errorFilter.sleepDelayMap.put("/xhr_streaming",10000L);
  this.errorFilter.responseStatusMap.put("/xhr_streaming",503);
  SockJsClient sockJsClient=createSockJsClient(getXhrTransport());
  sockJsClient.setTaskScheduler(this.wac.getBean(ThreadPoolTaskScheduler.class));
  WebSocketSession clientSession=sockJsClient.doHandshake(clientHandler,this.baseUrl + "/echo").get();
  assertEquals("Fallback didn't occur",XhrClientSockJsSession.class,clientSession.getClass());
  TextMessage message=new TextMessage("message1");
  clientSession.sendMessage(message);
  clientHandler.awaitMessage(message,5000);
  clientSession.close();
}
