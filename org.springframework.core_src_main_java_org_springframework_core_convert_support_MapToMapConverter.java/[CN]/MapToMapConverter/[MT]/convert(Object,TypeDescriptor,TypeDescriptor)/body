{
  if (source == null) {
    return null;
  }
  boolean copyRequired=!targetType.getType().isInstance(source);
  Map<Object,Object> sourceMap=(Map<Object,Object>)source;
  Map<Object,Object> targetMap=CollectionFactory.createMap(targetType.getType(),sourceMap.size());
  for (  Map.Entry<Object,Object> entry : sourceMap.entrySet()) {
    Object sourceKey=entry.getKey();
    Object sourceValue=entry.getValue();
    Object targetKey=convertKey(sourceKey,sourceType,targetType.getMapKeyTypeDescriptor());
    Object targetValue=convertValue(sourceValue,sourceType,targetType.getMapValueTypeDescriptor());
    targetMap.put(targetKey,targetValue);
    if (sourceKey != targetKey || sourceValue != targetValue) {
      copyRequired=true;
    }
  }
  return (copyRequired ? targetMap : sourceMap);
}
