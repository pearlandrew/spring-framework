{
  String sessionId=SimpMessageHeaderAccessor.getSessionId(message.getHeaders());
  if (!isBrokerAvailable()) {
    if (sessionId == null || SystemStompConnectionHandler.SESSION_ID.equals(sessionId)) {
      throw new MessageDeliveryException("Message broker is not active.");
    }
    if (logger.isDebugEnabled()) {
      logger.debug("Message broker is not active. Ignoring: " + message);
    }
    return;
  }
  StompHeaderAccessor stompAccessor;
  StompCommand command;
  MessageHeaderAccessor accessor=MessageHeaderAccessor.getAccessor(message,MessageHeaderAccessor.class);
  if (accessor == null) {
    logger.error("No header accessor, please use SimpMessagingTemplate. Ignoring: " + message);
    return;
  }
 else   if (accessor instanceof StompHeaderAccessor) {
    stompAccessor=(StompHeaderAccessor)accessor;
    command=stompAccessor.getCommand();
  }
 else   if (accessor instanceof SimpMessageHeaderAccessor) {
    stompAccessor=StompHeaderAccessor.wrap(message);
    command=stompAccessor.getCommand();
    if (command == null) {
      command=stompAccessor.updateStompCommandAsClientMessage();
    }
  }
 else {
    logger.error("Unexpected header accessor type: " + accessor + ". Ignoring: "+ message);
    return;
  }
  if (sessionId == null) {
    if (!SimpMessageType.MESSAGE.equals(stompAccessor.getMessageType())) {
      logger.error("Only STOMP SEND frames supported on \"system\" connection. Ignoring: " + message);
      return;
    }
    sessionId=SystemStompConnectionHandler.SESSION_ID;
    stompAccessor.setSessionId(sessionId);
  }
  String destination=stompAccessor.getDestination();
  if ((command != null) && command.requiresDestination() && !checkDestinationPrefix(destination)) {
    if (logger.isTraceEnabled()) {
      logger.trace("Ignoring message to destination=" + destination);
    }
    return;
  }
  if (logger.isTraceEnabled()) {
    logger.trace("Processing message=" + message);
  }
  if (StompCommand.CONNECT.equals(command)) {
    if (logger.isDebugEnabled()) {
      logger.debug("Processing CONNECT (total connected=" + this.connectionHandlers.size() + ")");
    }
    stompAccessor=(stompAccessor.isMutable() ? stompAccessor : StompHeaderAccessor.wrap(message));
    stompAccessor.setLogin(this.clientLogin);
    stompAccessor.setPasscode(this.clientPasscode);
    if (getVirtualHost() != null) {
      stompAccessor.setHost(getVirtualHost());
    }
    StompConnectionHandler handler=new StompConnectionHandler(sessionId,stompAccessor);
    this.connectionHandlers.put(sessionId,handler);
    this.tcpClient.connect(handler);
  }
 else   if (StompCommand.DISCONNECT.equals(command)) {
    StompConnectionHandler handler=this.connectionHandlers.get(sessionId);
    if (handler == null) {
      if (logger.isTraceEnabled()) {
        logger.trace("Connection already removed for sessionId '" + sessionId + "'");
      }
      return;
    }
    handler.forward(message,stompAccessor);
  }
 else {
    StompConnectionHandler handler=this.connectionHandlers.get(sessionId);
    if (handler == null) {
      if (logger.isWarnEnabled()) {
        logger.warn("Connection for sessionId '" + sessionId + "' not found. Ignoring message");
      }
      return;
    }
    handler.forward(message,stompAccessor);
  }
}
