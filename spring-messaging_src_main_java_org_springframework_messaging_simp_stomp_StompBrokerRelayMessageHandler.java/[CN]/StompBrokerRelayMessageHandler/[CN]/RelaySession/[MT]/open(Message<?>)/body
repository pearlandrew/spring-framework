{
  Assert.notNull(message,"message is required");
  Composable<TcpConnection<String,String>> connectionComposable=openConnection();
  connectionComposable.consume(new Consumer<TcpConnection<String,String>>(){
    @Override public void accept(    TcpConnection<String,String> newConnection){
      isConnected=false;
      connection=newConnection;
      newConnection.in().consume(new Consumer<String>(){
        @Override public void accept(        String stompFrame){
          readStompFrame(stompFrame);
        }
      }
);
      forwardInternal(message);
    }
  }
);
  connectionComposable.when(Throwable.class,new Consumer<Throwable>(){
    @Override public void accept(    Throwable ex){
      relaySessions.remove(sessionId);
      logger.error("Failed to connect to broker",ex);
      sendError(sessionId,"Failed to connect to message broker " + ex.toString());
    }
  }
);
}
