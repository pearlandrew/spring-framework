{
  TcpConnection<String,String> localConnection=this.connection;
  if (localConnection == null) {
    return false;
  }
  if (logger.isTraceEnabled()) {
    logger.trace("Forwarding to STOMP broker, message: " + message);
  }
  byte[] bytes=stompMessageConverter.fromMessage(message);
  String payload=new String(bytes,Charset.forName("UTF-8"));
  final Deferred<Boolean,Promise<Boolean>> deferred=new DeferredPromiseSpec<Boolean>().get();
  localConnection.send(payload,new Consumer<Boolean>(){
    @Override public void accept(    Boolean success){
      deferred.accept(success);
    }
  }
);
  Boolean success=null;
  try {
    success=deferred.compose().await();
    if (success == null) {
      sendError(sessionId,"Timed out waiting for message to be forwarded to the broker");
    }
 else     if (!success) {
      if (StompHeaderAccessor.wrap(message).getCommand() != StompCommand.DISCONNECT) {
        sendError(sessionId,"Failed to forward message to the broker");
      }
    }
  }
 catch (  InterruptedException ie) {
    Thread.currentThread().interrupt();
    sendError(sessionId,"Interrupted while forwarding message to the broker");
  }
  return (success != null) ? success : false;
}
