{
  this.session.setPrincipal(new UniqueUser("joe"));
  UserSessionRegistry registry=new DefaultUserSessionRegistry();
  this.protocolHandler.setUserSessionRegistry(registry);
  StompHeaderAccessor headers=StompHeaderAccessor.create(StompCommand.CONNECTED);
  Message<byte[]> message=MessageBuilder.createMessage(EMPTY_PAYLOAD,headers.getMessageHeaders());
  this.protocolHandler.handleMessageToClient(this.session,message);
  assertEquals(1,this.session.getSentMessages().size());
  WebSocketMessage<?> textMessage=this.session.getSentMessages().get(0);
  assertEquals("CONNECTED\n" + "user-name:joe\n" + "\n"+ "\u0000",textMessage.getPayload());
  assertEquals(Collections.<String>emptySet(),registry.getSessionIds("joe"));
  assertEquals(Collections.singleton("s1"),registry.getSessionIds("Me myself and I"));
}
