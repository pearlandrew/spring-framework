{
  StompHeaderAccessor connectHeaders=StompHeaderAccessor.create(StompCommand.CONNECT);
  connectHeaders.setHeartbeat(10000,10000);
  connectHeaders.setAcceptVersion("1.0,1.1");
  Message<?> connectMessage=MessageBuilder.createMessage(EMPTY_PAYLOAD,connectHeaders.getMessageHeaders());
  SimpMessageHeaderAccessor connectAckHeaders=SimpMessageHeaderAccessor.create(SimpMessageType.CONNECT_ACK);
  connectAckHeaders.setHeader(SimpMessageHeaderAccessor.CONNECT_MESSAGE_HEADER,connectMessage);
  Message<byte[]> connectAckMessage=MessageBuilder.createMessage(EMPTY_PAYLOAD,connectAckHeaders.getMessageHeaders());
  this.protocolHandler.handleMessageToClient(this.session,connectAckMessage);
  verifyNoMoreInteractions(this.channel);
  assertEquals(1,this.session.getSentMessages().size());
  TextMessage textMessage=(TextMessage)this.session.getSentMessages().get(0);
  List<Message<byte[]>> messages=new StompDecoder().decode(ByteBuffer.wrap(textMessage.getPayload().getBytes()));
  assertEquals(1,messages.size());
  StompHeaderAccessor replyHeaders=StompHeaderAccessor.wrap(messages.get(0));
  assertEquals(StompCommand.CONNECTED,replyHeaders.getCommand());
  assertEquals("1.1",replyHeaders.getVersion());
  assertArrayEquals(new long[]{0,0},replyHeaders.getHeartbeat());
  assertEquals("joe",replyHeaders.getNativeHeader("user-name").get(0));
}
