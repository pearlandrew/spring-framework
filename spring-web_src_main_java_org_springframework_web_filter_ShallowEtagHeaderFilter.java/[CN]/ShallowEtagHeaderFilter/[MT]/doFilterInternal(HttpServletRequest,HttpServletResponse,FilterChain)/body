{
  HttpServletResponse responseToUse=response;
  if (!isAsyncDispatch(request) && !(response instanceof ContentCachingResponseWrapper)) {
    responseToUse=new ContentCachingResponseWrapper(response);
  }
  filterChain.doFilter(request,responseToUse);
  if (!isAsyncStarted(request)) {
    updateResponse(request,responseToUse);
  }
}
