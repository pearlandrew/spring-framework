{
  HttpServletResponse responseToUse=response;
  if (!isAsyncDispatch(request)) {
    responseToUse=new ShallowEtagResponseWrapper(response);
  }
  filterChain.doFilter(request,responseToUse);
  if (!isAsyncStarted(request)) {
    updateResponse(request,responseToUse);
  }
}
