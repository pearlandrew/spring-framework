{
  ShallowEtagResponseWrapper responseWrapper;
  if (isAsyncDispatch(request)) {
    responseWrapper=WebUtils.getNativeResponse(response,ShallowEtagResponseWrapper.class);
    Assert.notNull(responseWrapper,"Expected wrapped response");
  }
 else {
    responseWrapper=new ShallowEtagResponseWrapper(response);
  }
  filterChain.doFilter(request,responseWrapper);
  if (isLastRequestThread(request)) {
    updateResponse(request,response,responseWrapper);
  }
}
