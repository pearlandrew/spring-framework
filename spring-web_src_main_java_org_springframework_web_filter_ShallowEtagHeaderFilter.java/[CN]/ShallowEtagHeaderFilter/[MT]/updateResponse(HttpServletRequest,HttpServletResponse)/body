{
  ShallowEtagResponseWrapper responseWrapper=WebUtils.getNativeResponse(response,ShallowEtagResponseWrapper.class);
  Assert.notNull(responseWrapper,"ShallowEtagResponseWrapper not found");
  HttpServletResponse rawResponse=(HttpServletResponse)responseWrapper.getResponse();
  int statusCode=responseWrapper.getStatusCode();
  byte[] body=responseWrapper.toByteArray();
  if (rawResponse.isCommitted()) {
    if (body.length > 0) {
      StreamUtils.copy(body,rawResponse.getOutputStream());
    }
  }
 else   if (isEligibleForEtag(request,responseWrapper,statusCode,body)) {
    String responseETag=generateETagHeaderValue(body);
    rawResponse.setHeader(HEADER_ETAG,responseETag);
    String requestETag=request.getHeader(HEADER_IF_NONE_MATCH);
    if (responseETag.equals(requestETag)) {
      if (logger.isTraceEnabled()) {
        logger.trace("ETag [" + responseETag + "] equal to If-None-Match, sending 304");
      }
      rawResponse.setStatus(HttpServletResponse.SC_NOT_MODIFIED);
    }
 else {
      if (logger.isTraceEnabled()) {
        logger.trace("ETag [" + responseETag + "] not equal to If-None-Match ["+ requestETag+ "], sending normal response");
      }
      if (body.length > 0) {
        rawResponse.setContentLength(body.length);
        StreamUtils.copy(body,rawResponse.getOutputStream());
      }
    }
  }
 else {
    if (logger.isTraceEnabled()) {
      logger.trace("Response with status code [" + statusCode + "] not eligible for ETag");
    }
    if (body.length > 0) {
      rawResponse.setContentLength(body.length);
      StreamUtils.copy(body,rawResponse.getOutputStream());
    }
  }
}
