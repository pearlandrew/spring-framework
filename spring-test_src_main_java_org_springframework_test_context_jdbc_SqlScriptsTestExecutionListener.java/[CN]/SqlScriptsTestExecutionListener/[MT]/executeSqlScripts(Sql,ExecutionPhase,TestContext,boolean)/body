{
  if (logger.isDebugEnabled()) {
    logger.debug(String.format("Processing %s for execution phase [%s] and test context %s.",sql,executionPhase,testContext));
  }
  if (executionPhase != sql.executionPhase()) {
    return;
  }
  final ResourceDatabasePopulator populator=new ResourceDatabasePopulator();
  populator.setSqlScriptEncoding(sql.encoding());
  populator.setSeparator(sql.separator());
  populator.setCommentPrefix(sql.commentPrefix());
  populator.setBlockCommentStartDelimiter(sql.blockCommentStartDelimiter());
  populator.setBlockCommentEndDelimiter(sql.blockCommentEndDelimiter());
  populator.setContinueOnError(sql.continueOnError());
  populator.setIgnoreFailedDrops(sql.ignoreFailedDrops());
  String[] scripts=getScripts(sql,testContext,classLevel);
  scripts=TestContextResourceUtils.convertToClasspathResourcePaths(testContext.getTestClass(),scripts);
  populator.setScripts(TestContextResourceUtils.convertToResources(testContext.getApplicationContext(),scripts));
  if (logger.isDebugEnabled()) {
    logger.debug("Executing SQL scripts: " + ObjectUtils.nullSafeToString(scripts));
  }
  final DataSource dataSource=TestContextTransactionUtils.retrieveDataSource(testContext,sql.dataSource());
  final PlatformTransactionManager transactionManager=TestContextTransactionUtils.retrieveTransactionManager(testContext,sql.transactionManager());
  int propagation=sql.requireNewTransaction() ? TransactionDefinition.PROPAGATION_REQUIRES_NEW : TransactionDefinition.PROPAGATION_REQUIRED;
  TransactionAttribute transactionAttribute=TestContextTransactionUtils.createDelegatingTransactionAttribute(testContext,new DefaultTransactionAttribute(propagation));
  new TransactionTemplate(transactionManager,transactionAttribute).execute(new TransactionCallbackWithoutResult(){
    @Override public void doInTransactionWithoutResult(    TransactionStatus status){
      populator.execute(dataSource);
    }
  }
);
}
