{
  HttpServletRequest servletRequest=getHttpServletRequest(request);
  HttpServletResponse servletResponse=getHttpServletResponse(response);
  WebSocketApplication webSocketApplication=createTyrusEndpoint(endpoint,selectedProtocol,selectedExtensions);
  WebSocketEngine webSocketEngine=WebSocketEngine.getEngine();
  try {
    webSocketEngine.register(webSocketApplication);
  }
 catch (  DeploymentException ex) {
    throw new HandshakeFailureException("Failed to configure endpoint in GlassFish",ex);
  }
  try {
    performUpgrade(servletRequest,servletResponse,request.getHeaders(),webSocketApplication);
  }
 catch (  IOException ex) {
    throw new HandshakeFailureException("Response update failed during upgrade to WebSocket, uri=" + request.getURI(),ex);
  }
 finally {
    webSocketEngine.unregister(webSocketApplication);
  }
}
