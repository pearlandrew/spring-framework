{
  MockControl sessionControl=MockControl.createControl(Session.class);
  Session session=(Session)sessionControl.getMock();
  SessionFactory factory=new SingleSessionFactory(session);
  session.release();
  sessionControl.setVoidCallable(1);
  sessionControl.replay();
  TopLinkTemplate template=new TopLinkTemplate();
  template.setAllowCreate(true);
  template.setSessionFactory(factory);
  template.execute(new TopLinkCallback(){
    public Object doInTopLink(    Session session) throws TopLinkException {
      assertTrue(session != null);
      return null;
    }
  }
);
  assertFalse(TransactionSynchronizationManager.hasResource(factory));
  sessionControl.verify();
}
