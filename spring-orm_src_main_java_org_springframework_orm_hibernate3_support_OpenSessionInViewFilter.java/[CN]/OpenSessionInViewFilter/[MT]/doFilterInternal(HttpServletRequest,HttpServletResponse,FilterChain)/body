{
  SessionFactory sessionFactory=lookupSessionFactory(request);
  boolean participate=false;
  WebAsyncManager asyncManager=WebAsyncUtils.getAsyncManager(request);
  boolean isFirstRequest=!asyncManager.hasConcurrentResult();
  String key=getAlreadyFilteredAttributeName();
  if (isSingleSession()) {
    if (TransactionSynchronizationManager.hasResource(sessionFactory)) {
      participate=true;
    }
 else {
      if (isFirstRequest || !applySessionBindingInterceptor(asyncManager,key)) {
        logger.debug("Opening single Hibernate Session in OpenSessionInViewFilter");
        Session session=getSession(sessionFactory);
        SessionHolder sessionHolder=new SessionHolder(session);
        TransactionSynchronizationManager.bindResource(sessionFactory,sessionHolder);
        asyncManager.registerCallableInterceptor(key,new SessionBindingCallableInterceptor(sessionFactory,sessionHolder));
      }
    }
  }
 else {
    Assert.state(!asyncManager.isConcurrentHandlingStarted(),"Deferred close mode is not supported on async dispatches");
    if (SessionFactoryUtils.isDeferredCloseActive(sessionFactory)) {
      participate=true;
    }
 else {
      SessionFactoryUtils.initDeferredClose(sessionFactory);
    }
  }
  try {
    filterChain.doFilter(request,response);
  }
  finally {
    if (!participate) {
      if (isSingleSession()) {
        SessionHolder sessionHolder=(SessionHolder)TransactionSynchronizationManager.unbindResource(sessionFactory);
        if (!asyncManager.isConcurrentHandlingStarted()) {
          logger.debug("Closing single Hibernate Session in OpenSessionInViewFilter");
          closeSession(sessionHolder.getSession(),sessionFactory);
        }
      }
 else {
        SessionFactoryUtils.processDeferredClose(sessionFactory);
      }
    }
  }
}
