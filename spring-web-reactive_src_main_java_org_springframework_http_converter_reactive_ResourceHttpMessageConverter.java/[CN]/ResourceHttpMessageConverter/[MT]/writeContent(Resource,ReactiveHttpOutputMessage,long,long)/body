{
  if (outputMessage instanceof ZeroCopyHttpOutputMessage) {
    Optional<File> file=getFile(resource);
    if (file.isPresent()) {
      ZeroCopyHttpOutputMessage zeroCopyResponse=(ZeroCopyHttpOutputMessage)outputMessage;
      if (count < 0) {
        count=file.get().length();
      }
      return zeroCopyResponse.setBody(file.get(),position,count);
    }
  }
  try {
    InputStream is=resource.getInputStream();
    long skipped=is.skip(position);
    if (skipped < position) {
      return Mono.error(new IOException("Skipped only " + skipped + " bytes out of "+ count+ " required."));
    }
    Flux<DataBuffer> responseBody=DataBufferUtils.read(is,outputMessage.allocator(),BUFFER_SIZE);
    if (count > 0) {
      responseBody=DataBufferUtils.takeUntilByteCount(responseBody,count);
    }
    return outputMessage.setBody(responseBody);
  }
 catch (  IOException ex) {
    return Mono.error(ex);
  }
}
