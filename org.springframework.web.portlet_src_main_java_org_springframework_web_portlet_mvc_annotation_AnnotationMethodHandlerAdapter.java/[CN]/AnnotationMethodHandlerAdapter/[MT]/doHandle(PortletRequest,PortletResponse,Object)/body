{
  ExtendedModelMap implicitModel=null;
  if (response instanceof MimeResponse) {
    MimeResponse mimeResponse=(MimeResponse)response;
    if (request.getParameter(IMPLICIT_MODEL_ATTRIBUTE) != null) {
      PortletSession session=request.getPortletSession(false);
      if (session != null) {
        implicitModel=(ExtendedModelMap)session.getAttribute(IMPLICIT_MODEL_ATTRIBUTE);
      }
    }
    if (handler.getClass().getAnnotation(SessionAttributes.class) != null) {
      checkAndPrepare(request,mimeResponse,this.cacheSecondsForSessionAttributeHandlers);
    }
 else {
      checkAndPrepare(request,mimeResponse);
    }
  }
  if (implicitModel == null) {
    implicitModel=new BindingAwareModelMap();
  }
  if (this.synchronizeOnSession) {
    PortletSession session=request.getPortletSession(false);
    if (session != null) {
      Object mutex=PortletUtils.getSessionMutex(session);
synchronized (mutex) {
        return invokeHandlerMethod(request,response,handler,implicitModel);
      }
    }
  }
  return invokeHandlerMethod(request,response,handler,implicitModel);
}
