{
  if (!rootDir.isDirectory()) {
    throw new IllegalStateException("Resource path [" + rootDir.getAbsolutePath() + "] does not denote a directory");
  }
  if (!rootDir.canRead()) {
    if (logger.isWarnEnabled()) {
      logger.warn("Cannot search for matching files underneath directory [" + rootDir.getAbsolutePath() + "] because the application is not allowed to read the directory");
    }
    return Collections.emptySet();
  }
  String fullPattern=StringUtils.replace(rootDir.getAbsolutePath(),File.separator,"/");
  if (!pattern.startsWith("/")) {
    fullPattern+="/";
  }
  fullPattern=fullPattern + StringUtils.replace(pattern,File.separator,"/");
  Set<File> result=new LinkedHashSet<File>(8);
  doRetrieveMatchingFiles(fullPattern,rootDir,result);
  return result;
}
