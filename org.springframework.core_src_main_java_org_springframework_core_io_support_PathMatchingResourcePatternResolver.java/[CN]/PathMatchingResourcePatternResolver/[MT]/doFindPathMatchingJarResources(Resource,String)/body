{
  URLConnection con=rootDirResource.getURL().openConnection();
  JarFile jarFile=null;
  String jarFileUrl=null;
  String rootEntryPath=null;
  boolean newJarFile=false;
  if (con instanceof JarURLConnection) {
    JarURLConnection jarCon=(JarURLConnection)con;
    jarCon.setUseCaches(false);
    jarFile=jarCon.getJarFile();
    jarFileUrl=jarCon.getJarFileURL().toExternalForm();
    JarEntry jarEntry=jarCon.getJarEntry();
    rootEntryPath=(jarEntry != null ? jarEntry.getName() : "");
  }
 else {
    String urlFile=rootDirResource.getURL().getFile();
    int separatorIndex=urlFile.indexOf(ResourceUtils.JAR_URL_SEPARATOR);
    if (separatorIndex != -1) {
      jarFileUrl=urlFile.substring(0,separatorIndex);
      rootEntryPath=urlFile.substring(separatorIndex + ResourceUtils.JAR_URL_SEPARATOR.length());
      jarFile=getJarFile(jarFileUrl);
    }
 else {
      jarFile=new JarFile(urlFile);
      jarFileUrl=urlFile;
      rootEntryPath="";
    }
    newJarFile=true;
  }
  try {
    if (logger.isDebugEnabled()) {
      logger.debug("Looking for matching resources in jar file [" + jarFileUrl + "]");
    }
    if (!"".equals(rootEntryPath) && !rootEntryPath.endsWith("/")) {
      rootEntryPath=rootEntryPath + "/";
    }
    Set result=new LinkedHashSet(8);
    for (Enumeration entries=jarFile.entries(); entries.hasMoreElements(); ) {
      JarEntry entry=(JarEntry)entries.nextElement();
      String entryPath=entry.getName();
      if (entryPath.startsWith(rootEntryPath)) {
        String relativePath=entryPath.substring(rootEntryPath.length());
        if (getPathMatcher().match(subPattern,relativePath)) {
          result.add(rootDirResource.createRelative(relativePath));
        }
      }
    }
    return result;
  }
  finally {
    if (newJarFile) {
      jarFile.close();
    }
  }
}
