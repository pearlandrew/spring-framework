{
  final String sql="UPDATE NOSUCHTABLE SET DATE_DISPATCHED = SYSDATE WHERE ID = ?";
  final int[] ids=new int[]{100,200};
  SQLException sex=new SQLException();
  MockControl ctrlPreparedStatement=MockControl.createControl(PreparedStatement.class);
  PreparedStatement mockPreparedStatement=(PreparedStatement)ctrlPreparedStatement.getMock();
  mockPreparedStatement.getConnection();
  ctrlPreparedStatement.setReturnValue(mockConnection);
  mockPreparedStatement.setInt(1,ids[0]);
  ctrlPreparedStatement.setVoidCallable();
  mockPreparedStatement.addBatch();
  ctrlPreparedStatement.setVoidCallable();
  mockPreparedStatement.setInt(1,ids[1]);
  ctrlPreparedStatement.setVoidCallable();
  mockPreparedStatement.addBatch();
  ctrlPreparedStatement.setVoidCallable();
  mockPreparedStatement.executeBatch();
  ctrlPreparedStatement.setThrowable(sex);
  mockPreparedStatement.close();
  ctrlPreparedStatement.setVoidCallable();
  MockControl ctrlDatabaseMetaData=MockControl.createControl(DatabaseMetaData.class);
  DatabaseMetaData mockDatabaseMetaData=(DatabaseMetaData)ctrlDatabaseMetaData.getMock();
  mockDatabaseMetaData.getDatabaseProductName();
  ctrlDatabaseMetaData.setReturnValue("MySQL");
  mockDatabaseMetaData.supportsBatchUpdates();
  ctrlDatabaseMetaData.setReturnValue(true);
  ctrlConnection.reset();
  mockConnection.prepareStatement(sql);
  ctrlConnection.setReturnValue(mockPreparedStatement);
  mockConnection.getMetaData();
  ctrlConnection.setReturnValue(mockDatabaseMetaData,2);
  mockConnection.close();
  ctrlConnection.setVoidCallable(2);
  ctrlPreparedStatement.replay();
  ctrlDatabaseMetaData.replay();
  replay();
  BatchPreparedStatementSetter setter=new BatchPreparedStatementSetter(){
    public void setValues(    PreparedStatement ps,    int i) throws SQLException {
      ps.setInt(1,ids[i]);
    }
    public int getBatchSize(){
      return ids.length;
    }
  }
;
  try {
    JdbcTemplate template=new JdbcTemplate(mockDataSource);
    template.batchUpdate(sql,setter);
    fail("Should have failed because of SQLException in bulk update");
  }
 catch (  DataAccessException ex) {
    assertTrue("Root cause is SQLException",ex.getCause() == sex);
  }
  ctrlPreparedStatement.verify();
  ctrlDatabaseMetaData.verify();
}
