{
  WebApplicationContext webApplicationContext=(WebApplicationContext)request.getAttribute(DispatcherServlet.WEB_APPLICATION_CONTEXT_ATTRIBUTE);
  if (webApplicationContext == null) {
    if (servletContext == null) {
      throw new IllegalStateException("No WebApplicationContext found: not in a DispatcherServlet request?");
    }
    webApplicationContext=WebApplicationContextUtils.getWebApplicationContext(servletContext);
    if (webApplicationContext == null) {
      throw new IllegalStateException("No WebApplicationContext found: no ContextLoaderListener registered?");
    }
  }
  return webApplicationContext;
}
