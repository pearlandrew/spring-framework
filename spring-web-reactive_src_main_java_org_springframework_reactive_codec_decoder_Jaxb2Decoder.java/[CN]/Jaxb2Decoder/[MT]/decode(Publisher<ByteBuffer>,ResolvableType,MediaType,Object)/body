{
  Class<?> outputClass=type.getRawClass();
  try {
    Source source=processSource(new StreamSource(new ByteBufferPublisherInputStream(inputStream)));
    Unmarshaller unmarshaller=createUnmarshaller(outputClass);
    if (outputClass.isAnnotationPresent(XmlRootElement.class)) {
      return Streams.just(unmarshaller.unmarshal(source));
    }
 else {
      JAXBElement<?> jaxbElement=unmarshaller.unmarshal(source,outputClass);
      return Streams.just(jaxbElement.getValue());
    }
  }
 catch (  UnmarshalException ex) {
    return Streams.fail(new CodecException("Could not unmarshal to [" + outputClass + "]: "+ ex.getMessage(),ex));
  }
catch (  JAXBException ex) {
    return Streams.fail(new CodecException("Could not instantiate JAXBContext: " + ex.getMessage(),ex));
  }
}
