{
  StubSockJsServiceConfig sockJsConfig=new StubSockJsServiceConfig();
  this.servletRequest.setContent("[\"x\"]".getBytes("UTF-8"));
  WebSocketHandler wsHandler=mock(WebSocketHandler.class);
  TestHttpSockJsSession session=new TestHttpSockJsSession("1",sockJsConfig,wsHandler,null);
  session.delegateConnectionEstablished();
  doThrow(new Exception()).when(wsHandler).handleMessage(session,new TextMessage("x"));
  try {
    XhrReceivingTransportHandler transportHandler=new XhrReceivingTransportHandler();
    transportHandler.setSockJsServiceConfiguration(sockJsConfig);
    transportHandler.handleRequest(this.request,this.response,wsHandler,session);
    fail("Expected exception");
  }
 catch (  SockJsMessageDeliveryException ex) {
    assertNull(session.getCloseStatus());
  }
}
