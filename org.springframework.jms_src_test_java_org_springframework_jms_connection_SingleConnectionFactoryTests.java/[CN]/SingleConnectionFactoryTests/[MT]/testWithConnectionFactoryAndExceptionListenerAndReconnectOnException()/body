{
  MockControl cfControl=MockControl.createControl(ConnectionFactory.class);
  ConnectionFactory cf=(ConnectionFactory)cfControl.getMock();
  TestConnection con=new TestConnection();
  TestExceptionListener listener=new TestExceptionListener();
  cf.createConnection();
  cfControl.setReturnValue(con,2);
  cfControl.replay();
  SingleConnectionFactory scf=new SingleConnectionFactory(cf);
  scf.setExceptionListener(listener);
  scf.setReconnectOnException(true);
  Connection con1=scf.createConnection();
  assertSame(listener,con1.getExceptionListener());
  con1.start();
  con.getExceptionListener().onException(new JMSException(""));
  Connection con2=scf.createConnection();
  con2.start();
  scf.destroy();
  cfControl.verify();
  assertEquals(2,con.getStartCount());
  assertEquals(2,con.getCloseCount());
  assertEquals(1,listener.getCount());
}
