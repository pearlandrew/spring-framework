{
  if (!resource.getClass().equals(location.getClass())) {
    return false;
  }
  String resourcePath;
  String locationPath;
  if (resource instanceof UrlResource) {
    resourcePath=resource.getURL().toExternalForm();
    locationPath=location.getURL().toExternalForm();
  }
 else   if (resource instanceof ClassPathResource) {
    resourcePath=((ClassPathResource)resource).getPath();
    locationPath=((ClassPathResource)location).getPath();
  }
 else   if (resource instanceof ServletContextResource) {
    resourcePath=((ServletContextResource)resource).getPath();
    locationPath=((ServletContextResource)location).getPath();
  }
 else {
    resourcePath=resource.getURL().getPath();
    locationPath=location.getURL().getPath();
  }
  locationPath=(locationPath.endsWith("/") || locationPath.isEmpty() ? locationPath : locationPath + "/");
  if (!resourcePath.startsWith(locationPath)) {
    return false;
  }
  if (resourcePath.contains("%")) {
    if (URLDecoder.decode(resourcePath,"UTF-8").contains("../")) {
      if (logger.isTraceEnabled()) {
        logger.trace("Resolved resource path contains \"../\" after decoding: " + resourcePath);
      }
      return false;
    }
  }
  return true;
}
