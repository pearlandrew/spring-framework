{
  WebApplicationContext ac=initApplicationContext(WebApplicationContext.SCOPE_REQUEST);
  MockRenderRequest request=new MockRenderRequest();
  PortletRequestAttributes requestAttributes=new PortletRequestAttributes(request);
  RequestContextHolder.setRequestAttributes(requestAttributes);
  try {
    assertNull(request.getAttribute(NAME));
    DerivedTestBean bean=ac.getBean(NAME,DerivedTestBean.class);
    assertSame(bean,request.getAttribute(NAME));
    assertSame(bean,ac.getBean(NAME));
    requestAttributes.requestCompleted();
    assertTrue(bean.wasDestroyed());
  }
  finally {
    RequestContextHolder.setRequestAttributes(null);
  }
}
