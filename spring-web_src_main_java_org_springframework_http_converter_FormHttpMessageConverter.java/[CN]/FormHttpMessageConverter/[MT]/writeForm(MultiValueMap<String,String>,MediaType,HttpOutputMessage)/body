{
  Charset charset;
  if (contentType != null) {
    outputMessage.getHeaders().setContentType(contentType);
    charset=contentType.getCharSet() != null ? contentType.getCharSet() : this.charset;
  }
 else {
    outputMessage.getHeaders().setContentType(MediaType.APPLICATION_FORM_URLENCODED);
    charset=this.charset;
  }
  StringBuilder builder=new StringBuilder();
  for (Iterator<String> nameIterator=form.keySet().iterator(); nameIterator.hasNext(); ) {
    String name=nameIterator.next();
    for (Iterator<String> valueIterator=form.get(name).iterator(); valueIterator.hasNext(); ) {
      String value=valueIterator.next();
      builder.append(URLEncoder.encode(name,charset.name()));
      if (value != null) {
        builder.append('=');
        builder.append(URLEncoder.encode(value,charset.name()));
        if (valueIterator.hasNext()) {
          builder.append('&');
        }
      }
    }
    if (nameIterator.hasNext()) {
      builder.append('&');
    }
  }
  byte[] bytes=builder.toString().getBytes(charset.name());
  outputMessage.getHeaders().setContentLength(bytes.length);
  StreamUtils.copy(bytes,outputMessage.getBody());
}
