{
  PersistenceManagerFactory pmf=lookupPersistenceManagerFactory(request);
  boolean participate=false;
  if (TransactionSynchronizationManager.hasResource(pmf)) {
    participate=true;
  }
 else {
    logger.debug("Opening JDO PersistenceManager in OpenPersistenceManagerInViewFilter");
    PersistenceManager pm=PersistenceManagerFactoryUtils.getPersistenceManager(pmf,true);
    TransactionSynchronizationManager.bindResource(pmf,new PersistenceManagerHolder(pm));
  }
  try {
    filterChain.doFilter(request,response);
  }
  finally {
    if (!participate) {
      PersistenceManagerHolder pmHolder=(PersistenceManagerHolder)TransactionSynchronizationManager.unbindResource(pmf);
      logger.debug("Closing JDO PersistenceManager in OpenPersistenceManagerInViewFilter");
      PersistenceManagerFactoryUtils.releasePersistenceManager(pmHolder.getPersistenceManager(),pmf);
    }
  }
}
