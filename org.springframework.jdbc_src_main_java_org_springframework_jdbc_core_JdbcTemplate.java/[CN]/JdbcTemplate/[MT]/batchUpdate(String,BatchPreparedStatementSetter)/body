{
  if (logger.isDebugEnabled()) {
    logger.debug("Executing SQL batch update [" + sql + "]");
  }
  return (int[])execute(sql,new PreparedStatementCallback(){
    public Object doInPreparedStatement(    PreparedStatement ps) throws SQLException {
      try {
        int batchSize=pss.getBatchSize();
        InterruptibleBatchPreparedStatementSetter ipss=(pss instanceof InterruptibleBatchPreparedStatementSetter ? (InterruptibleBatchPreparedStatementSetter)pss : null);
        if (JdbcUtils.supportsBatchUpdates(ps.getConnection())) {
          for (int i=0; i < batchSize; i++) {
            pss.setValues(ps,i);
            if (ipss != null && ipss.isBatchExhausted(i)) {
              break;
            }
            ps.addBatch();
          }
          return ps.executeBatch();
        }
 else {
          List rowsAffected=new ArrayList();
          for (int i=0; i < batchSize; i++) {
            pss.setValues(ps,i);
            if (ipss != null && ipss.isBatchExhausted(i)) {
              break;
            }
            rowsAffected.add(new Integer(ps.executeUpdate()));
          }
          int[] rowsAffectedArray=new int[rowsAffected.size()];
          for (int i=0; i < rowsAffectedArray.length; i++) {
            rowsAffectedArray[i]=((Integer)rowsAffected.get(i)).intValue();
          }
          return rowsAffectedArray;
        }
      }
  finally {
        if (pss instanceof ParameterDisposer) {
          ((ParameterDisposer)pss).cleanupParameters();
        }
      }
    }
  }
);
}
