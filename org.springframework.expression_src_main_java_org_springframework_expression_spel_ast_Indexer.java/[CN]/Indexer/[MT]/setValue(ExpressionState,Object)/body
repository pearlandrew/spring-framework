{
  TypedValue contextObject=state.getActiveContextObject();
  Object targetObject=contextObject.getValue();
  ConversionContext targetObjectTypeDescriptor=contextObject.getTypeDescriptor();
  TypedValue index=getChild(0).getValueInternal(state);
  if (targetObject == null) {
    throw new SpelException(SpelMessages.CANNOT_INDEX_INTO_NULL_VALUE);
  }
  if (targetObjectTypeDescriptor.isMap()) {
    Map map=(Map)targetObject;
    Object possiblyConvertedKey=state.convertValue(index.getValue(),ConversionContext.valueOf(targetObjectTypeDescriptor.getMapKeyType()));
    Object possiblyConvertedValue=state.convertValue(newValue,ConversionContext.valueOf(targetObjectTypeDescriptor.getMapValueType()));
    map.put(possiblyConvertedKey,possiblyConvertedValue);
    return;
  }
  if (targetObjectTypeDescriptor.isArray()) {
    int idx=(Integer)state.convertValue(index,INTEGER_TYPE_DESCRIPTOR);
    setArrayElement(state,contextObject.getValue(),idx,newValue,targetObjectTypeDescriptor.getElementType());
  }
 else   if (targetObjectTypeDescriptor.isCollection()) {
    int idx=(Integer)state.convertValue(index,INTEGER_TYPE_DESCRIPTOR);
    Collection c=(Collection)targetObject;
    if (idx >= c.size()) {
      throw new SpelException(SpelMessages.COLLECTION_INDEX_OUT_OF_BOUNDS,c.size(),idx);
    }
    if (targetObject instanceof List) {
      List list=(List)targetObject;
      Object possiblyConvertedValue=state.convertValue(newValue,ConversionContext.valueOf(targetObjectTypeDescriptor.getElementType()));
      list.set(idx,possiblyConvertedValue);
    }
 else {
      throw new SpelException(SpelMessages.INDEXING_NOT_SUPPORTED_FOR_TYPE,contextObject.getClass().getName());
    }
  }
 else {
    throw new SpelException(SpelMessages.INDEXING_NOT_SUPPORTED_FOR_TYPE,contextObject.getClass().getName());
  }
}
