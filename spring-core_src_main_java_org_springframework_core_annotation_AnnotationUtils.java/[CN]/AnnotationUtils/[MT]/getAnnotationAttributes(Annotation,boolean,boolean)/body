{
  AnnotationAttributes attrs=new AnnotationAttributes();
  Method[] methods=annotation.annotationType().getDeclaredMethods();
  for (  Method method : methods) {
    if (method.getParameterTypes().length == 0 && method.getReturnType() != void.class) {
      try {
        Object value=method.invoke(annotation);
        if (classValuesAsString) {
          if (value instanceof Class) {
            value=((Class<?>)value).getName();
          }
 else           if (value instanceof Class[]) {
            Class<?>[] clazzArray=(Class[])value;
            String[] newValue=new String[clazzArray.length];
            for (int i=0; i < clazzArray.length; i++) {
              newValue[i]=clazzArray[i].getName();
            }
            value=newValue;
          }
        }
        if (nestedAnnotationsAsMap && value instanceof Annotation) {
          attrs.put(method.getName(),getAnnotationAttributes((Annotation)value,classValuesAsString,nestedAnnotationsAsMap));
        }
 else         if (nestedAnnotationsAsMap && value instanceof Annotation[]) {
          Annotation[] realAnnotations=(Annotation[])value;
          AnnotationAttributes[] mappedAnnotations=new AnnotationAttributes[realAnnotations.length];
          for (int i=0; i < realAnnotations.length; i++) {
            mappedAnnotations[i]=getAnnotationAttributes(realAnnotations[i],classValuesAsString,nestedAnnotationsAsMap);
          }
          attrs.put(method.getName(),mappedAnnotations);
        }
 else {
          attrs.put(method.getName(),value);
        }
      }
 catch (      Exception ex) {
        throw new IllegalStateException("Could not obtain annotation attribute values",ex);
      }
    }
  }
  return attrs;
}
