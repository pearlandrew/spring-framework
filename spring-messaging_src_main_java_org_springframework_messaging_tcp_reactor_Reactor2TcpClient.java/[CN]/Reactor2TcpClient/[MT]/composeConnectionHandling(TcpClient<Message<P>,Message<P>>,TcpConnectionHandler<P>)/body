{
synchronized (this.tcpClients) {
    this.tcpClients.add(tcpClient);
  }
  return new MessageHandler<P>(){
    @Override public Publisher<Void> apply(    ChannelStream<Message<P>,Message<P>> connection){
      Promise<Void> closePromise=Promises.prepare();
      connectionHandler.afterConnected(new Reactor2TcpConnection<P>(connection,closePromise));
      connection.finallyDo(new Consumer<Signal<Message<P>>>(){
        @Override public void accept(        Signal<Message<P>> signal){
          if (signal.isOnError()) {
            connectionHandler.handleFailure(signal.getThrowable());
          }
 else           if (signal.isOnComplete()) {
            connectionHandler.afterConnectionClosed();
          }
        }
      }
).consume(new Consumer<Message<P>>(){
        @Override public void accept(        Message<P> message){
          connectionHandler.handleMessage(message);
        }
      }
);
      return closePromise;
    }
  }
;
}
