{
  try {
    for (    String pkg : packagesToScan) {
      String pattern=ResourcePatternResolver.CLASSPATH_ALL_URL_PREFIX + ClassUtils.convertClassNameToResourcePath(pkg) + RESOURCE_PATTERN;
      Resource[] resources=this.resourcePatternResolver.getResources(pattern);
      MetadataReaderFactory readerFactory=new CachingMetadataReaderFactory(this.resourcePatternResolver);
      for (      Resource resource : resources) {
        if (resource.isReadable()) {
          MetadataReader reader=readerFactory.getMetadataReader(resource);
          String className=reader.getClassMetadata().getClassName();
          if (matchesEntityTypeFilter(reader,readerFactory)) {
            addAnnotatedClass(this.resourcePatternResolver.getClassLoader().loadClass(className));
          }
 else           if (className.endsWith(PACKAGE_INFO_SUFFIX)) {
            addPackage(className.substring(0,className.length() - PACKAGE_INFO_SUFFIX.length()));
          }
        }
      }
    }
    return this;
  }
 catch (  IOException ex) {
    throw new MappingException("Failed to scan classpath for unlisted classes",ex);
  }
catch (  ClassNotFoundException ex) {
    throw new MappingException("Failed to load annotated classes from classpath",ex);
  }
}
