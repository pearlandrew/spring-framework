{
  SimpMessageHeaderAccessor headers=SimpMessageHeaderAccessor.wrap(message);
  SimpMessageType messageType=headers.getMessageType();
  String destination=headers.getDestination();
  if (!checkDestinationPrefix(destination)) {
    if (logger.isTraceEnabled()) {
      logger.trace("Ingoring message with destination " + destination);
    }
    return;
  }
  if (SimpMessageType.SUBSCRIBE.equals(messageType)) {
    this.subscriptionRegistry.registerSubscription(message);
  }
 else   if (SimpMessageType.UNSUBSCRIBE.equals(messageType)) {
    this.subscriptionRegistry.unregisterSubscription(message);
  }
 else   if (SimpMessageType.MESSAGE.equals(messageType)) {
    sendMessageToSubscribers(headers.getDestination(),message);
  }
 else   if (SimpMessageType.DISCONNECT.equals(messageType)) {
    String sessionId=headers.getSessionId();
    this.subscriptionRegistry.unregisterAllSubscriptions(sessionId);
  }
 else   if (SimpMessageType.CONNECT.equals(messageType)) {
    String sessionId=headers.getSessionId();
    SimpMessageHeaderAccessor connectAckHeaders=SimpMessageHeaderAccessor.create(SimpMessageType.CONNECT_ACK);
    connectAckHeaders.setSessionId(sessionId);
    connectAckHeaders.setHeader(SimpMessageHeaderAccessor.CONNECT_MESSAGE_HEADER,message);
    Message<byte[]> connectAck=MessageBuilder.withPayloadAndHeaders(EMPTY_PAYLOAD,connectAckHeaders).build();
    this.messageChannel.send(connectAck);
  }
}
