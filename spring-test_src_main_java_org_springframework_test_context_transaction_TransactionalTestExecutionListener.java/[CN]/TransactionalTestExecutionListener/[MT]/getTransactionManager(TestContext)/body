{
  BeanFactory bf=testContext.getApplicationContext().getAutowireCapableBeanFactory();
  String tmName=retrieveConfigurationAttributes(testContext).getTransactionManagerName();
  try {
    if (StringUtils.hasText(tmName) && !DEFAULT_TRANSACTION_MANAGER_NAME.equals(tmName)) {
      return bf.getBean(tmName,PlatformTransactionManager.class);
    }
    if (bf instanceof ListableBeanFactory) {
      ListableBeanFactory lbf=(ListableBeanFactory)bf;
      Map<String,PlatformTransactionManager> beansOfType=BeanFactoryUtils.beansOfTypeIncludingAncestors(lbf,PlatformTransactionManager.class);
      if (beansOfType.size() == 1) {
        return beansOfType.values().iterator().next();
      }
    }
    return bf.getBean(DEFAULT_TRANSACTION_MANAGER_NAME,PlatformTransactionManager.class);
  }
 catch (  BeansException ex) {
    if (logger.isWarnEnabled()) {
      logger.warn("Caught exception while retrieving transaction manager for test context " + testContext,ex);
    }
    throw ex;
  }
}
