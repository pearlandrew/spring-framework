{
  WebApplicationContext webApplicationContext=(WebApplicationContext)context.getRequestScope().get(DispatcherServlet.WEB_APPLICATION_CONTEXT_ATTRIBUTE);
  if (webApplicationContext == null) {
    webApplicationContext=(WebApplicationContext)context.getApplicationContext().getApplicationScope().get(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE);
    if (webApplicationContext == null) {
      throw new IllegalStateException("No WebApplicationContext found: no ContextLoaderListener registered?");
    }
  }
  return getPreparer(name,webApplicationContext);
}
