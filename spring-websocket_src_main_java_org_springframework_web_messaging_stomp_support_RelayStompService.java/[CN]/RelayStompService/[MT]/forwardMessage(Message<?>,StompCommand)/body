{
  StompHeaders stompHeaders=new StompHeaders(message.getHeaders(),false);
  String sessionId=stompHeaders.getSessionId();
  RelaySession session=RelayStompService.this.relaySessions.get(sessionId);
  Assert.notNull(session,"RelaySession not found");
  try {
    if (stompHeaders.getProtocolMessageType() == null) {
      stompHeaders.setProtocolMessageType(StompCommand.SEND);
    }
    MediaType contentType=stompHeaders.getContentType();
    byte[] payload=this.payloadConverter.convertToPayload(message.getPayload(),contentType);
    Message<byte[]> byteMessage=new GenericMessage<byte[]>(payload,stompHeaders.getMessageHeaders());
    if (logger.isTraceEnabled()) {
      logger.trace("Forwarding: " + byteMessage);
    }
    byte[] bytes=this.stompMessageConverter.fromMessage(byteMessage);
    session.getOutputStream().write(bytes);
    session.getOutputStream().flush();
  }
 catch (  Exception ex) {
    logger.error("Couldn't forward message",ex);
    clearRelaySession(sessionId);
  }
}
