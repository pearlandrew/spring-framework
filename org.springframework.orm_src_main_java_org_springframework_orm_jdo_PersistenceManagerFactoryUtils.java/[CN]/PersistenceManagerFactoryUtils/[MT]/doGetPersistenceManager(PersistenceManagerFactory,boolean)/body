{
  Assert.notNull(pmf,"No PersistenceManagerFactory specified");
  PersistenceManagerHolder pmHolder=(PersistenceManagerHolder)TransactionSynchronizationManager.getResource(pmf);
  if (pmHolder != null) {
    if (!pmHolder.isSynchronizedWithTransaction() && TransactionSynchronizationManager.isSynchronizationActive()) {
      pmHolder.setSynchronizedWithTransaction(true);
      TransactionSynchronizationManager.registerSynchronization(new PersistenceManagerSynchronization(pmHolder,pmf,false));
    }
    return pmHolder.getPersistenceManager();
  }
  if (!allowCreate && !TransactionSynchronizationManager.isSynchronizationActive()) {
    throw new IllegalStateException("No JDO PersistenceManager bound to thread, " + "and configuration does not allow creation of non-transactional one here");
  }
  logger.debug("Opening JDO PersistenceManager");
  PersistenceManager pm=pmf.getPersistenceManager();
  if (TransactionSynchronizationManager.isSynchronizationActive()) {
    logger.debug("Registering transaction synchronization for JDO PersistenceManager");
    pmHolder=new PersistenceManagerHolder(pm);
    pmHolder.setSynchronizedWithTransaction(true);
    TransactionSynchronizationManager.registerSynchronization(new PersistenceManagerSynchronization(pmHolder,pmf,true));
    TransactionSynchronizationManager.bindResource(pmf,pmHolder);
  }
  return pm;
}
