{
  if (isRequestActive()) {
    PortletSession session=this.request.getPortletSession(allowCreate);
    this.session=session;
    return session;
  }
 else {
    PortletSession session=this.session;
    if (session == null) {
      if (allowCreate) {
        throw new IllegalStateException("No session found and request already completed - cannot create new session!");
      }
 else {
        session=this.request.getPortletSession(false);
        this.session=session;
      }
    }
    return session;
  }
}
