{
  this.brokerRelay.start();
  String sessionId="sess1";
  StompHeaderAccessor headers=StompHeaderAccessor.create(StompCommand.CONNECT);
  headers.setSessionId(sessionId);
  headers.setUser(new TestPrincipal("joe"));
  this.brokerRelay.handleMessage(MessageBuilder.createMessage(new byte[0],headers.getMessageHeaders()));
  List<Message<byte[]>> sent=this.tcpClient.connection.messages;
  assertEquals(2,sent.size());
  StompHeaderAccessor responseHeaders=StompHeaderAccessor.create(StompCommand.MESSAGE);
  responseHeaders.setLeaveMutable(true);
  Message<byte[]> response=MessageBuilder.createMessage(new byte[0],responseHeaders.getMessageHeaders());
  this.tcpClient.connectionHandler.handleMessage(response);
  Message<byte[]> actual=this.outboundChannel.getMessages().get(0);
  StompHeaderAccessor actualHeaders=StompHeaderAccessor.getAccessor(actual,StompHeaderAccessor.class);
  assertEquals(sessionId,actualHeaders.getSessionId());
  assertEquals("joe",actualHeaders.getUser().getName());
}
