{
  StompCommand command=headers.getCommand();
  Map<String,List<String>> stompHeaders=headers.toStompHeaderMap();
  boolean shouldEscape=(command != StompCommand.CONNECT && command != StompCommand.CONNECTED);
  if (logger.isDebugEnabled()) {
    logger.debug("Encoded STOMP " + command + ", headers="+ stompHeaders);
  }
  for (  Entry<String,List<String>> entry : stompHeaders.entrySet()) {
    byte[] key=encodeHeaderString(entry.getKey(),shouldEscape);
    for (    String value : entry.getValue()) {
      output.write(key);
      output.write(COLON);
      output.write(encodeHeaderString(value,shouldEscape));
      output.write(LF);
    }
  }
  if (command.requiresContentLength()) {
    int contentLength=message.getPayload().length;
    output.write("content-length:".getBytes(UTF8_CHARSET));
    output.write(Integer.toString(contentLength).getBytes(UTF8_CHARSET));
    output.write(LF);
  }
}
