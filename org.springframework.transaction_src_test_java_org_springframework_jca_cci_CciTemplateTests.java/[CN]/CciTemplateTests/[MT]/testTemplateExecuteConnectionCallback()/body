{
  ConnectionFactory connectionFactory=createMock(ConnectionFactory.class);
  Connection connection=createMock(Connection.class);
  ConnectionCallback<?> connectionCallback=createMock(ConnectionCallback.class);
  expect(connectionFactory.getConnection()).andReturn(connection);
  expect(connectionCallback.doInConnection(connection,connectionFactory)).andStubReturn(new Object());
  connection.close();
  replay(connectionFactory,connection,connectionCallback);
  CciTemplate ct=new CciTemplate(connectionFactory);
  ct.execute(connectionCallback);
  verify(connectionFactory,connection,connectionCallback);
}
