{
  if (httpServerSession.isNew()) {
    logger.debug("Opening " + getTransportType() + " connection");
    httpServerSession.setInitialRequest(request,response,getFrameFormat(request));
  }
 else   if (!httpServerSession.isActive()) {
    logger.debug("starting " + getTransportType() + " async request");
    httpServerSession.setLongPollingRequest(request,response,getFrameFormat(request));
  }
 else {
    try {
      logger.debug("another " + getTransportType() + " connection still open: "+ httpServerSession);
      SockJsFrame closeFrame=SockJsFrame.closeFrameAnotherConnectionOpen();
      response.getBody().write(getFrameFormat(request).format(closeFrame).getContentBytes());
    }
 catch (    IOException e) {
      throw new TransportErrorException("Failed to send SockJS close frame",e,httpServerSession.getId());
    }
  }
}
