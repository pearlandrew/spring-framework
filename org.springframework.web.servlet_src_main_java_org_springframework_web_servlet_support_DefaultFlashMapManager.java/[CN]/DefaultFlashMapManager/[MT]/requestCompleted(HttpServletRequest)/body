{
  FlashMap flashMap=(FlashMap)request.getAttribute(OUTPUT_FLASH_MAP_ATTRIBUTE);
  if (flashMap == null) {
    throw new IllegalStateException("Did not find a FlashMap exposed as the request attribute " + OUTPUT_FLASH_MAP_ATTRIBUTE);
  }
  if (!flashMap.isEmpty()) {
    if (logger.isDebugEnabled()) {
      logger.debug("Saving FlashMap=" + flashMap);
    }
    List<FlashMap> allFlashMaps=retrieveFlashMaps(request,true);
    flashMap.startExpirationPeriod(this.flashTimeout);
    allFlashMaps.add(flashMap);
  }
}
