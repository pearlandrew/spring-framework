{
  FlashMap flashMap=(FlashMap)request.getAttribute(OUTPUT_FLASH_MAP_ATTRIBUTE);
  if (flashMap == null) {
    throw new IllegalStateException("Did not find a FlashMap exposed as the request attribute " + OUTPUT_FLASH_MAP_ATTRIBUTE);
  }
  if (!flashMap.isEmpty() && flashMap.isCreatedBy(this.hashCode())) {
    if (logger.isDebugEnabled()) {
      logger.debug("Saving FlashMap=" + flashMap);
    }
    decodeAndNormalizeTargetPath(flashMap,request);
    flashMap.startExpirationPeriod(this.flashTimeout);
    retrieveFlashMaps(request,true).add(flashMap);
  }
}
