{
  skipLeadingEol(buffer);
  Message<byte[]> decodedMessage;
  String command=readCommand(buffer);
  if (command.length() > 0) {
    MultiValueMap<String,String> headers=readHeaders(buffer);
    byte[] payload=readPayload(buffer,headers);
    decodedMessage=MessageBuilder.withPayload(payload).setHeaders(StompHeaderAccessor.create(StompCommand.valueOf(command),headers)).build();
  }
 else {
    decodedMessage=MessageBuilder.withPayload(HEARTBEAT_PAYLOAD).setHeaders(StompHeaderAccessor.create(SimpMessageType.HEARTBEAT)).build();
  }
  if (logger.isTraceEnabled()) {
    logger.trace("Decoded " + decodedMessage);
  }
  return decodedMessage;
}
