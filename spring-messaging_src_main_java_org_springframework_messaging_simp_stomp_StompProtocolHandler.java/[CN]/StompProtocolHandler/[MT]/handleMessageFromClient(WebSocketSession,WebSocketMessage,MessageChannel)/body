{
  Message<?> message;
  try {
    Assert.isInstanceOf(TextMessage.class,webSocketMessage);
    String payload=((TextMessage)webSocketMessage).getPayload();
    ByteBuffer byteBuffer=ByteBuffer.wrap(payload.getBytes(Charset.forName("UTF-8")));
    message=this.stompDecoder.decode(byteBuffer);
  }
 catch (  Throwable error) {
    logger.error("Failed to parse STOMP frame, WebSocket message payload: ",error);
    sendErrorMessage(session,error);
    return;
  }
  try {
    StompHeaderAccessor headers=StompHeaderAccessor.wrap(message);
    if (SimpMessageType.HEARTBEAT.equals(headers.getMessageType())) {
      logger.trace("Received heartbeat from client session=" + session.getId());
    }
 else {
      logger.trace("Received message from client session=" + session.getId());
    }
    headers.setSessionId(session.getId());
    headers.setUser(session.getPrincipal());
    message=MessageBuilder.withPayload(message.getPayload()).setHeaders(headers).build();
    outputChannel.send(message);
  }
 catch (  Throwable t) {
    logger.error("Terminating STOMP session due to failure to send message: ",t);
    sendErrorMessage(session,t);
  }
}
