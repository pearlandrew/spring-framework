{
  this.factory=new WebSocketServerFactory();
  this.factory.setCreator(new WebSocketCreator(){
    @Override @SuppressWarnings("unchecked") public Object createWebSocket(    UpgradeRequest req,    UpgradeResponse resp){
      Assert.isInstanceOf(ServletWebSocketRequest.class,req);
      ServletWebSocketRequest servletRequest=(ServletWebSocketRequest)req;
      HandlerProvider<WebSocketHandler> handlerProvider=(HandlerProvider<WebSocketHandler>)servletRequest.getServletAttributes().get(HANDLER_PROVIDER);
      return new WebSocketHandlerAdapter(handlerProvider);
    }
  }
);
  try {
    this.factory.init();
  }
 catch (  Exception ex) {
    throw new IllegalStateException(ex);
  }
}
