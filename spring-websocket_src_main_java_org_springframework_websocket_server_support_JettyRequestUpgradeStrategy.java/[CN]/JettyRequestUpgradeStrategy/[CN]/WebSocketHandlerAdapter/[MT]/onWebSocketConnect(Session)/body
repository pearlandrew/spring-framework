{
  Assert.isTrue(this.sessionCount.compareAndSet(0,1),"Unexpected connection");
  this.session=new WebSocketSessionAdapter(session);
  if (logger.isDebugEnabled()) {
    logger.debug("Connection established, WebSocket session id=" + this.session.getId() + ", uri="+ this.session.getURI());
  }
  this.handler=this.provider.getHandler();
  try {
    this.handler.afterConnectionEstablished(this.session);
  }
 catch (  Throwable ex) {
    tryCloseWithError(ex);
  }
}
