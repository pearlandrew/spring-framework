{
  Assert.state(this.session == null,"WebSocket already open");
  try {
    this.session=new WebSocketSessionAdapter(session);
    if (logger.isDebugEnabled()) {
      logger.debug("Connection established, WebSocket session id=" + this.session.getId() + ", uri="+ this.session.getURI());
    }
    this.handler=this.provider.getHandler();
    this.handler.afterConnectionEstablished(this.session);
  }
 catch (  Exception ex) {
    try {
      onWebSocketError(ex);
    }
  finally {
      this.session=null;
      this.handler=null;
    }
  }
}
