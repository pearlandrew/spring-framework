{
  long startTime=System.currentTimeMillis();
  Throwable failureCause=null;
  LocaleContext previousLocaleContext=LocaleContextHolder.getLocaleContext();
  LocaleContext localeContext=buildLocaleContext(request);
  RequestAttributes previousAttributes=RequestContextHolder.getRequestAttributes();
  ServletRequestAttributes requestAttributes=null;
  if (previousAttributes == null || previousAttributes.getClass().equals(ServletRequestAttributes.class)) {
    requestAttributes=new ServletRequestAttributes(request);
  }
  initContextHolders(request,localeContext,requestAttributes);
  AsyncExecutionChain chain=AsyncExecutionChain.getForCurrentRequest(request);
  chain.addDelegatingCallable(getAsyncCallable(startTime,request,response,previousLocaleContext,previousAttributes,localeContext,requestAttributes));
  try {
    doService(request,response);
  }
 catch (  Throwable t) {
    failureCause=t;
  }
 finally {
    resetContextHolders(request,previousLocaleContext,previousAttributes);
    if (chain.isAsyncStarted()) {
      return;
    }
    finalizeProcessing(startTime,request,response,requestAttributes,failureCause);
  }
}
