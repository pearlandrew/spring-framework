{
  ClassPathBeanDefinitionScanner scanner=new ClassPathBeanDefinitionScanner(registry,(Boolean)componentScanAttributes.get("useDefaultFilters"));
  Assert.notNull(this.environment,"Environment must not be null");
  scanner.setEnvironment(this.environment);
  Assert.notNull(this.resourceLoader,"ResourceLoader must not be null");
  scanner.setResourceLoader(this.resourceLoader);
  scanner.setBeanNameGenerator(BeanUtils.instantiateClass((Class<?>)componentScanAttributes.get("nameGenerator"),BeanNameGenerator.class));
  ScopedProxyMode scopedProxyMode=(ScopedProxyMode)componentScanAttributes.get("scopedProxy");
  if (scopedProxyMode != ScopedProxyMode.DEFAULT) {
    scanner.setScopedProxyMode(scopedProxyMode);
  }
 else {
    scanner.setScopeMetadataResolver(BeanUtils.instantiateClass((Class<?>)componentScanAttributes.get("scopeResolver"),ScopeMetadataResolver.class));
  }
  scanner.setResourcePattern((String)componentScanAttributes.get("resourcePattern"));
  for (  Filter filter : (Filter[])componentScanAttributes.get("includeFilters")) {
    scanner.addIncludeFilter(createTypeFilter(filter));
  }
  for (  Filter filter : (Filter[])componentScanAttributes.get("excludeFilters")) {
    scanner.addExcludeFilter(createTypeFilter(filter));
  }
  List<String> basePackages=new ArrayList<String>();
  for (  String pkg : (String[])componentScanAttributes.get("value")) {
    if (StringUtils.hasText(pkg)) {
      basePackages.add(pkg);
    }
  }
  for (  String pkg : (String[])componentScanAttributes.get("basePackages")) {
    if (StringUtils.hasText(pkg)) {
      basePackages.add(pkg);
    }
  }
  for (  Class<?> clazz : (Class<?>[])componentScanAttributes.get("basePackageClasses")) {
    basePackages.add(clazz.getPackage().getName());
  }
  if (basePackages.isEmpty()) {
    throw new IllegalStateException("At least one base package must be specified");
  }
  return scanner.doScan(basePackages.toArray(new String[]{}));
}
