{
  String macro=fetchMacro(name);
  assertNotNull(macro);
  FileSystemResource resource=new FileSystemResource(System.getProperty("java.io.tmpdir") + "/tmp.ftl");
  FileCopyUtils.copy("<#import \"spring.ftl\" as spring />\n" + macro,new FileWriter(resource.getPath()));
  DummyMacroRequestContext rc=new DummyMacroRequestContext(request);
  Map<String,String> msgMap=new HashMap<>();
  msgMap.put("hello","Howdy");
  msgMap.put("world","Mundo");
  rc.setMessageMap(msgMap);
  Map<String,String> themeMsgMap=new HashMap<>();
  themeMsgMap.put("hello","Howdy!");
  themeMsgMap.put("world","Mundo!");
  rc.setThemeMessageMap(themeMsgMap);
  rc.setContextPath("/springtest");
  TestBean darren=new TestBean("Darren",99);
  TestBean fred=new TestBean("Fred");
  fred.setJedi(true);
  darren.setSpouse(fred);
  darren.setJedi(true);
  darren.setStringArray(new String[]{"John","Fred"});
  request.setAttribute("command",darren);
  Map<String,String> names=new HashMap<>();
  names.put("Darren","Darren Davison");
  names.put("John","John Doe");
  names.put("Fred","Fred Bloggs");
  names.put("Rob&Harrop","Rob Harrop");
  Configuration config=fc.getConfiguration();
  Map<String,Object> model=new HashMap<>();
  model.put("command",darren);
  model.put("springMacroRequestContext",rc);
  model.put("msgArgs",new Object[]{"World"});
  model.put("nameOptionMap",names);
  model.put("options",names.values());
  FreeMarkerView view=new FreeMarkerView();
  view.setBeanName("myView");
  view.setUrl("tmp.ftl");
  view.setExposeSpringMacroHelpers(false);
  view.setConfiguration(config);
  view.setServletContext(new MockServletContext());
  view.render(model,request,response);
  String output=response.getContentAsString();
  output=output.replace("\r\n","\n");
  return output.trim();
}
