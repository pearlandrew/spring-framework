{
  Collection sourceCollection=(Collection)source;
  Object firstNotNullElement=getFirstNotNullElement(sourceCollection);
  if (firstNotNullElement == null) {
    return compatibleCollectionWithoutElementConversion(sourceCollection,targetType);
  }
  Class targetElementType=targetType.getElementType();
  if (targetElementType == null || targetElementType.isAssignableFrom(firstNotNullElement.getClass())) {
    return compatibleCollectionWithoutElementConversion(sourceCollection,targetType);
  }
  Collection targetCollection=CollectionFactory.createCollection(targetType.getType(),sourceCollection.size());
  GenericConverter elementConverter=conversionService.getConverter(firstNotNullElement.getClass(),TypeDescriptor.valueOf(targetElementType));
  for (  Object element : sourceCollection) {
    targetCollection.add(elementConverter.convert(element,TypeDescriptor.valueOf(targetElementType)));
  }
  return targetCollection;
}
