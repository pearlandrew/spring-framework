{
  Collection sourceCollection=(Collection)source;
  Class targetElementType=targetType.getElementType();
  if (targetElementType == null) {
    return compatibleCollectionWithoutElementConversion(sourceCollection,targetType);
  }
  Class sourceElementType=getElementType(sourceCollection);
  if (sourceElementType == null || targetElementType.isAssignableFrom(sourceElementType)) {
    return compatibleCollectionWithoutElementConversion(sourceCollection,targetType);
  }
  Collection targetCollection=CollectionFactory.createCollection(targetType.getType(),sourceCollection.size());
  TypeDescriptor targetElementTypeDescriptor=TypeDescriptor.valueOf(targetElementType);
  GenericConverter elementConverter=conversionService.getConverter(sourceElementType,targetElementTypeDescriptor);
  for (  Object element : sourceCollection) {
    targetCollection.add(elementConverter.convert(element,targetElementTypeDescriptor));
  }
  return targetCollection;
}
