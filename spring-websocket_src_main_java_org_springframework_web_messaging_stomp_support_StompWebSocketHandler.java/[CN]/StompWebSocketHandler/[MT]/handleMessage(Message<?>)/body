{
  StompHeaderAccessor headers=StompHeaderAccessor.wrap(message);
  headers.setStompCommandIfNotSet(StompCommand.MESSAGE);
  if (StompCommand.CONNECTED.equals(headers.getStompCommand())) {
    return;
  }
  String sessionId=headers.getSessionId();
  if (sessionId == null) {
    logger.error("No \"sessionId\" header in message: " + message);
    return;
  }
  WebSocketSession session=this.sessions.get(sessionId);
  if (session == null) {
    logger.error("WebSocketSession not found for sessionId=" + sessionId);
    return;
  }
  if (headers.getSubscriptionId() == null) {
    logger.error("No subscription id: " + message);
    return;
  }
  byte[] payload;
  try {
    MediaType contentType=headers.getContentType();
    payload=payloadConverter.convertToPayload(message.getPayload(),contentType);
  }
 catch (  Throwable t) {
    logger.error("Failed to send " + message,t);
    return;
  }
  try {
    Message<?> byteMessage=MessageBuilder.withPayload(payload).copyHeaders(headers.toMap()).build();
    byte[] bytes=getStompMessageConverter().fromMessage(byteMessage);
    session.sendMessage(new TextMessage(new String(bytes,Charset.forName("UTF-8"))));
  }
 catch (  Throwable t) {
    sendErrorMessage(session,t);
  }
 finally {
    if (StompCommand.ERROR.equals(headers.getStompCommand())) {
      try {
        session.close(CloseStatus.PROTOCOL_ERROR);
      }
 catch (      IOException e) {
      }
    }
  }
}
