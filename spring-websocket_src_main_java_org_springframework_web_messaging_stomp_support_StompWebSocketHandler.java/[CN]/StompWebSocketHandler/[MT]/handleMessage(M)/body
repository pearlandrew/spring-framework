{
  StompHeaders headers=StompHeaders.fromMessageHeaders(message.getHeaders());
  headers.setStompCommandIfNotSet(StompCommand.MESSAGE);
  if (StompCommand.CONNECTED.equals(headers.getStompCommand())) {
    return;
  }
  String sessionId=headers.getSessionId();
  if (sessionId == null) {
    logger.error("No \"sessionId\" header in message: " + message);
  }
  WebSocketSession session=getWebSocketSession(sessionId);
  if (session == null) {
    logger.error("Session not found: " + message);
  }
  byte[] payload;
  try {
    MediaType contentType=headers.getContentType();
    payload=payloadConverter.convertToPayload(message.getPayload(),contentType);
  }
 catch (  Throwable t) {
    logger.error("Failed to send " + message,t);
    return;
  }
  try {
    @SuppressWarnings("unchecked") M byteMessage=(M)MessageBuilder.fromPayloadAndHeaders(payload,headers.toMessageHeaders()).build();
    byte[] bytes=getStompMessageConverter().fromMessage(byteMessage);
    session.sendMessage(new TextMessage(new String(bytes,Charset.forName("UTF-8"))));
  }
 catch (  Throwable t) {
    sendErrorMessage(session,t);
  }
 finally {
    if (StompCommand.ERROR.equals(headers.getStompCommand())) {
      try {
        session.close(CloseStatus.PROTOCOL_ERROR);
      }
 catch (      IOException e) {
      }
    }
  }
}
