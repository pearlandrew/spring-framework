{
  StompHeaders stompHeaders=StompHeaders.fromMessageHeaders(message.getHeaders());
  stompHeaders.setStompCommandIfNotSet(StompCommand.MESSAGE);
  if (StompCommand.CONNECTED.equals(stompHeaders.getStompCommand())) {
    return;
  }
  String sessionId=stompHeaders.getSessionId();
  if (sessionId == null) {
    logger.error("No \"sessionId\" header in message: " + message);
  }
  WebSocketSession session=getWebSocketSession(sessionId);
  if (session == null) {
    logger.error("Session not found: " + message);
  }
  byte[] payload;
  try {
    MediaType contentType=stompHeaders.getContentType();
    payload=payloadConverter.convertToPayload(message.getPayload(),contentType);
  }
 catch (  Throwable t) {
    logger.error("Failed to send " + message,t);
    return;
  }
  try {
    Map<String,Object> messageHeaders=stompHeaders.toMessageHeaders();
    Message<byte[]> byteMessage=messageFactory.createMessage(payload,messageHeaders);
    byte[] bytes=getStompMessageConverter().fromMessage(byteMessage);
    session.sendMessage(new TextMessage(new String(bytes,Charset.forName("UTF-8"))));
  }
 catch (  Throwable t) {
    sendErrorMessage(session,t);
  }
 finally {
    if (StompCommand.ERROR.equals(stompHeaders.getStompCommand())) {
      try {
        session.close(CloseStatus.PROTOCOL_ERROR);
      }
 catch (      IOException e) {
      }
    }
  }
}
