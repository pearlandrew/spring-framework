{
  logger.debug("Registering Tiles 2.2 AttributeEvaluatorFactory for JSP 2.1");
  try {
    ClassLoader cl=TilesElActivator.class.getClassLoader();
    Class aef=cl.loadClass("org.apache.tiles.evaluator.AttributeEvaluatorFactory");
    Class baef=cl.loadClass("org.apache.tiles.evaluator.BasicAttributeEvaluatorFactory");
    Constructor baefCtor=baef.getConstructor(AttributeEvaluator.class);
    ELAttributeEvaluator evaluator=new ELAttributeEvaluator();
    evaluator.setApplicationContext(container.getApplicationContext());
    evaluator.init(new HashMap<String,String>());
    Object baefValue=baefCtor.newInstance(evaluator);
    Method setter=container.getClass().getMethod("setAttributeEvaluatorFactory",aef);
    setter.invoke(container,baefValue);
    Method getRequestContextFactory=BasicTilesContainer.class.getDeclaredMethod("getRequestContextFactory");
    getRequestContextFactory.setAccessible(true);
    Method createRendererFactory=BasicTilesContainerFactory.class.getDeclaredMethod("createRendererFactory",TilesApplicationContext.class,TilesRequestContextFactory.class,TilesContainer.class,aef);
    createRendererFactory.setAccessible(true);
    BasicTilesContainerFactory tcf=new BasicTilesContainerFactory();
    RendererFactory rendererFactory=(RendererFactory)createRendererFactory.invoke(tcf,container.getApplicationContext(),getRequestContextFactory.invoke(container),container,baefValue);
    container.setRendererFactory(rendererFactory);
  }
 catch (  Exception ex) {
    throw new IllegalStateException("Cannot activate ELAttributeEvaluator",ex);
  }
}
