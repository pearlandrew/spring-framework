{
  JasperReport report=getReport();
  if (report == null) {
    throw new IllegalStateException("No main report defined for 'fillReport' - " + "specify a 'url' on this view or override 'getReport()' or 'fillReport(Map)'");
  }
  JRDataSource jrDataSource=null;
  DataSource jdbcDataSourceToUse=null;
  if (this.reportDataKey != null) {
    Object reportDataValue=model.get(this.reportDataKey);
    if (reportDataValue instanceof DataSource) {
      jdbcDataSourceToUse=(DataSource)reportDataValue;
    }
 else {
      jrDataSource=convertReportData(reportDataValue);
    }
  }
 else {
    Collection<?> values=model.values();
    jrDataSource=CollectionUtils.findValueOfType(values,JRDataSource.class);
    if (jrDataSource == null) {
      JRDataSourceProvider provider=CollectionUtils.findValueOfType(values,JRDataSourceProvider.class);
      if (provider != null) {
        jrDataSource=createReport(provider);
      }
 else {
        jdbcDataSourceToUse=CollectionUtils.findValueOfType(values,DataSource.class);
        if (jdbcDataSourceToUse == null) {
          jdbcDataSourceToUse=this.jdbcDataSource;
        }
      }
    }
  }
  if (jdbcDataSourceToUse != null) {
    return doFillReport(report,model,jdbcDataSourceToUse);
  }
 else {
    if (jrDataSource == null) {
      jrDataSource=getReportData(model);
    }
    if (jrDataSource != null) {
      if (logger.isDebugEnabled()) {
        logger.debug("Filling report with JRDataSource [" + jrDataSource + "]");
      }
      return JasperFillManager.fillReport(report,model,jrDataSource);
    }
 else {
      logger.debug("Filling report with plain model");
      return JasperFillManager.fillReport(report,model);
    }
  }
}
