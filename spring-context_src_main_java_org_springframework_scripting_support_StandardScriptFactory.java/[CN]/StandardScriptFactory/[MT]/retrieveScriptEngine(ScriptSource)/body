{
  ScriptEngineManager scriptEngineManager=new ScriptEngineManager(this.beanClassLoader);
  if (this.scriptEngineName != null) {
    ScriptEngine engine=scriptEngineManager.getEngineByName(this.scriptEngineName);
    if (engine == null) {
      throw new IllegalStateException("Script engine named '" + this.scriptEngineName + "' not found");
    }
    return engine;
  }
  if (scriptSource instanceof ResourceScriptSource) {
    String filename=((ResourceScriptSource)scriptSource).getResource().getFilename();
    if (filename != null) {
      String extension=StringUtils.getFilenameExtension(filename);
      if (extension != null) {
        ScriptEngine engine=scriptEngineManager.getEngineByExtension(extension);
        if (engine != null) {
          return engine;
        }
      }
    }
  }
  return null;
}
