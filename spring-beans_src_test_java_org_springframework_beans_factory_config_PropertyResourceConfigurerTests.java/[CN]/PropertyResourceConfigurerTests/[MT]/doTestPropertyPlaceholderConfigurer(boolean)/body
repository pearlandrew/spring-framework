{
  Map singletonMap=Collections.singletonMap("myKey","myValue");
  if (parentChildSeparation) {
    MutablePropertyValues pvs1=new MutablePropertyValues();
    pvs1.add("age","${age}");
    MutablePropertyValues pvs2=new MutablePropertyValues();
    pvs2.add("name","name${var}${var}${");
    pvs2.add("spouse",new RuntimeBeanReference("${ref}"));
    pvs2.add("someMap",singletonMap);
    RootBeanDefinition parent=new RootBeanDefinition(TestBean.class);
    parent.setPropertyValues(pvs1);
    ChildBeanDefinition bd=new ChildBeanDefinition("${parent}",pvs2);
    factory.registerBeanDefinition("parent1",parent);
    factory.registerBeanDefinition("tb1",bd);
  }
 else {
    MutablePropertyValues pvs=new MutablePropertyValues();
    pvs.add("age","${age}");
    pvs.add("name","name${var}${var}${");
    pvs.add("spouse",new RuntimeBeanReference("${ref}"));
    pvs.add("someMap",singletonMap);
    RootBeanDefinition bd=new RootBeanDefinition(TestBean.class);
    bd.setPropertyValues(pvs);
    factory.registerBeanDefinition("tb1",bd);
  }
  ConstructorArgumentValues cas=new ConstructorArgumentValues();
  cas.addIndexedArgumentValue(1,"${age}");
  cas.addGenericArgumentValue("${var}name${age}");
  MutablePropertyValues pvs=new MutablePropertyValues();
  pvs.add("stringArray",new String[]{"${os.name}","${age}"});
  List<Object> friends=new ManagedList<>();
  friends.add("na${age}me");
  friends.add(new RuntimeBeanReference("${ref}"));
  pvs.add("friends",friends);
  Set<Object> someSet=new ManagedSet<>();
  someSet.add("na${age}me");
  someSet.add(new RuntimeBeanReference("${ref}"));
  someSet.add(new TypedStringValue("${age}",Integer.class));
  pvs.add("someSet",someSet);
  Map<Object,Object> someMap=new ManagedMap<>();
  someMap.put(new TypedStringValue("key${age}"),new TypedStringValue("${age}"));
  someMap.put(new TypedStringValue("key${age}ref"),new RuntimeBeanReference("${ref}"));
  someMap.put("key1",new RuntimeBeanReference("${ref}"));
  someMap.put("key2","${age}name");
  MutablePropertyValues innerPvs=new MutablePropertyValues();
  innerPvs.add("country","${os.name}");
  RootBeanDefinition innerBd=new RootBeanDefinition(TestBean.class);
  innerBd.setPropertyValues(innerPvs);
  someMap.put("key3",innerBd);
  MutablePropertyValues innerPvs2=new MutablePropertyValues(innerPvs);
  someMap.put("${key4}",new BeanDefinitionHolder(new ChildBeanDefinition("tb1",innerPvs2),"child"));
  pvs.add("someMap",someMap);
  RootBeanDefinition bd=new RootBeanDefinition(TestBean.class,cas,pvs);
  factory.registerBeanDefinition("tb2",bd);
  PropertyPlaceholderConfigurer ppc=new PropertyPlaceholderConfigurer();
  Properties props=new Properties();
  props.setProperty("age","98");
  props.setProperty("var","${m}var");
  props.setProperty("ref","tb2");
  props.setProperty("m","my");
  props.setProperty("key4","mykey4");
  props.setProperty("parent","parent1");
  ppc.setProperties(props);
  ppc.postProcessBeanFactory(factory);
  TestBean tb1=(TestBean)factory.getBean("tb1");
  TestBean tb2=(TestBean)factory.getBean("tb2");
  assertEquals(98,tb1.getAge());
  assertEquals(98,tb2.getAge());
  assertEquals("namemyvarmyvar${",tb1.getName());
  assertEquals("myvarname98",tb2.getName());
  assertEquals(tb2,tb1.getSpouse());
  assertEquals(1,tb1.getSomeMap().size());
  assertEquals("myValue",tb1.getSomeMap().get("myKey"));
  assertEquals(2,tb2.getStringArray().length);
  assertEquals(System.getProperty("os.name"),tb2.getStringArray()[0]);
  assertEquals("98",tb2.getStringArray()[1]);
  assertEquals(2,tb2.getFriends().size());
  assertEquals("na98me",tb2.getFriends().iterator().next());
  assertEquals(tb2,tb2.getFriends().toArray()[1]);
  assertEquals(3,tb2.getSomeSet().size());
  assertTrue(tb2.getSomeSet().contains("na98me"));
  assertTrue(tb2.getSomeSet().contains(tb2));
  assertTrue(tb2.getSomeSet().contains(new Integer(98)));
  assertEquals(6,tb2.getSomeMap().size());
  assertEquals("98",tb2.getSomeMap().get("key98"));
  assertEquals(tb2,tb2.getSomeMap().get("key98ref"));
  assertEquals(tb2,tb2.getSomeMap().get("key1"));
  assertEquals("98name",tb2.getSomeMap().get("key2"));
  TestBean inner1=(TestBean)tb2.getSomeMap().get("key3");
  TestBean inner2=(TestBean)tb2.getSomeMap().get("mykey4");
  assertEquals(0,inner1.getAge());
  assertEquals(null,inner1.getName());
  assertEquals(System.getProperty("os.name"),inner1.getCountry());
  assertEquals(98,inner2.getAge());
  assertEquals("namemyvarmyvar${",inner2.getName());
  assertEquals(System.getProperty("os.name"),inner2.getCountry());
}
