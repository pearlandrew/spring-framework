{
  ServerHttpRequest httpRequest=new ServletServerHttpRequest(request);
  ServerHttpResponse httpResponse=new ServletServerHttpResponse(response);
  try {
    WebSocketHandler webSocketHandler=this.handlerProvider.getHandler();
    this.handshakeHandler.doHandshake(httpRequest,httpResponse,webSocketHandler);
  }
 catch (  Exception e) {
    throw new NestedServletException("HandshakeHandler failure",e);
  }
 finally {
    httpResponse.flush();
  }
}
