{
  given(session.isOpen()).willReturn(true);
  given(session.getFlushMode()).willReturn(FlushMode.AUTO);
  TransactionSynchronizationManager.bindResource(sessionFactory,new SessionHolder(session));
  HibernateInterceptor interceptor=new HibernateInterceptor();
  interceptor.setSessionFactory(sessionFactory);
  interceptor.setFlushMode(HibernateInterceptor.FLUSH_COMMIT);
  try {
    interceptor.invoke(invocation);
  }
 catch (  Throwable t) {
    fail("Should not have thrown Throwable: " + t.getMessage());
  }
 finally {
    TransactionSynchronizationManager.unbindResource(sessionFactory);
  }
  InOrder ordered=inOrder(session);
  ordered.verify(session).setFlushMode(FlushMode.COMMIT);
  ordered.verify(session).setFlushMode(FlushMode.AUTO);
  verify(session,never()).flush();
}
