{
  OpenEntityManagerInViewInterceptor interceptor=new OpenEntityManagerInViewInterceptor();
  interceptor.setEntityManagerFactory(factory);
  MockServletContext sc=new MockServletContext();
  MockHttpServletRequest request=new MockHttpServletRequest(sc);
  interceptor.preHandle(new ServletWebRequest(request));
  assertTrue(TransactionSynchronizationManager.hasResource(factory));
  interceptor.preHandle(new ServletWebRequest(request));
  interceptor.preHandle(new ServletWebRequest(request));
  interceptor.postHandle(new ServletWebRequest(request),null);
  interceptor.afterCompletion(new ServletWebRequest(request),null);
  interceptor.postHandle(new ServletWebRequest(request),null);
  interceptor.afterCompletion(new ServletWebRequest(request),null);
  interceptor.preHandle(new ServletWebRequest(request));
  interceptor.postHandle(new ServletWebRequest(request),null);
  interceptor.afterCompletion(new ServletWebRequest(request),null);
  interceptor.postHandle(new ServletWebRequest(request),null);
  assertTrue(TransactionSynchronizationManager.hasResource(factory));
  given(manager.isOpen()).willReturn(true);
  interceptor.afterCompletion(new ServletWebRequest(request),null);
  assertFalse(TransactionSynchronizationManager.hasResource(factory));
  verify(manager).close();
}
