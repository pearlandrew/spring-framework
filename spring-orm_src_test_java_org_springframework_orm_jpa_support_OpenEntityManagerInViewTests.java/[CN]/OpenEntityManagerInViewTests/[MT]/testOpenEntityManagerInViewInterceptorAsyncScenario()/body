{
  OpenEntityManagerInViewInterceptor interceptor=new OpenEntityManagerInViewInterceptor();
  interceptor.setEntityManagerFactory(factory);
  MockServletContext sc=new MockServletContext();
  MockHttpServletRequest request=new MockHttpServletRequest(sc);
  ServletWebRequest webRequest=new ServletWebRequest(request);
  replay(manager,factory);
  interceptor.preHandle(webRequest);
  assertTrue(TransactionSynchronizationManager.hasResource(factory));
  verify(manager,factory);
  AsyncWebRequest asyncWebRequest=createStrictMock(AsyncWebRequest.class);
  asyncWebRequest.addCompletionHandler((Runnable)anyObject());
  asyncWebRequest.addTimeoutHandler((Runnable)anyObject());
  asyncWebRequest.addCompletionHandler((Runnable)anyObject());
  asyncWebRequest.startAsync();
  replay(asyncWebRequest);
  WebAsyncManager asyncManager=WebAsyncUtils.getAsyncManager(webRequest);
  asyncManager.setTaskExecutor(new SyncTaskExecutor());
  asyncManager.setAsyncWebRequest(asyncWebRequest);
  asyncManager.startCallableProcessing(new Callable<String>(){
    public String call() throws Exception {
      return "anything";
    }
  }
);
  verify(asyncWebRequest);
  interceptor.afterConcurrentHandlingStarted(webRequest);
  assertFalse(TransactionSynchronizationManager.hasResource(factory));
  reset(manager,factory);
  replay(manager,factory);
  interceptor.preHandle(webRequest);
  assertTrue(TransactionSynchronizationManager.hasResource(factory));
  verify(manager,factory);
  reset(manager,factory);
  replay(manager,factory);
  asyncManager.clearConcurrentResult();
  interceptor.preHandle(new ServletWebRequest(request));
  interceptor.preHandle(new ServletWebRequest(request));
  interceptor.postHandle(new ServletWebRequest(request),null);
  interceptor.afterCompletion(new ServletWebRequest(request),null);
  interceptor.postHandle(new ServletWebRequest(request),null);
  interceptor.afterCompletion(new ServletWebRequest(request),null);
  interceptor.preHandle(new ServletWebRequest(request));
  interceptor.postHandle(new ServletWebRequest(request),null);
  interceptor.afterCompletion(new ServletWebRequest(request),null);
  verify(manager,factory);
  reset(manager,factory);
  replay(manager,factory);
  interceptor.postHandle(webRequest,null);
  assertTrue(TransactionSynchronizationManager.hasResource(factory));
  verify(manager,factory);
  reset(manager,factory);
  expect(manager.isOpen()).andReturn(true);
  manager.close();
  replay(manager,factory);
  interceptor.afterCompletion(webRequest,null);
  assertFalse(TransactionSynchronizationManager.hasResource(factory));
  verify(manager,factory);
}
