{
  final SessionFactory sf=mock(SessionFactory.class);
  final Session session=mock(Session.class);
  OpenSessionInterceptor interceptor=new OpenSessionInterceptor();
  interceptor.setSessionFactory(sf);
  Runnable tb=new Runnable(){
    @Override public void run(){
      assertTrue(TransactionSynchronizationManager.hasResource(sf));
      assertEquals(session,SessionFactoryUtils.getSession(sf,false));
    }
  }
;
  ProxyFactory pf=new ProxyFactory(tb);
  pf.addAdvice(interceptor);
  Runnable tbProxy=(Runnable)pf.getProxy();
  given(sf.openSession()).willReturn(session);
  given(session.isOpen()).willReturn(true);
  tbProxy.run();
  verify(session).setFlushMode(FlushMode.MANUAL);
  verify(session).close();
}
