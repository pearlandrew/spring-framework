{
  final SessionFactoryImplementor sf=mock(SessionFactoryImplementor.class);
  Session session=mock(Session.class);
  TransactionManager tm=mock(TransactionManager.class);
  given(tm.getTransaction()).willReturn(null);
  given(tm.getTransaction()).willReturn(null);
  OpenSessionInViewInterceptor interceptor=new OpenSessionInViewInterceptor();
  interceptor.setSessionFactory(sf);
  given(sf.openSession()).willReturn(session);
  given(sf.getTransactionManager()).willReturn(tm);
  given(sf.getTransactionManager()).willReturn(tm);
  given(session.isOpen()).willReturn(true);
  interceptor.preHandle(this.webRequest);
  assertTrue(TransactionSynchronizationManager.hasResource(sf));
  interceptor.preHandle(this.webRequest);
  assertEquals(session,SessionFactoryUtils.getSession(sf,false));
  interceptor.preHandle(this.webRequest);
  interceptor.postHandle(this.webRequest,null);
  interceptor.afterCompletion(this.webRequest,null);
  interceptor.postHandle(this.webRequest,null);
  interceptor.afterCompletion(this.webRequest,null);
  interceptor.preHandle(this.webRequest);
  interceptor.postHandle(this.webRequest,null);
  interceptor.afterCompletion(this.webRequest,null);
  interceptor.postHandle(this.webRequest,null);
  assertTrue(TransactionSynchronizationManager.hasResource(sf));
  interceptor.afterCompletion(this.webRequest,null);
  assertFalse(TransactionSynchronizationManager.hasResource(sf));
  verify(session).setFlushMode(FlushMode.MANUAL);
  verify(session).close();
}
