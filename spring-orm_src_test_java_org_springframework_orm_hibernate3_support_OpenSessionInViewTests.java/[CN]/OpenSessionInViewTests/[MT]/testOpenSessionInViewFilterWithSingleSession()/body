{
  final SessionFactory sf=mock(SessionFactory.class);
  Session session=mock(Session.class);
  given(sf.openSession()).willReturn(session);
  given(session.getSessionFactory()).willReturn(sf);
  given(session.close()).willReturn(null);
  final SessionFactory sf2=mock(SessionFactory.class);
  Session session2=mock(Session.class);
  given(sf2.openSession()).willReturn(session2);
  given(session2.getSessionFactory()).willReturn(sf2);
  given(session2.close()).willReturn(null);
  StaticWebApplicationContext wac=new StaticWebApplicationContext();
  wac.setServletContext(sc);
  wac.getDefaultListableBeanFactory().registerSingleton("sessionFactory",sf);
  wac.getDefaultListableBeanFactory().registerSingleton("mySessionFactory",sf2);
  wac.refresh();
  sc.setAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE,wac);
  MockFilterConfig filterConfig=new MockFilterConfig(wac.getServletContext(),"filter");
  MockFilterConfig filterConfig2=new MockFilterConfig(wac.getServletContext(),"filter2");
  filterConfig2.addInitParameter("sessionFactoryBeanName","mySessionFactory");
  filterConfig2.addInitParameter("flushMode","AUTO");
  final OpenSessionInViewFilter filter=new OpenSessionInViewFilter();
  filter.init(filterConfig);
  final OpenSessionInViewFilter filter2=new OpenSessionInViewFilter();
  filter2.init(filterConfig2);
  final FilterChain filterChain=new FilterChain(){
    @Override public void doFilter(    ServletRequest servletRequest,    ServletResponse servletResponse){
      assertTrue(TransactionSynchronizationManager.hasResource(sf));
      servletRequest.setAttribute("invoked",Boolean.TRUE);
    }
  }
;
  final FilterChain filterChain2=new FilterChain(){
    @Override public void doFilter(    ServletRequest servletRequest,    ServletResponse servletResponse) throws IOException, ServletException {
      assertTrue(TransactionSynchronizationManager.hasResource(sf2));
      filter.doFilter(servletRequest,servletResponse,filterChain);
    }
  }
;
  FilterChain filterChain3=new PassThroughFilterChain(filter2,filterChain2);
  assertFalse(TransactionSynchronizationManager.hasResource(sf));
  assertFalse(TransactionSynchronizationManager.hasResource(sf2));
  filter2.doFilter(this.request,this.response,filterChain3);
  assertFalse(TransactionSynchronizationManager.hasResource(sf));
  assertFalse(TransactionSynchronizationManager.hasResource(sf2));
  assertNotNull(this.request.getAttribute("invoked"));
  verify(session).setFlushMode(FlushMode.MANUAL);
  verify(session2).setFlushMode(FlushMode.AUTO);
  wac.close();
}
