{
  Optional<Object> value=result.getReturnValue();
  if (!value.isPresent()) {
    return Mono.empty();
  }
  Publisher<?> publisher;
  ResolvableType elementType;
  ResolvableType returnType=result.getReturnValueType();
  if (this.conversionService.canConvert(returnType.getRawClass(),Publisher.class)) {
    publisher=this.conversionService.convert(value.get(),Publisher.class);
    elementType=returnType.getGeneric(0);
    if (Void.class.equals(elementType.getRawClass())) {
      return Mono.from((Publisher<Void>)publisher);
    }
  }
 else {
    publisher=Mono.just(value.get());
    elementType=returnType;
  }
  List<MediaType> compatibleMediaTypes=getCompatibleMediaTypes(exchange.getRequest(),elementType);
  if (compatibleMediaTypes.isEmpty()) {
    return Mono.error(new NotAcceptableStatusException(getProducibleMediaTypes(elementType)));
  }
  Optional<MediaType> selectedMediaType=selectBestMediaType(compatibleMediaTypes);
  if (selectedMediaType.isPresent()) {
    HttpMessageConverter<?> converter=resolveEncoder(elementType,selectedMediaType.get());
    if (converter != null) {
      ServerHttpResponse response=exchange.getResponse();
      return converter.write((Publisher)publisher,elementType,selectedMediaType.get(),response);
    }
  }
  return Mono.error(new NotAcceptableStatusException(this.allMediaTypes));
}
