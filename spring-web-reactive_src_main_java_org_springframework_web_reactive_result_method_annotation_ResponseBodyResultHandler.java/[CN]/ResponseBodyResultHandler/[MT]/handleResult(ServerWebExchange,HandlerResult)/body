{
  Optional<Object> value=result.getReturnValue();
  if (!value.isPresent()) {
    return Mono.empty();
  }
  Publisher<?> publisher;
  ResolvableType elementType;
  ResolvableType returnType=result.getReturnValueType();
  if (this.conversionService.canConvert(returnType.getRawClass(),Publisher.class)) {
    publisher=this.conversionService.convert(value.get(),Publisher.class);
    elementType=returnType.getGeneric(0);
    if (Void.class.equals(elementType.getRawClass())) {
      return Mono.from((Publisher<Void>)publisher);
    }
  }
 else {
    publisher=Mono.just(value.get());
    elementType=returnType;
  }
  List<MediaType> requestedMediaTypes=getAcceptableMediaTypes(exchange.getRequest());
  List<MediaType> producibleMediaTypes=getProducibleMediaTypes(elementType);
  if (producibleMediaTypes.isEmpty()) {
    producibleMediaTypes.add(MediaType.ALL);
  }
  Set<MediaType> compatibleMediaTypes=new LinkedHashSet<>();
  for (  MediaType requestedType : requestedMediaTypes) {
    for (    MediaType producibleType : producibleMediaTypes) {
      if (requestedType.isCompatibleWith(producibleType)) {
        compatibleMediaTypes.add(getMostSpecificMediaType(requestedType,producibleType));
      }
    }
  }
  if (compatibleMediaTypes.isEmpty()) {
    return Mono.error(new NotAcceptableStatusException(producibleMediaTypes));
  }
  List<MediaType> mediaTypes=new ArrayList<>(compatibleMediaTypes);
  MediaType.sortBySpecificityAndQuality(mediaTypes);
  MediaType selectedMediaType=null;
  for (  MediaType mediaType : mediaTypes) {
    if (mediaType.isConcrete()) {
      selectedMediaType=mediaType;
      break;
    }
 else     if (mediaType.equals(MediaType.ALL) || mediaType.equals(MEDIA_TYPE_APPLICATION)) {
      selectedMediaType=MediaType.APPLICATION_OCTET_STREAM;
      break;
    }
  }
  if (selectedMediaType != null) {
    Encoder<?> encoder=resolveEncoder(elementType,selectedMediaType);
    if (encoder != null) {
      ServerHttpResponse response=exchange.getResponse();
      response.getHeaders().setContentType(selectedMediaType);
      DataBufferAllocator allocator=response.allocator();
      return response.setBody(encoder.encode((Publisher)publisher,allocator,elementType,selectedMediaType));
    }
  }
  return Mono.error(new NotAcceptableStatusException(this.allMediaTypes));
}
