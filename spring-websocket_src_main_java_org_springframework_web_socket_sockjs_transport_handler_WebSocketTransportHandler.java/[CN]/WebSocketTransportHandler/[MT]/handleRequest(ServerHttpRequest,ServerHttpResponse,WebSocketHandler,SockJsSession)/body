{
  WebSocketServerSockJsSession sockJsSession=(WebSocketServerSockJsSession)wsSession;
  try {
    wsHandler=new SockJsWebSocketHandler(getServiceConfig(),wsHandler,sockJsSession);
    this.handshakeHandler.doHandshake(request,response,wsHandler,Collections.<String,Object>emptyMap());
  }
 catch (  Throwable ex) {
    sockJsSession.tryCloseWithSockJsTransportError(ex,CloseStatus.SERVER_ERROR);
    throw new SockJsTransportFailureException("WebSocket handshake failure",wsSession.getId(),ex);
  }
}
