{
  WebSocketServerSockJsSession sockJsSession=(WebSocketServerSockJsSession)wsSession;
  try {
    wsHandler=new SockJsWebSocketHandler(getSockJsServiceConfig(),wsHandler,sockJsSession);
    this.handshakeHandler.doHandshake(request,response,wsHandler,Collections.<String,Object>emptyMap());
  }
 catch (  Throwable t) {
    sockJsSession.tryCloseWithSockJsTransportError(t,CloseStatus.SERVER_ERROR);
    throw new SockJsTransportFailureException("WebSocket handshake failure",wsSession.getId(),t);
  }
}
