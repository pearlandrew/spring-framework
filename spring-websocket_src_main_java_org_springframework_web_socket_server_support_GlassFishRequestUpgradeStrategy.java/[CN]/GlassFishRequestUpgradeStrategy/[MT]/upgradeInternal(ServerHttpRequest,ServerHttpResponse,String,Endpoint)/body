{
  Assert.isTrue(request instanceof ServletServerHttpRequest);
  HttpServletRequest servletRequest=((ServletServerHttpRequest)request).getServletRequest();
  Assert.isTrue(response instanceof ServletServerHttpResponse);
  HttpServletResponse servletResponse=((ServletServerHttpResponse)response).getServletResponse();
  servletResponse=new AlreadyUpgradedResponseWrapper(servletResponse);
  WebSocketApplication wsApp=createTyrusEndpoint(servletRequest,endpoint,selectedProtocol);
  WebSocketEngine engine=WebSocketEngine.getEngine();
  try {
    engine.register(wsApp);
  }
 catch (  DeploymentException ex) {
    throw new HandshakeFailureException("Failed to deploy endpoint in GlassFish",ex);
  }
  try {
    if (!performUpgrade(servletRequest,servletResponse,request.getHeaders(),wsApp)) {
      throw new HandshakeFailureException("Failed to upgrade HttpServletRequest");
    }
  }
  finally {
    engine.unregister(wsApp);
  }
}
