{
  Assert.isTrue(request instanceof ServletServerHttpRequest);
  HttpServletRequest servletRequest=((ServletServerHttpRequest)request).getServletRequest();
  Assert.isTrue(response instanceof ServletServerHttpResponse);
  HttpServletResponse servletResponse=((ServletServerHttpResponse)response).getServletResponse();
  WebSocketApplication webSocketApplication=createTyrusEndpoint(servletRequest,endpoint,selectedProtocol);
  WebSocketEngine webSocketEngine=WebSocketEngine.getEngine();
  try {
    webSocketEngine.register(webSocketApplication);
  }
 catch (  DeploymentException ex) {
    throw new HandshakeFailureException("Failed to deploy endpoint in GlassFish",ex);
  }
  try {
    performUpgrade(servletRequest,servletResponse,request.getHeaders(),webSocketApplication);
  }
  finally {
    webSocketEngine.unregister(webSocketApplication);
  }
}
