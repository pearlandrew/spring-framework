{
  if (this.sourceMap == null) {
    throw new IllegalArgumentException("'sourceMap' is required");
  }
  Map result=null;
  if (this.targetMapClass != null) {
    result=(Map)BeanUtils.instantiateClass(this.targetMapClass);
  }
 else {
    result=new LinkedHashMap(this.sourceMap.size());
  }
  Class keyType=null;
  Class valueType=null;
  if (this.targetMapClass != null) {
    keyType=GenericCollectionTypeResolver.getMapKeyType(this.targetMapClass);
    valueType=GenericCollectionTypeResolver.getMapValueType(this.targetMapClass);
  }
  if (keyType != null || valueType != null) {
    TypeConverter converter=getBeanTypeConverter();
    for (Iterator it=this.sourceMap.entrySet().iterator(); it.hasNext(); ) {
      Map.Entry entry=(Map.Entry)it.next();
      Object convertedKey=converter.convertIfNecessary(entry.getKey(),keyType);
      Object convertedValue=converter.convertIfNecessary(entry.getValue(),valueType);
      result.put(convertedKey,convertedValue);
    }
  }
 else {
    result.putAll(this.sourceMap);
  }
  return result;
}
