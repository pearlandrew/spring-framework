{
  Class<?> returnValueClass=returnValue.getClass();
  List<MediaType> acceptableMediaTypes=getAcceptableMediaTypes(inputMessage);
  List<MediaType> producibleMediaTypes=getProducibleMediaTypes(inputMessage.getServletRequest(),returnValueClass);
  Set<MediaType> compatibleMediaTypes=new LinkedHashSet<MediaType>();
  for (  MediaType a : acceptableMediaTypes) {
    for (    MediaType p : producibleMediaTypes) {
      if (a.isCompatibleWith(p)) {
        compatibleMediaTypes.add(getMostSpecificMediaType(a,p));
      }
    }
  }
  if (compatibleMediaTypes.isEmpty()) {
    throw new HttpMediaTypeNotAcceptableException(allSupportedMediaTypes);
  }
  List<MediaType> mediaTypes=new ArrayList<MediaType>(compatibleMediaTypes);
  MediaType.sortBySpecificity(mediaTypes);
  MediaType selectedMediaType=null;
  for (  MediaType mediaType : mediaTypes) {
    if (mediaType.isConcrete()) {
      selectedMediaType=mediaType;
      break;
    }
 else     if (mediaType.equals(MediaType.ALL) || mediaType.equals(MEDIA_TYPE_APPLICATION)) {
      selectedMediaType=MediaType.APPLICATION_OCTET_STREAM;
      break;
    }
  }
  if (selectedMediaType != null) {
    for (    HttpMessageConverter<?> messageConverter : messageConverters) {
      if (messageConverter.canWrite(returnValueClass,selectedMediaType)) {
        ((HttpMessageConverter<T>)messageConverter).write(returnValue,selectedMediaType,outputMessage);
        if (logger.isDebugEnabled()) {
          logger.debug("Written [" + returnValue + "] as \""+ selectedMediaType+ "\" using ["+ messageConverter+ "]");
        }
        return;
      }
    }
  }
  throw new HttpMediaTypeNotAcceptableException(allSupportedMediaTypes);
}
