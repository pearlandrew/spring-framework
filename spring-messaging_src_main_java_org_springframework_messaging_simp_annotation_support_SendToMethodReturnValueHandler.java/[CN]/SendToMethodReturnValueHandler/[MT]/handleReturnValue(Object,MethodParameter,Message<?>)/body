{
  if (returnValue == null) {
    return;
  }
  MessageHeaders headers=message.getHeaders();
  String sessionId=SimpMessageHeaderAccessor.getSessionId(headers);
  SendToUser sendToUser=returnType.getMethodAnnotation(SendToUser.class);
  if (sendToUser != null) {
    boolean broadcast=sendToUser.broadcast();
    String user=getUserName(message,headers);
    if (user == null) {
      if (sessionId == null) {
        throw new MissingSessionUserException(message);
      }
      user=sessionId;
      broadcast=false;
    }
    String[] destinations=getTargetDestinations(sendToUser,message,this.defaultUserDestinationPrefix);
    for (    String destination : destinations) {
      if (broadcast) {
        this.messagingTemplate.convertAndSendToUser(user,destination,returnValue);
      }
 else {
        this.messagingTemplate.convertAndSendToUser(user,destination,returnValue,createHeaders(sessionId));
      }
    }
  }
 else {
    SendTo sendTo=returnType.getMethodAnnotation(SendTo.class);
    String[] destinations=getTargetDestinations(sendTo,message,this.defaultDestinationPrefix);
    for (    String destination : destinations) {
      this.messagingTemplate.convertAndSend(destination,returnValue,createHeaders(sessionId));
    }
  }
}
