{
  if (returnValue == null) {
    return;
  }
  MessageHeaders headers=message.getHeaders();
  String sessionId=SimpMessageHeaderAccessor.getSessionId(headers);
  MessagePostProcessor postProcessor=new SessionHeaderPostProcessor(sessionId);
  SendToUser sendToUser=returnType.getMethodAnnotation(SendToUser.class);
  if (sendToUser != null) {
    Principal principal=SimpMessageHeaderAccessor.getUser(headers);
    if (principal == null) {
      throw new MissingSessionUserException(message);
    }
    String userName=principal.getName();
    if (principal instanceof DestinationUserNameProvider) {
      userName=((DestinationUserNameProvider)principal).getDestinationUserName();
    }
    String[] destinations=getTargetDestinations(sendToUser,message,this.defaultUserDestinationPrefix);
    for (    String destination : destinations) {
      this.messagingTemplate.convertAndSendToUser(userName,destination,returnValue,postProcessor);
    }
    return;
  }
 else {
    SendTo sendTo=returnType.getMethodAnnotation(SendTo.class);
    String[] destinations=getTargetDestinations(sendTo,message,this.defaultDestinationPrefix);
    for (    String destination : destinations) {
      this.messagingTemplate.convertAndSend(destination,returnValue,postProcessor);
    }
  }
}
