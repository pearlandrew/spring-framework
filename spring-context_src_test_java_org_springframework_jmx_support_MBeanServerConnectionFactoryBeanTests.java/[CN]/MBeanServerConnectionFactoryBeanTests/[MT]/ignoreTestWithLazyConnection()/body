{
  MBeanServerConnectionFactoryBean bean=new MBeanServerConnectionFactoryBean();
  bean.setServiceUrl(SERVICE_URL);
  bean.setConnectOnStartup(false);
  bean.afterPropertiesSet();
  MBeanServerConnection connection=(MBeanServerConnection)bean.getObject();
  assertTrue(AopUtils.isAopProxy(connection));
  JMXConnectorServer connector=null;
  try {
    connector=getConnectorServer();
    connector.start();
    assertEquals("Incorrect MBean count",getServer().getMBeanCount(),connection.getMBeanCount());
  }
  finally {
    bean.destroy();
    if (connector != null) {
      connector.stop();
    }
  }
}
