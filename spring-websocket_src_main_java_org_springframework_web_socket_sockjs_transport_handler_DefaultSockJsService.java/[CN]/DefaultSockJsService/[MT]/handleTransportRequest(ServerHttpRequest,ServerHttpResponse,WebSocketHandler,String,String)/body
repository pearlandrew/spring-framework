{
  TransportType transportType=TransportType.fromValue(transport);
  if (transportType == null) {
    logger.debug("Unknown transport type: " + transportType);
    response.setStatusCode(HttpStatus.NOT_FOUND);
    return;
  }
  TransportHandler transportHandler=this.transportHandlers.get(transportType);
  if (transportHandler == null) {
    logger.debug("Transport handler not found");
    response.setStatusCode(HttpStatus.NOT_FOUND);
    return;
  }
  HttpMethod supportedMethod=transportType.getHttpMethod();
  if (!supportedMethod.equals(request.getMethod())) {
    if (HttpMethod.OPTIONS.equals(request.getMethod()) && transportType.supportsCors()) {
      response.setStatusCode(HttpStatus.NO_CONTENT);
      addCorsHeaders(request,response,HttpMethod.OPTIONS,supportedMethod);
      addCacheHeaders(response);
    }
 else {
      List<HttpMethod> supportedMethods=Arrays.asList(supportedMethod);
      if (transportType.supportsCors()) {
        supportedMethods.add(HttpMethod.OPTIONS);
      }
      sendMethodNotAllowed(response,supportedMethods);
    }
    return;
  }
  HandshakeInterceptorChain chain=new HandshakeInterceptorChain(this.interceptors,wsHandler);
  SockJsException failure=null;
  try {
    WebSocketSession session=this.sessions.get(sessionId);
    if (session == null) {
      if (transportHandler instanceof SockJsSessionFactory) {
        Map<String,Object> attributes=new HashMap<String,Object>();
        if (!chain.applyBeforeHandshake(request,response,attributes)) {
          return;
        }
        SockJsSessionFactory sessionFactory=(SockJsSessionFactory)transportHandler;
        session=createSockJsSession(sessionId,sessionFactory,wsHandler,attributes,request,response);
      }
 else {
        response.setStatusCode(HttpStatus.NOT_FOUND);
        logger.warn("Session not found");
        return;
      }
    }
    if (transportType.sendsNoCacheInstruction()) {
      addNoCacheHeaders(response);
    }
    if (transportType.supportsCors()) {
      addCorsHeaders(request,response);
    }
    transportHandler.handleRequest(request,response,wsHandler,session);
    chain.applyAfterHandshake(request,response,null);
  }
 catch (  SockJsException ex) {
    failure=ex;
  }
catch (  Throwable t) {
    failure=new SockJsException("Uncaught failure for request " + request.getURI(),sessionId,t);
  }
 finally {
    if (failure != null) {
      chain.applyAfterHandshake(request,response,failure);
      throw failure;
    }
  }
}
