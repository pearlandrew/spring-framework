{
  AnnotationConfigApplicationContext cxt=new AnnotationConfigApplicationContext();
  cxt.register(TestWebSocketMessageBrokerConfiguration.class,SimpleBrokerConfigurer.class);
  cxt.refresh();
  StompHeaderAccessor headers=StompHeaderAccessor.create(StompCommand.SEND);
  headers.setDestination("/app/foo");
  Message<byte[]> message=MessageBuilder.withPayloadAndHeaders(new byte[0],headers).build();
  byte[] bytes=new StompMessageConverter().fromMessage(message);
  TestWebSocketSession session=new TestWebSocketSession();
  session.setAcceptedProtocol("v12.stomp");
  SubProtocolWebSocketHandler wsHandler=cxt.getBean(SubProtocolWebSocketHandler.class);
  wsHandler.handleMessage(session,new TextMessage(new String(bytes)));
  assertTrue(cxt.getBean(TestController.class).foo);
  cxt.close();
}
