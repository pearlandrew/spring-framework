{
  Object value=result.getValue();
  if (value == null) {
    return Publishers.empty();
  }
  ResolvableType returnType=result.getType();
  List<MediaType> requestedMediaTypes=getAcceptableMediaTypes(request);
  List<MediaType> producibleMediaTypes=getProducibleMediaTypes(returnType);
  if (producibleMediaTypes.isEmpty()) {
    Publishers.error(new IllegalArgumentException("No encoder found for return value of type: " + returnType));
  }
  Set<MediaType> compatibleMediaTypes=new LinkedHashSet<>();
  for (  MediaType requestedType : requestedMediaTypes) {
    for (    MediaType producibleType : producibleMediaTypes) {
      if (requestedType.isCompatibleWith(producibleType)) {
        compatibleMediaTypes.add(getMostSpecificMediaType(requestedType,producibleType));
      }
    }
  }
  if (compatibleMediaTypes.isEmpty()) {
    return Publishers.error(new HttpMediaTypeNotAcceptableException(producibleMediaTypes));
  }
  List<MediaType> mediaTypes=new ArrayList<>(compatibleMediaTypes);
  MediaType.sortBySpecificityAndQuality(mediaTypes);
  MediaType selectedMediaType=null;
  for (  MediaType mediaType : mediaTypes) {
    if (mediaType.isConcrete()) {
      selectedMediaType=mediaType;
      break;
    }
 else     if (mediaType.equals(MediaType.ALL) || mediaType.equals(MEDIA_TYPE_APPLICATION)) {
      selectedMediaType=MediaType.APPLICATION_OCTET_STREAM;
      break;
    }
  }
  if (selectedMediaType != null) {
    Publisher<?> publisher;
    ResolvableType elementType;
    if (this.conversionService.canConvert(returnType.getRawClass(),Publisher.class)) {
      publisher=this.conversionService.convert(value,Publisher.class);
      elementType=returnType.getGeneric(0);
    }
 else {
      publisher=Publishers.just(value);
      elementType=returnType;
    }
    Encoder<?> encoder=resolveEncoder(elementType,selectedMediaType);
    if (encoder != null) {
      response.getHeaders().setContentType(selectedMediaType);
      return response.setBody(encoder.encode((Publisher)publisher,elementType,selectedMediaType));
    }
  }
  return Publishers.error(new HttpMediaTypeNotAcceptableException(this.allSupportedMediaTypes));
}
