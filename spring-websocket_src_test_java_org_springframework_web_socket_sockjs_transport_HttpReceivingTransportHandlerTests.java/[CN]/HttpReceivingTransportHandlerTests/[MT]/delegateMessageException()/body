{
  this.servletRequest.setContent("[\"x\"]".getBytes("UTF-8"));
  WebSocketHandler webSocketHandler=mock(WebSocketHandler.class);
  TestSockJsSession session=new TestSockJsSession("1",new StubSockJsConfig(),webSocketHandler);
  session.delegateConnectionEstablished();
  doThrow(new Exception()).when(webSocketHandler).handleMessage(session,new TextMessage("x"));
  try {
    new XhrTransportHandler().handleRequest(this.request,this.response,webSocketHandler,session);
    fail("Expected exception");
  }
 catch (  TransportErrorException ex) {
    assertEquals(CloseStatus.SERVER_ERROR,session.getStatus());
  }
}
