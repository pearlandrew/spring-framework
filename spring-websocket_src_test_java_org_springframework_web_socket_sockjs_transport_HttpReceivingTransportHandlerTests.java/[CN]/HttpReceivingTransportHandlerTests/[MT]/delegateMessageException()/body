{
  StubSockJsConfig sockJsConfig=new StubSockJsConfig();
  this.servletRequest.setContent("[\"x\"]".getBytes("UTF-8"));
  WebSocketHandler webSocketHandler=mock(WebSocketHandler.class);
  TestSockJsSession session=new TestSockJsSession("1",sockJsConfig,webSocketHandler);
  session.delegateConnectionEstablished();
  doThrow(new Exception()).when(webSocketHandler).handleMessage(session,new TextMessage("x"));
  try {
    XhrTransportHandler transportHandler=new XhrTransportHandler();
    transportHandler.setSockJsConfiguration(sockJsConfig);
    transportHandler.handleRequest(this.request,this.response,webSocketHandler,session);
    fail("Expected exception");
  }
 catch (  TransportErrorException ex) {
    assertEquals(CloseStatus.SERVER_ERROR,session.getStatus());
  }
}
