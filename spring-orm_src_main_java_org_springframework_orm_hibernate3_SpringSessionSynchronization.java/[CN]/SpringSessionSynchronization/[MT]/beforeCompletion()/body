{
  if (this.jtaTransaction != null) {
    Session session=this.sessionHolder.removeSession(this.jtaTransaction);
    if (session != null) {
      if (this.sessionHolder.isEmpty()) {
        TransactionSynchronizationManager.unbindResourceIfPossible(this.sessionFactory);
        this.holderActive=false;
      }
      if (session != this.sessionHolder.getSession()) {
        SessionFactoryUtils.closeSessionOrRegisterDeferredClose(session,this.sessionFactory);
      }
 else {
        if (this.sessionHolder.getPreviousFlushMode() != null) {
          session.setFlushMode(this.sessionHolder.getPreviousFlushMode());
        }
        session.disconnect();
      }
      return;
    }
  }
  if (this.newSession) {
    TransactionSynchronizationManager.unbindResource(this.sessionFactory);
    this.holderActive=false;
    if (this.hibernateTransactionCompletion) {
      SessionFactoryUtils.closeSessionOrRegisterDeferredClose(this.sessionHolder.getSession(),this.sessionFactory);
    }
  }
 else {
    Session session=this.sessionHolder.getSession();
    if (this.sessionHolder.getPreviousFlushMode() != null) {
      session.setFlushMode(this.sessionHolder.getPreviousFlushMode());
    }
    if (this.hibernateTransactionCompletion) {
      session.disconnect();
    }
  }
}
