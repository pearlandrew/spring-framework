{
  try {
    if (!this.hibernateTransactionCompletion || !this.newSession) {
      Session session=this.sessionHolder.getSession();
      try {
        if (session instanceof SessionImplementor) {
          ((SessionImplementor)session).afterTransactionCompletion(status == STATUS_COMMITTED,null);
        }
      }
  finally {
        if (this.newSession) {
          SessionFactoryUtils.closeSessionOrRegisterDeferredClose(session,this.sessionFactory);
        }
 else         if (!this.hibernateTransactionCompletion) {
          session.disconnect();
        }
      }
    }
    if (!this.newSession && status != STATUS_COMMITTED) {
      this.sessionHolder.getSession().clear();
    }
  }
  finally {
    if (this.sessionHolder.doesNotHoldNonDefaultSession()) {
      this.sessionHolder.setSynchronizedWithTransaction(false);
    }
  }
}
