{
  ClientHttpRequest request=factory.createRequest(this.httpMethod,this.url,this.httpHeaders);
  request.getHeaders().putAll(this.httpHeaders);
  if (this.contentPublisher != null) {
    ResolvableType requestBodyType=ResolvableType.forInstance(this.contentPublisher);
    MediaType mediaType=request.getHeaders().getContentType();
    Optional<Encoder<?>> messageEncoder=resolveEncoder(requestBodyType,mediaType);
    if (messageEncoder.isPresent()) {
      DataBufferAllocator allocator=request.allocator();
      request.setBody(messageEncoder.get().encode(this.contentPublisher,allocator,requestBodyType,mediaType));
    }
 else {
      throw new WebClientException("Can't write request body " + "of type '" + requestBodyType.toString() + "' for content-type '"+ mediaType.toString()+ "'");
    }
  }
  return request;
}
