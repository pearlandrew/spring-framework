{
  if (returnValue == null) {
    mavContainer.setRequestHandled(true);
    return;
  }
  HttpServletResponse response=webRequest.getNativeResponse(HttpServletResponse.class);
  ServerHttpResponse outputMessage=new ServletServerHttpResponse(response);
  if (ResponseEntity.class.isAssignableFrom(returnValue.getClass())) {
    ResponseEntity<?> responseEntity=(ResponseEntity<?>)returnValue;
    outputMessage.setStatusCode(responseEntity.getStatusCode());
    outputMessage.getHeaders().putAll(responseEntity.getHeaders());
    returnValue=responseEntity.getBody();
    if (returnValue == null) {
      mavContainer.setRequestHandled(true);
      return;
    }
  }
  ServletRequest request=webRequest.getNativeRequest(ServletRequest.class);
  ShallowEtagHeaderFilter.disableContentCaching(request);
  ResponseBodyEmitterAdapter adapter=getAdapterFor(returnValue.getClass());
  Assert.notNull(adapter);
  ResponseBodyEmitter emitter=adapter.adaptToEmitter(returnValue,outputMessage);
  emitter.extendResponse(outputMessage);
  outputMessage.getBody();
  outputMessage.flush();
  outputMessage=new StreamingServletServerHttpResponse(outputMessage);
  DeferredResult<?> deferredResult=new DeferredResult<Object>(emitter.getTimeout());
  WebAsyncUtils.getAsyncManager(webRequest).startDeferredResultProcessing(deferredResult,mavContainer);
  HttpMessageConvertingHandler handler=new HttpMessageConvertingHandler(outputMessage,deferredResult);
  emitter.initialize(handler);
}
