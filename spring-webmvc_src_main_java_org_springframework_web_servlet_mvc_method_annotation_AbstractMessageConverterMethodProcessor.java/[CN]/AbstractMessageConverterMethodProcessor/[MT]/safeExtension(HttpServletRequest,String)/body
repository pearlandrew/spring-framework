{
  if (!StringUtils.hasText(extension)) {
    return true;
  }
  extension=extension.toLowerCase(Locale.ENGLISH);
  if (this.safeExtensions.contains(extension)) {
    return true;
  }
  if (extension.equals("html")) {
    String name=HandlerMapping.BEST_MATCHING_PATTERN_ATTRIBUTE;
    String pattern=(String)request.getAttribute(name);
    if (pattern != null && pattern.endsWith(".html")) {
      return true;
    }
    name=HandlerMapping.PRODUCIBLE_MEDIA_TYPES_ATTRIBUTE;
    Set<MediaType> mediaTypes=(Set<MediaType>)request.getAttribute(name);
    if (!CollectionUtils.isEmpty(mediaTypes) && mediaTypes.contains(MediaType.TEXT_HTML)) {
      return true;
    }
  }
  return false;
}
