{
  Class<?> returnValueClass=getReturnValueType(returnValue,returnType);
  Type returnValueType=getGenericType(returnType);
  HttpServletRequest servletRequest=inputMessage.getServletRequest();
  List<MediaType> requestedMediaTypes=getAcceptableMediaTypes(servletRequest);
  List<MediaType> producibleMediaTypes=getProducibleMediaTypes(servletRequest,returnValueClass,returnValueType);
  if (returnValue != null && producibleMediaTypes.isEmpty()) {
    throw new IllegalArgumentException("No converter found for return value of type: " + returnValueClass);
  }
  Set<MediaType> compatibleMediaTypes=new LinkedHashSet<MediaType>();
  for (  MediaType requestedType : requestedMediaTypes) {
    for (    MediaType producibleType : producibleMediaTypes) {
      if (requestedType.isCompatibleWith(producibleType)) {
        compatibleMediaTypes.add(getMostSpecificMediaType(requestedType,producibleType));
      }
    }
  }
  if (compatibleMediaTypes.isEmpty()) {
    if (returnValue != null) {
      throw new HttpMediaTypeNotAcceptableException(producibleMediaTypes);
    }
    return;
  }
  List<MediaType> mediaTypes=new ArrayList<MediaType>(compatibleMediaTypes);
  MediaType.sortBySpecificityAndQuality(mediaTypes);
  MediaType selectedMediaType=null;
  for (  MediaType mediaType : mediaTypes) {
    if (mediaType.isConcrete()) {
      selectedMediaType=mediaType;
      break;
    }
 else     if (mediaType.equals(MediaType.ALL) || mediaType.equals(MEDIA_TYPE_APPLICATION)) {
      selectedMediaType=MediaType.APPLICATION_OCTET_STREAM;
      break;
    }
  }
  if (selectedMediaType != null) {
    selectedMediaType=selectedMediaType.removeQualityValue();
    for (    HttpMessageConverter<?> messageConverter : this.messageConverters) {
      if (messageConverter instanceof GenericHttpMessageConverter) {
        if (((GenericHttpMessageConverter<T>)messageConverter).canWrite(returnValueType,returnValueClass,selectedMediaType)) {
          returnValue=(T)getAdvice().beforeBodyWrite(returnValue,returnType,selectedMediaType,(Class<? extends HttpMessageConverter<?>>)messageConverter.getClass(),inputMessage,outputMessage);
          if (returnValue != null) {
            addContentDispositionHeader(inputMessage,outputMessage);
            ((GenericHttpMessageConverter<T>)messageConverter).write(returnValue,returnValueType,selectedMediaType,outputMessage);
            if (logger.isDebugEnabled()) {
              logger.debug("Written [" + returnValue + "] as \""+ selectedMediaType+ "\" using ["+ messageConverter+ "]");
            }
          }
          return;
        }
      }
 else       if (messageConverter.canWrite(returnValueClass,selectedMediaType)) {
        returnValue=(T)getAdvice().beforeBodyWrite(returnValue,returnType,selectedMediaType,(Class<? extends HttpMessageConverter<?>>)messageConverter.getClass(),inputMessage,outputMessage);
        if (returnValue != null) {
          addContentDispositionHeader(inputMessage,outputMessage);
          ((HttpMessageConverter<T>)messageConverter).write(returnValue,selectedMediaType,outputMessage);
          if (logger.isDebugEnabled()) {
            logger.debug("Written [" + returnValue + "] as \""+ selectedMediaType+ "\" using ["+ messageConverter+ "]");
          }
        }
        return;
      }
    }
  }
  if (returnValue != null) {
    throw new HttpMediaTypeNotAcceptableException(this.allSupportedMediaTypes);
  }
}
